<div class="address-container">
  <!-- שורת הכתובת הראשית -->
  <div class="address-search-row">
    <input
      class="address-input"
      [placeholder]="placeholder"
      [value]="searchValue"
      [disabled]="disabled"
      [required]="required"
      [matAutocomplete]="auto"
      (input)="onInput($event)"
      (focus)="onFocus()"
      dir="rtl"
    >

    <!-- Loading spinner -->
    <mat-spinner
      *ngIf="isLoading"
      diameter="20"
      class="loading-spinner">
    </mat-spinner>

    <!-- Toggle button for address details -->
    <button
      *ngIf="hasSelectedAddress"
      mat-icon-button
      class="toggle-details-btn"
      (click)="toggleAddressDetails()"
      [matTooltip]="showAddressDetails ? 'הסתר פרטי כתובת' : 'הצג פרטי כתובת'"
      type="button">
      <mat-icon>{{ showAddressDetails ? 'expand_less' : 'expand_more' }}</mat-icon>
    </button>

    <mat-icon *ngIf="!hasSelectedAddress" class="address-icon">location_on</mat-icon>
  </div>

  <!-- פרטי הכתובת המורחבים -->
  <div class="address-details-section" *ngIf="hasSelectedAddress && showAddressDetails" [@slideDown]>
    <div class="details-grid">
      <!-- שורה ראשונה: רחוב ומספר בית -->
      <div class="detail-row">
        <div class="detail-field">
          <label>רחוב</label>
          <input
            type="text"
            [(ngModel)]="addressDetails.street"
            (change)="onDetailChange()"
            placeholder="שם רחוב"
            dir="rtl"
          >
        </div>
        <div class="detail-field small">
          <label>מס׳</label>
          <input
            type="text"
            [(ngModel)]="addressDetails.houseNumber"
            (change)="onDetailChange()"
            placeholder="מספר"
            dir="rtl"
          >
        </div>
      </div>

      <!-- שורה שנייה: שכונה ועיר -->
      <div class="detail-row">
        <div class="detail-field">
          <label>שכונה</label>
          <input
            type="text"
            [(ngModel)]="addressDetails.neighborhood"
            (change)="onDetailChange()"
            placeholder="שכונה"
            dir="rtl"
          >
        </div>
        <div class="detail-field">
          <label>עיר</label>
          <input
            type="text"
            [(ngModel)]="addressDetails.city"
            (change)="onDetailChange()"
            placeholder="עיר"
            dir="rtl"
          >
        </div>
      </div>

      <!-- שורה שלישית: מחוז ומיקוד -->
      <div class="detail-row">
        <div class="detail-field">
          <label>מחוז</label>
          <input
            type="text"
            [(ngModel)]="addressDetails.state"
            (change)="onDetailChange()"
            placeholder="מחוז"
            dir="rtl"
          >
        </div>
        <div class="detail-field small">
          <label>מיקוד</label>
          <input
            type="text"
            [(ngModel)]="addressDetails.postcode"
            (change)="onDetailChange()"
            placeholder="מיקוד"
            dir="rtl"
          >
        </div>
      </div>

      <!-- שורה רביעית: מדינה -->
      <div class="detail-row">
        <div class="detail-field full-width">
          <label>מדינה (מתעדכן אוטומטית מגוגל)</label>
          <input readonly
            type="text"
            [value]="getCountryDisplayName()"
            placeholder="מדינה"
            dir="rtl"
            style="cursor: not-allowed; background-color: #f5f5f5;"
            title="שדה זה מתעדכן אוטומטית מגוגל ולא ניתן לעריכה ידנית"
          >
        </div>
      </div>

      <!-- שורה רביעית: שם המקום (אם יש) -->
      <div class="detail-row" *ngIf="addressDetails.placeName">
        <div class="detail-field full-width">
          <label>שם המקום</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input
              type="text"
              [(ngModel)]="addressDetails.placeName"
              (change)="onDetailChange()"
              placeholder="שם המקום"
              dir="rtl"
              style="flex: 1;"
            >
            <button
              mat-stroked-button
              type="button"
              (click)="clearAddress(true); $event.stopPropagation(); $event.preventDefault()"
              class="clear-address-btn"
              matTooltip="נקה כתובת"
              style="white-space: nowrap;">
              <mat-icon>clear</mat-icon>
              נקה כתובת
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Autocomplete dropdown -->
  <mat-autocomplete
    #auto="matAutocomplete"
    [displayWith]="displayFn"
    (optionSelected)="onSuggestionSelect($event.option.value)"
    dir="rtl">

    <mat-option
      *ngFor="let suggestion of suggestions"
      [value]="suggestion"
      class="address-option">

      <div class="suggestion-content">
        <!-- Main address line -->
        <div class="main-address">
          <!-- אינדיקטור חזותי להבחנה בין מקומות שמורים לחדשים -->
          <mat-icon
            class="location-icon"
            [class.saved-place]="suggestion.isFromDatabase"
            [matTooltip]="suggestion.isFromDatabase ? 'מקום שמור במערכת' : 'מקום חדש מגוגל'">
            {{ suggestion.isFromDatabase ? 'bookmark' : 'place' }}
          </mat-icon>
          <span class="address-text">{{ getDisplayAddress(suggestion) }}</span>
          <!-- סמן "שמור" למקומות מהמערכת -->
          <mat-icon
            *ngIf="suggestion.isFromDatabase"
            class="saved-indicator"
            matTooltip="נשמר במערכת">
            star
          </mat-icon>
        </div>

        <!-- Address details -->
        <div class="address-details" *ngIf="getAddressDetails(suggestion)">
          <span class="details-text">{{ getAddressDetails(suggestion) }}</span>
        </div>

        <!-- City and country -->
        <div class="city-country">
          <span class="city-country-text">{{ getCityAndCountry(suggestion) }}</span>
        </div>
      </div>
    </mat-option>

    <!-- No results option -->
    <mat-option *ngIf="!isLoading && suggestions.length === 0 && searchValue.length >= 3" disabled>
      <div class="no-results">
        <mat-icon>search_off</mat-icon>
        <span>לא נמצאו תוצאות</span>
      </div>
    </mat-option>
  </mat-autocomplete>
</div>
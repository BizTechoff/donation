<div class="address-container">
  <!-- שורת הכתובת הראשית -->
  <div class="address-search-row">
    <input
      class="address-input"
      [placeholder]="placeholder"
      [value]="searchValue"
      [disabled]="disabled"
      [required]="required"
      [matAutocomplete]="auto"
      (input)="onInput($event)"
      (focus)="onFocus()"
      dir="rtl"
    >

    <!-- Loading spinner -->
    <mat-spinner
      *ngIf="isLoading"
      diameter="20"
      class="loading-spinner">
    </mat-spinner>

    <!-- Toggle button for address details -->
    <button
      *ngIf="hasSelectedAddress"
      mat-icon-button
      class="toggle-details-btn"
      (click)="toggleAddressDetails()"
      [matTooltip]="showAddressDetails ? ((i18n.terms$ | async)?.hideAddressDetails || 'הסתר פרטי כתובת') : ((i18n.terms$ | async)?.showAddressDetails || 'הצג פרטי כתובת')"
      type="button">
      <mat-icon>{{ showAddressDetails ? 'expand_less' : 'expand_more' }}</mat-icon>
    </button>

    <mat-icon *ngIf="!hasSelectedAddress" class="address-icon">location_on</mat-icon>
  </div>

  <!-- פרטי הכתובת המורחבים -->
  <div class="address-details-section" *ngIf="hasSelectedAddress && showAddressDetails && place" [@slideDown]>
    <div class="details-grid">
      <!-- שורה ראשונה: רחוב ומספר בית -->
      <div class="detail-row">
        <div class="detail-field">
          <label>{{ (i18n.terms$ | async)?.street || 'רחוב' }}</label>
          <input
            type="text"
            [(ngModel)]="place.street"
            (change)="onDetailChange()"
            [placeholder]="(i18n.terms$ | async)?.streetName || 'שם רחוב'"
            dir="rtl"
          >
        </div>
        <div class="detail-field small">
          <label>{{ (i18n.terms$ | async)?.houseNumber || 'מס׳' }}</label>
          <input
            type="text"
            [(ngModel)]="place.houseNumber"
            (change)="onDetailChange()"
            [placeholder]="(i18n.terms$ | async)?.houseNumber || 'מספר'"
            dir="rtl"
          >
        </div>
      </div>

      <!-- שורה שנייה: שכונה ועיר -->
      <div class="detail-row">
        <div class="detail-field">
          <label>{{ (i18n.terms$ | async)?.neighborhood || 'שכונה' }}</label>
          <input
            type="text"
            [(ngModel)]="place.neighborhood"
            (change)="onDetailChange()"
            [placeholder]="(i18n.terms$ | async)?.neighborhood || 'שכונה'"
            dir="rtl"
          >
        </div>
        <div class="detail-field">
          <label>{{ (i18n.terms$ | async)?.city || 'עיר' }}</label>
          <input
            type="text"
            [(ngModel)]="place.city"
            (change)="onDetailChange()"
            [placeholder]="(i18n.terms$ | async)?.city || 'עיר'"
            dir="rtl"
          >
        </div>
      </div>

      <!-- שורה שלישית: מחוז ומיקוד -->
      <div class="detail-row">
        <div class="detail-field">
          <label>{{ (i18n.terms$ | async)?.state || 'מחוז' }}</label>
          <input
            type="text"
            [(ngModel)]="place.state"
            (change)="onDetailChange()"
            [placeholder]="(i18n.terms$ | async)?.state || 'מחוז'"
            dir="rtl"
          >
        </div>
        <div class="detail-field small">
          <label>{{ (i18n.terms$ | async)?.postcode || 'מיקוד' }}</label>
          <input
            type="text"
            [(ngModel)]="place.postcode"
            (change)="onDetailChange()"
            [placeholder]="(i18n.terms$ | async)?.postcode || 'מיקוד'"
            dir="rtl"
          >
        </div>
      </div>

      <!-- שורה רביעית: מדינה -->
      <div class="detail-row">
        <div class="detail-field full-width">
          <label>{{ (i18n.terms$ | async)?.countryAutoUpdated || 'מדינה (מתעדכן אוטומטית מגוגל)' }}</label>
          <input readonly
            type="text"
            [value]="getCountryDisplayName()"
            [placeholder]="(i18n.terms$ | async)?.country || 'מדינה'"
            dir="rtl"
            style="cursor: not-allowed; background-color: #f5f5f5;"
            [title]="(i18n.terms$ | async)?.countryAutoUpdateNote || 'שדה זה מתעדכן אוטומטית מגוגל ולא ניתן לעריכה ידנית'"
          >
        </div>
      </div>

      <!-- שורה רביעית: שם המקום (אם יש) -->
      <div class="detail-row" *ngIf="place.placeName">
        <div class="detail-field full-width">
          <label>{{ (i18n.terms$ | async)?.placeName || 'שם המקום' }}</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input
              type="text"
              [(ngModel)]="place.placeName"
              (change)="onDetailChange()"
              [placeholder]="(i18n.terms$ | async)?.placeName || 'שם המקום'"
              dir="rtl"
              style="flex: 1;"
            >
            <button
              mat-stroked-button
              type="button"
              (click)="clearAddress(); $event.stopPropagation(); $event.preventDefault()"
              class="clear-address-btn"
              [matTooltip]="(i18n.terms$ | async)?.clearAddress || 'נקה כתובת'"
              style="white-space: nowrap;">
              <mat-icon>clear</mat-icon>
              {{ (i18n.terms$ | async)?.clearAddress || 'נקה כתובת' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Autocomplete dropdown -->
  <mat-autocomplete
    #auto="matAutocomplete"
    [displayWith]="displayFn"
    (optionSelected)="onSuggestionSelect($event.option.value)"
    dir="rtl">

    <mat-option
      *ngFor="let suggestion of suggestions"
      [value]="suggestion"
      class="address-option">

      <div class="suggestion-content">
        <!-- Main address line -->
        <div class="main-address">
          <!-- אינדיקטור חזותי להבחנה בין מקומות שמורים לחדשים -->
          <mat-icon
            class="location-icon"
            [class.saved-place]="suggestion.isFromDatabase"
            [matTooltip]="suggestion.isFromDatabase ? ((i18n.terms$ | async)?.savedPlace || 'מקום שמור במערכת') : ((i18n.terms$ | async)?.newPlace || 'מקום חדש מגוגל')">
            {{ suggestion.isFromDatabase ? 'bookmark' : 'place' }}
          </mat-icon>
          <span class="address-text">{{ getDisplayAddress(suggestion) }}</span>
          <!-- סמן "שמור" למקומות מהמערכת -->
          <mat-icon
            *ngIf="suggestion.isFromDatabase"
            class="saved-indicator"
            [matTooltip]="(i18n.terms$ | async)?.savedInSystem || 'נשמר במערכת'">
            star
          </mat-icon>
        </div>

        <!-- Address details -->
        <div class="address-details" *ngIf="getAddressDetails(suggestion)">
          <span class="details-text">{{ getAddressDetails(suggestion) }}</span>
        </div>

        <!-- City and country -->
        <div class="city-country">
          <span class="city-country-text">{{ getCityAndCountry(suggestion) }}</span>
        </div>
      </div>
    </mat-option>

    <!-- No results option -->
    <mat-option *ngIf="!isLoading && suggestions.length === 0 && searchValue.length >= 3" disabled>
      <div class="no-results">
        <mat-icon>search_off</mat-icon>
        <span>{{ (i18n.terms$ | async)?.noResults || 'לא נמצאו תוצאות' }}</span>
      </div>
    </mat-option>
  </mat-autocomplete>
</div>
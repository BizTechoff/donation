
<button mat-icon-button
        [matMenuTriggerFor]="filtersMenu"
        [class.filters-active]="hasAppliedFilters"
        matTooltip="{{ (i18n.terms$ | async)?.filters }}">
  <mat-icon>filter_list</mat-icon>
  <span *ngIf="appliedFiltersCount > 0" class="filter-count">{{ appliedFiltersCount }}</span>
</button>

<mat-menu #filtersMenu="matMenu" class="filters-menu" [dir]="i18n.lang.RTL ? 'rtl' : 'ltr'" [hasBackdrop]="false">
  <div class="filters-content" (click)="$event.stopPropagation()">

    <!-- Filter Header -->
    <div class="filters-header">
      <h3>{{ (i18n.terms$ | async)?.globalFilters }}</h3>
      <div class="header-actions">
        <button mat-icon-button
                class="apply-btn"
                [class.has-changes]="hasPendingChanges"
                (click)="applyFilters()"
                [disabled]="!hasPendingChanges"
                matTooltip="החל שינויים">
          <mat-icon>check</mat-icon>
        </button>
        <button mat-icon-button (click)="clearFilters()" [disabled]="!hasActiveFilters"
                [matTooltip]="(i18n.terms$ | async)?.clearAll || ''">
          <mat-icon>clear_all</mat-icon>
        </button>
      </div>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
      <button mat-stroked-button class="filter-btn" (click)="openCampaignSelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byCampaign }}
      </button>
      <button mat-stroked-button class="filter-btn" (click)="openCountrySelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byCountry }}
      </button>
      <button mat-stroked-button class="filter-btn" (click)="openCitySelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byCity }}
      </button>
      <button mat-stroked-button class="filter-btn" (click)="openNeighborhoodSelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byNeighborhood }}
      </button>
      <button mat-stroked-button class="filter-btn" (click)="openAudienceSelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byTargetAudience }}
      </button>
    </div>

    <!-- Donor Type Filters (Anash / Alumni) -->
    <div class="donor-type-filter-section">
      <div class="donor-type-row">
        <!-- {{currentFilters.isAnash}} | {{currentFilters.isAlumni}} -->
        <span class="section-label">אנ"ש:</span>
        <mat-button-toggle-group multiple>
          <mat-button-toggle [checked]="currentFilters.isAnash === 'yes'"
                             (change)="onIsAnashToggle('yes', $event.source.checked)">
            רק אנ"ש
          </mat-button-toggle>
          <mat-button-toggle [checked]="currentFilters.isAnash === 'no'"
                             (change)="onIsAnashToggle('no', $event.source.checked)">
            ללא אנ"ש
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>
      <div class="donor-type-row">
        <span class="section-label">תלמידנו:</span>
        <mat-button-toggle-group multiple>
          <mat-button-toggle [checked]="currentFilters.isAlumni === 'yes'"
                             (change)="onIsAlumniToggle('yes', $event.source.checked)">
            רק תלמידנו
          </mat-button-toggle>
          <mat-button-toggle [checked]="currentFilters.isAlumni === 'no'"
                             (change)="onIsAlumniToggle('no', $event.source.checked)">
            ללא תלמידנו
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>
    </div>

    <!-- Amount Range Filter -->
    <div class="amount-filter-section">
      <span class="section-label">{{ (i18n.terms$ | async)?.byAmount }}:</span>
      <!-- <small>{{ (i18n.terms$ | async)?.byAmount }}</small> -->
      <div class="amount-inputs">
        <input type="number"
               class="amount-input"
               [placeholder]="(i18n.terms$ | async)?.amountFrom || 'מסכום'"
               [value]="currentFilters.amountMin"
               (input)="onAmountMinInput($event)">
        <span class="amount-separator">-</span>
        <input type="number"
               class="amount-input"
               [placeholder]="(i18n.terms$ | async)?.amountTo || 'עד סכום'"
               [value]="currentFilters.amountMax"
               (input)="onAmountMaxInput($event)">
      </div>
    </div>

    <!-- Active Filters - Grouped by Type -->
    <div *ngIf="hasActiveFilters" class="active-filters">

      <!-- Campaigns Group -->
      <div *ngIf="currentFilters.campaignIds && currentFilters.campaignIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.campaigns }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let campaignId of currentFilters.campaignIds"
                    [removable]="true"
                    (removed)="removeCampaignFilter(campaignId)">
            {{ getCampaignName(campaignId) }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Countries Group -->
      <div *ngIf="currentFilters.countryIds && currentFilters.countryIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.countries }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let countryId of currentFilters.countryIds"
                    [removable]="true"
                    (removed)="removeCountryFilter(countryId)">
            {{ getCountryDisplayName(countryId) }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Cities Group -->
      <div *ngIf="currentFilters.cityIds && currentFilters.cityIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.cities }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let city of currentFilters.cityIds"
                    [removable]="true"
                    (removed)="removeCityFilter(city)">
            {{ city }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Neighborhoods Group -->
      <div *ngIf="currentFilters.neighborhoodIds && currentFilters.neighborhoodIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.neighborhoods }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let neighborhood of currentFilters.neighborhoodIds"
                    [removable]="true"
                    (removed)="removeNeighborhoodFilter(neighborhood)">
            {{ neighborhood }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Target Audiences Group -->
      <div *ngIf="currentFilters.targetAudienceIds && currentFilters.targetAudienceIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.targetAudiences }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let targetAudienceId of currentFilters.targetAudienceIds"
                    [removable]="true"
                    (removed)="removeTargetAudienceFilter(targetAudienceId)">
            {{ getTargetAudienceName(targetAudienceId) }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Amount Range Group -->
      <div *ngIf="currentFilters.amountMin !== undefined || currentFilters.amountMax !== undefined" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.amount }}:</span>
        <mat-chip-set>
          <mat-chip [removable]="true" (removed)="clearAmountFilter()">
            {{ getAmountFilterDisplay() }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

    </div>

    <!-- Finish Selection Button -->
    <div class="finish-selection-row">
      <button mat-raised-button
              class="finish-selection-btn"
              [class.has-changes]="hasPendingChanges"
              (click)="applyFilters()">
        <mat-icon>check_circle</mat-icon>
        סיים בחירה
      </button>
    </div>
  </div>
</mat-menu>
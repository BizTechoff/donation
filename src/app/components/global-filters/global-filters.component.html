
<button mat-icon-button
        [matMenuTriggerFor]="filtersMenu"
        [class.filters-active]="hasActiveFilters"
        matTooltip="{{ (i18n.terms$ | async)?.filters }}">
  <mat-icon>filter_list</mat-icon>
  <span *ngIf="activeFiltersCount > 0" class="filter-count">{{ activeFiltersCount }}</span>
</button>

<mat-menu #filtersMenu="matMenu" class="filters-menu" [dir]="i18n.lang.RTL ? 'rtl' : 'ltr'" [hasBackdrop]="false">
  <div class="filters-content" (click)="$event.stopPropagation()">

    <!-- Filter Header -->
    <div class="filters-header">
      <h3>{{ (i18n.terms$ | async)?.globalFilters }}</h3>
      <button mat-icon-button (click)="clearFilters()" [disabled]="!hasActiveFilters"
              [matTooltip]="(i18n.terms$ | async)?.clearAll || ''">
        <mat-icon>clear_all</mat-icon>
      </button>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
      <button mat-stroked-button class="filter-btn" (click)="openCampaignSelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byCampaign }}
      </button>
      <button mat-stroked-button class="filter-btn" (click)="openCountrySelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byCountry }}
      </button>
      <button mat-stroked-button class="filter-btn" (click)="openCitySelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byCity }}
      </button>
      <button mat-stroked-button class="filter-btn" (click)="openNeighborhoodSelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byNeighborhood }}
      </button>
      <button mat-stroked-button class="filter-btn" (click)="openAudienceSelectionModal($event)">
        + {{ (i18n.terms$ | async)?.byTargetAudience }}
      </button>
    </div>

    <!-- Active Filters - Grouped by Type -->
    <div *ngIf="hasActiveFilters" class="active-filters">

      <!-- Campaigns Group -->
      <div *ngIf="currentFilters.campaignIds && currentFilters.campaignIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.campaigns }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let campaignId of currentFilters.campaignIds"
                    [removable]="true"
                    (removed)="removeCampaignFilter(campaignId)">
            {{ getCampaignName(campaignId) }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Countries Group -->
      <div *ngIf="currentFilters.countryIds && currentFilters.countryIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.countries }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let countryId of currentFilters.countryIds"
                    [removable]="true"
                    (removed)="removeCountryFilter(countryId)">
            {{ getCountryDisplayName(countryId) }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Cities Group -->
      <div *ngIf="currentFilters.cityIds && currentFilters.cityIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.cities }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let city of currentFilters.cityIds"
                    [removable]="true"
                    (removed)="removeCityFilter(city)">
            {{ city }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Neighborhoods Group -->
      <div *ngIf="currentFilters.neighborhoodIds && currentFilters.neighborhoodIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.neighborhoods }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let neighborhood of currentFilters.neighborhoodIds"
                    [removable]="true"
                    (removed)="removeNeighborhoodFilter(neighborhood)">
            {{ neighborhood }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Target Audiences Group -->
      <div *ngIf="currentFilters.targetAudienceIds && currentFilters.targetAudienceIds.length > 0" class="filter-group">
        <span class="group-label">{{ (i18n.terms$ | async)?.targetAudiences }}:</span>
        <mat-chip-set>
          <mat-chip *ngFor="let targetAudienceId of currentFilters.targetAudienceIds"
                    [removable]="true"
                    (removed)="removeTargetAudienceFilter(targetAudienceId)">
            {{ getTargetAudienceName(targetAudienceId) }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>

    </div>
  </div>
</mat-menu>
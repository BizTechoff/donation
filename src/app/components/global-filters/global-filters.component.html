
<button mat-icon-button 
        [matMenuTriggerFor]="filtersMenu"
        [class.filters-active]="hasActiveFilters"
        matTooltip="{{ (i18n.terms$ | async)?.filters }}">
  <mat-icon>filter_list</mat-icon>
  <span *ngIf="activeFiltersCount > 0" class="filter-count">{{ activeFiltersCount }}</span>
</button>

<mat-menu #filtersMenu="matMenu" class="filters-menu" [dir]="i18n.lang.RTL ? 'rtl' : 'ltr'" [hasBackdrop]="false">
  <div class="filters-content" (click)="$event.stopPropagation()">

    <!-- Filter Header -->
    <div class="filters-header">
      <h3>{{ (i18n.terms$ | async)?.filters }}</h3>
      <button mat-icon-button (click)="clearFilters()" [disabled]="!hasActiveFilters">
        <mat-icon>clear_all</mat-icon>
      </button>
    </div>

    <!-- Campaign Filter -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>{{ (i18n.terms$ | async)?.campaign }}</mat-label>
      <mat-select [value]="currentFilters.campaignIds || []"
                  (valueChange)="updateFilter('campaignIds', $event.length > 0 ? $event : undefined)"
                  multiple
                  disableOptionCentering>
        <mat-option *ngFor="let campaign of campaigns" [value]="campaign.id">
          {{ campaign.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Country Filter -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>{{ (i18n.terms$ | async)?.country }}</mat-label>
      <mat-select [value]="currentFilters.countryIds || []"
                  (valueChange)="updateFilter('countryIds', $event.length > 0 ? $event : undefined)"
                  multiple
                  disableOptionCentering>
        <mat-option *ngFor="let country of countries" [value]="country.id">
          {{ country.displayName }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Date Range -->
    <div class="date-range-container">
      <mat-form-field appearance="outline" class="filter-field date-field">
        <mat-label>{{ (i18n.terms$ | async)?.fromDate }}</mat-label>
        <input matInput
               [matDatepicker]="fromPicker"
               [value]="currentFilters.dateFrom"
               [max]="currentFilters.dateTo"
               (dateChange)="onDateFromChange($event.value)">
        <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
        <mat-datepicker #fromPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field date-field">
        <mat-label>{{ (i18n.terms$ | async)?.toDate }}</mat-label>
        <input matInput
               [matDatepicker]="toPicker"
               [value]="currentFilters.dateTo"
               [min]="currentFilters.dateFrom"
               (dateChange)="onDateToChange($event.value)">
        <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
        <mat-datepicker #toPicker></mat-datepicker>
      </mat-form-field>
    </div>

    <!-- Amount Range -->
    <div class="amount-range-container">
      <mat-form-field appearance="outline" class="filter-field amount-field">
        <mat-label>{{ (i18n.terms$ | async)?.minAmount }}</mat-label>
        <input matInput
               type="number"
               [value]="currentFilters.amountMin || ''"
               [max]="currentFilters.amountMax"
               (input)="onAmountMinInput($event)">
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field amount-field">
        <mat-label>{{ (i18n.terms$ | async)?.maxAmount }}</mat-label>
        <input matInput
               type="number"
               [value]="currentFilters.amountMax || ''"
               [min]="currentFilters.amountMin"
               (input)="onAmountMaxInput($event)">
      </mat-form-field>
    </div>

    <!-- Active Filters Chips -->
    <div *ngIf="hasActiveFilters" class="active-filters">
      <h4>{{ (i18n.terms$ | async)?.activeFilters }}</h4>
      <mat-chip-set>
        <mat-chip *ngFor="let campaignId of currentFilters.campaignIds || []"
                  [removable]="true"
                  (removed)="removeCampaignFilter(campaignId)">
          {{ (i18n.terms$ | async)?.campaign }}: {{ getCampaignName(campaignId) }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>

        <mat-chip *ngFor="let countryId of currentFilters.countryIds || []"
                  [removable]="true"
                  (removed)="removeCountryFilter(countryId)">
          {{ (i18n.terms$ | async)?.country }}: {{ getCountryDisplayName(countryId) }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>

        <mat-chip *ngIf="currentFilters.dateFrom"
                  [removable]="true"
                  (removed)="clearFilter('dateFrom')">
          {{ (i18n.terms$ | async)?.fromDate }}: {{ currentFilters.dateFrom | date:'short' }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>

        <mat-chip *ngIf="currentFilters.dateTo"
                  [removable]="true"
                  (removed)="clearFilter('dateTo')">
          {{ (i18n.terms$ | async)?.toDate }}: {{ currentFilters.dateTo | date:'short' }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>

        <mat-chip *ngIf="currentFilters.amountMin !== undefined"
                  [removable]="true"
                  (removed)="clearFilter('amountMin')">
          {{ (i18n.terms$ | async)?.minAmount }}: {{ currentFilters.amountMin }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>

        <mat-chip *ngIf="currentFilters.amountMax !== undefined"
                  [removable]="true"
                  (removed)="clearFilter('amountMax')">
          {{ (i18n.terms$ | async)?.maxAmount }}: {{ currentFilters.amountMax }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
      </mat-chip-set>
    </div>
  </div>
</mat-menu>
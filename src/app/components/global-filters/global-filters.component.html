<button mat-icon-button 
        [matMenuTriggerFor]="filtersMenu"
        [class.filters-active]="hasActiveFilters"
        matTooltip="{{ (i18n.terms$ | async)?.filters }}">
  <mat-icon>filter_list</mat-icon>
  <span *ngIf="activeFiltersCount > 0" class="filter-count">{{ activeFiltersCount }}</span>
</button>

<mat-menu #filtersMenu="matMenu" class="filters-menu" [dir]="i18n.lang.RTL ? 'rtl' : 'ltr'">
  <div class="filters-content" (click)="$event.stopPropagation()">
    
    <!-- Filter Header -->
    <div class="filters-header">
      <h3>{{ (i18n.terms$ | async)?.filters }}</h3>
      <button mat-icon-button (click)="clearFilters()" [disabled]="!hasActiveFilters">
        <mat-icon>clear_all</mat-icon>
      </button>
    </div>
    
    <!-- Campaign Filter -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>{{ (i18n.terms$ | async)?.campaign }}</mat-label>
      <mat-select [value]="currentFilters.campaignId || ''"
                  (valueChange)="updateFilter('campaignId', $event || undefined)">
        <mat-option value="">{{ (i18n.terms$ | async)?.all }}</mat-option>
        <mat-option *ngFor="let campaign of campaigns" [value]="campaign.id">
          {{ campaign.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Country Filter -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>{{ (i18n.terms$ | async)?.country }}</mat-label>
      <mat-select [value]="currentFilters.countryId || ''"
                  (valueChange)="updateFilter('countryId', $event || undefined)">
        <mat-option value="">{{ (i18n.terms$ | async)?.all }}</mat-option>
        <mat-option *ngFor="let country of countries" [value]="country.id">
          {{ country.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    
    <!-- Status Filter -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>{{ (i18n.terms$ | async)?.status }}</mat-label>
      <mat-select [value]="currentFilters.statusFilter || 'all'"
                  (valueChange)="updateFilter('statusFilter', $event)">
        <mat-option value="all">{{ (i18n.terms$ | async)?.all }}</mat-option>
        <mat-option value="active">{{ (i18n.terms$ | async)?.active }}</mat-option>
        <mat-option value="inactive">{{ (i18n.terms$ | async)?.inactive }}</mat-option>
      </mat-select>
    </mat-form-field>
    
    <!-- Year Filter -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>{{ (i18n.terms$ | async)?.year }}</mat-label>
      <mat-select [value]="currentFilters.selectedYear || ''"
                  (valueChange)="updateFilter('selectedYear', $event || undefined)">
        <mat-option value="">{{ (i18n.terms$ | async)?.all }}</mat-option>
        <mat-option *ngFor="let year of availableYears" [value]="year">
          {{ year }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    
    <!-- Date Range -->
    <div class="date-range-container">
      <mat-form-field appearance="outline" class="filter-field date-field">
        <mat-label>{{ (i18n.terms$ | async)?.fromDate }}</mat-label>
        <input matInput 
               [matDatepicker]="fromPicker" 
               [value]="currentFilters.dateFrom || ''"
               (dateChange)="updateFilter('dateFrom', $event.value)">
        <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
        <mat-datepicker #fromPicker></mat-datepicker>
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="filter-field date-field">
        <mat-label>{{ (i18n.terms$ | async)?.toDate }}</mat-label>
        <input matInput 
               [matDatepicker]="toPicker" 
               [value]="currentFilters.dateTo || ''"
               (dateChange)="updateFilter('dateTo', $event.value)">
        <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
        <mat-datepicker #toPicker></mat-datepicker>
      </mat-form-field>
    </div>
    
    <!-- Amount Range -->
    <div class="amount-range-container">
      <mat-form-field appearance="outline" class="filter-field amount-field">
        <mat-label>{{ (i18n.terms$ | async)?.minAmount }}</mat-label>
        <input matInput 
               type="number" 
               [value]="currentFilters.amountMin || ''"
               (input)="onAmountMinInput($event)">
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="filter-field amount-field">
        <mat-label>{{ (i18n.terms$ | async)?.maxAmount }}</mat-label>
        <input matInput 
               type="number" 
               [value]="currentFilters.amountMax || ''"
               (input)="onAmountMaxInput($event)">
      </mat-form-field>
    </div>
    
    <!-- Active Filters Chips -->
    <div *ngIf="hasActiveFilters" class="active-filters">
      <h4>{{ (i18n.terms$ | async)?.activeFilters }}</h4>
      <mat-chip-set>
        <mat-chip *ngIf="currentFilters.campaignId"
                  [removable]="true"
                  (removed)="clearFilter('campaignId')">
          {{ (i18n.terms$ | async)?.campaign }}: {{ getCampaignName(currentFilters.campaignId) }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>

        <mat-chip *ngIf="currentFilters.countryId"
                  [removable]="true"
                  (removed)="clearFilter('countryId')">
          {{ (i18n.terms$ | async)?.country }}: {{ getCountryName(currentFilters.countryId) }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        
        <mat-chip *ngIf="currentFilters.statusFilter && currentFilters.statusFilter !== 'all'" 
                  [removable]="true" 
                  (removed)="clearFilter('statusFilter')">
          {{ (i18n.terms$ | async)?.status }}: {{ getStatusText(currentFilters.statusFilter) }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        
        <mat-chip *ngIf="currentFilters.selectedYear" 
                  [removable]="true" 
                  (removed)="clearFilter('selectedYear')">
          {{ (i18n.terms$ | async)?.year }}: {{ currentFilters.selectedYear }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        
        <mat-chip *ngIf="currentFilters.dateFrom" 
                  [removable]="true" 
                  (removed)="clearFilter('dateFrom')">
          {{ (i18n.terms$ | async)?.fromDate }}: {{ currentFilters.dateFrom | date:'short' }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        
        <mat-chip *ngIf="currentFilters.dateTo" 
                  [removable]="true" 
                  (removed)="clearFilter('dateTo')">
          {{ (i18n.terms$ | async)?.toDate }}: {{ currentFilters.dateTo | date:'short' }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        
        <mat-chip *ngIf="currentFilters.amountMin !== undefined" 
                  [removable]="true" 
                  (removed)="clearFilter('amountMin')">
          {{ (i18n.terms$ | async)?.minAmount }}: {{ currentFilters.amountMin }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        
        <mat-chip *ngIf="currentFilters.amountMax !== undefined" 
                  [removable]="true" 
                  (removed)="clearFilter('amountMax')">
          {{ (i18n.terms$ | async)?.maxAmount }}: {{ currentFilters.amountMax }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
      </mat-chip-set>
    </div>
  </div>
</mat-menu>
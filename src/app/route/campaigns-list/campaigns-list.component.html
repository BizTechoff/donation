<div class="campaigns-container">
  <div class="page-header">
    <h1>{{ (i18n.terms$ | async)?.campaignsManagement }}</h1>
    <button class="btn btn-primary add-campaign-btn" (click)="createCampaign()">{{ (i18n.terms$ | async)?.newCampaign }}</button>
  </div>

  <!-- כרטיסי סיכום -->
  <div class="summary-cards">
    <div class="summary-card active-campaigns">
      <div class="card-icon">🎯</div>
      <div class="card-content">
        <h3>{{ (i18n.terms$ | async)?.activeCampaignsCard }}</h3>
        <span class="count">{{activeCampaigns}}</span>
      </div>
    </div>
    <div class="summary-card target-amount">
      <div class="card-icon">💰</div>
      <div class="card-content">
        <h3>{{ (i18n.terms$ | async)?.totalTargetAmountCard }}</h3>
        <span class="amount">{{formatCurrency(totalTargetAmount)}}</span>
      </div>
    </div>
    <div class="summary-card raised-amount">
      <div class="card-icon">📊</div>
      <div class="card-content">
        <h3>{{ (i18n.terms$ | async)?.collectedSoFar }}</h3>
        <span class="amount">{{formatCurrency(totalRaisedAmount)}}</span>
      </div>
    </div>
    <div class="summary-card success-rate">
      <div class="card-icon">📈</div>
      <div class="card-content">
        <h3>{{ (i18n.terms$ | async)?.successRate }}</h3>
        <span class="percentage">{{totalTargetAmount > 0 ? ((totalRaisedAmount / totalTargetAmount) * 100).toFixed(1) : 0}}%</span>
      </div>
    </div>
  </div>

  <!-- מפיינים -->
  <div class="filters-section">
    <div class="filter-row">
      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.campaignName }}</label>
        <input type="text" class="form-control" 
               [(ngModel)]="filterName" 
               (ngModelChange)="applyFilters()"
               [placeholder]="(i18n.terms$ | async)?.searchByName">
      </div>
      
      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.statusFilter }}</label>
        <select class="form-control" 
                [(ngModel)]="filterStatus" 
                (ngModelChange)="applyFilters()">
          <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
          <option value="draft">{{ (i18n.terms$ | async)?.draft }}</option>
          <option value="active">{{ (i18n.terms$ | async)?.activeStatus }}</option>
          <option value="completed">{{ (i18n.terms$ | async)?.completedStatus }}</option>
          <option value="cancelled">{{ (i18n.terms$ | async)?.cancelledStatus }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.category }}</label>
        <input type="text" class="form-control" 
               [(ngModel)]="filterCategory" 
               (ngModelChange)="applyFilters()"
               [placeholder]="(i18n.terms$ | async)?.categoryPlaceholder">
      </div>

      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.activeInactive }}</label>
        <select class="form-control" 
                [(ngModel)]="filterActive" 
                (ngModelChange)="applyFilters()">
          <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
          <option value="true">{{ (i18n.terms$ | async)?.activeStatus }}</option>
          <option value="false">{{ (i18n.terms$ | async)?.inactiveStatus }}</option>
        </select>
      </div>

      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="clearFilters()">{{ (i18n.terms$ | async)?.clearFilters }}</button>
        <button class="btn btn-info" (click)="loadData()" [disabled]="loading">{{ (i18n.terms$ | async)?.refresh }}</button>
      </div>
    </div>
  </div>

  <!-- טבלת קמפיינים -->
  <div class="campaigns-table-container">
    <div *ngIf="loading" class="loading-overlay">
      <div class="loading-spinner">{{ (i18n.terms$ | async)?.loadingCampaigns }}</div>
    </div>
    
    <table class="campaigns-table">
      <thead>
        <tr>
          <th>{{ (i18n.terms$ | async)?.campaignName }}</th>
          <th>{{ (i18n.terms$ | async)?.category }}</th>
          <th>{{ (i18n.terms$ | async)?.financialTarget }}</th>
          <th>{{ (i18n.terms$ | async)?.collected }}</th>
          <th>{{ (i18n.terms$ | async)?.progressPercentage }}</th>
          <th>{{ (i18n.terms$ | async)?.startDate }}</th>
          <th>{{ (i18n.terms$ | async)?.endDate }}</th>
          <th>{{ (i18n.terms$ | async)?.status }}</th>
          <th>{{ (i18n.terms$ | async)?.responsible }}</th>
          <th>{{ (i18n.terms$ | async)?.actions }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let campaign of campaigns" [class.inactive]="!campaign.isActive">
          <td class="campaign-name-col">
            <div class="campaign-info">
              <strong>{{campaign.name}}</strong>
              <small *ngIf="campaign.description">{{campaign.description}}</small>
            </div>
          </td>
          <td>{{campaign.category || ((i18n.terms$ | async)?.notSpecified)}}</td>
          <td class="amount-col">
            <span class="amount">{{formatCurrency(campaign.targetAmount)}}</span>
          </td>
          <td class="amount-col">
            <span class="amount raised">{{formatCurrency(campaign.raisedAmount)}}</span>
          </td>
          <td class="progress-col">
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="campaign.progressPercentage"></div>
              </div>
              <span class="progress-text">{{campaign.progressPercentage}}%</span>
            </div>
          </td>
          <td>{{formatDate(campaign.startDate)}}</td>
          <td>{{formatDate(campaign.endDate)}}</td>
          <td>
            <span class="status-badge" [class]="getStatusBadgeClass(campaign.status)">
              {{getStatusText(campaign.status)}}
            </span>
          </td>
          <td>{{campaign.manager?.name || ((i18n.terms$ | async)?.notSpecified)}}</td>
          <td class="actions">
            <button class="btn-icon btn-view" [title]="(i18n.terms$ | async)?.viewDetails" (click)="editCampaign(campaign)">👁</button>
            <button class="btn-icon btn-edit" [title]="(i18n.terms$ | async)?.edit" (click)="editCampaign(campaign)">✏</button>
            <button class="btn-icon btn-activate" [title]="(i18n.terms$ | async)?.activate" (click)="activateCampaign(campaign)" 
                    *ngIf="campaign.status === 'draft'">▶</button>
            <button class="btn-icon btn-complete" [title]="(i18n.terms$ | async)?.markAsCompleted" (click)="completeCampaign(campaign)" 
                    *ngIf="campaign.status === 'active'">✅</button>
            <button class="btn-icon btn-cancel" [title]="(i18n.terms$ | async)?.cancel" (click)="cancelCampaign(campaign)" 
                    *ngIf="campaign.status === 'active' || campaign.status === 'draft'">❌</button>
            <button class="btn-icon btn-delete" [title]="(i18n.terms$ | async)?.delete" (click)="deleteCampaign(campaign)">🗑</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!loading && campaigns.length === 0" class="no-campaigns">
    <div class="no-campaigns-icon">🎯</div>
    <h3>{{ (i18n.terms$ | async)?.noCampaigns }}</h3>
    <p>{{ (i18n.terms$ | async)?.noCampaignsMatchingCriteria }}</p>
    <button class="btn btn-primary" (click)="createCampaign()">{{ (i18n.terms$ | async)?.createFirstCampaign }}</button>
  </div>
</div>

<div class="modal-overlay" *ngIf="showAddCampaignModal">
  <div class="modal-content campaign-modal">
    <div class="modal-header">
      <h2>{{editingCampaign?._?.isNew() ? ((i18n.terms$ | async)?.newCampaign) : ((i18n.terms$ | async)?.editCampaign)}}</h2>
      <button class="modal-close" (click)="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.campaignName }} *</label>
          <input type="text" class="form-control" 
                 [(ngModel)]="editingCampaign!.name" 
                 [placeholder]="(i18n.terms$ | async)?.enterCampaignName">
        </div>
        
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.category }}</label>
          <input type="text" class="form-control" 
                 [(ngModel)]="editingCampaign!.category" 
                 [placeholder]="(i18n.terms$ | async)?.campaignCategory">
        </div>
        
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.financialTarget }} *</label>
          <input type="number" class="form-control" 
                 [(ngModel)]="editingCampaign!.targetAmount" 
                 placeholder="0">
        </div>
        
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.currency }}</label>
          <select class="form-control" [(ngModel)]="editingCampaign!.currency" (change)="onLocationChange()">
            <option value="ILS">{{ (i18n.terms$ | async)?.shekelOption }}</option>
            <option value="USD">{{ (i18n.terms$ | async)?.dollarOption }}</option>
            <option value="EUR">{{ (i18n.terms$ | async)?.euroOption }}</option>
          </select>
        </div>
        
        <!-- New fields -->
        <div class="form-group">
          <label>מיקום האירוע</label>
          <input type="text" class="form-control" 
                 [(ngModel)]="editingCampaign!.eventLocation" 
                 (ngModelChange)="onLocationChange()"
                 placeholder="מיקום האירוע">
        </div>
        
        <div class="form-group">
          <label>מעמד</label>
          <input type="text" class="form-control" 
                 [(ngModel)]="editingCampaign!.status2" 
                 placeholder="מעמד האירוע">
        </div>
        
        <div class="form-group">
          <label>סוג קמפיין</label>
          <select class="form-control" [(ngModel)]="editingCampaign!.campaignType" (change)="onCampaignTypeChange()">
            <option value="רגיל">רגיל</option>
            <option value="דינעער">דינעער</option>
          </select>
        </div>
        
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="editingCampaign!.isAnash"> אנ"ש
          </label>
        </div>
        
        <!-- Start Date with Hebrew-Gregorian picker -->
        <div class="form-group full-width">
          <app-modern-dual-date-picker
            [(ngModel)]="editingCampaign!.startDate"
            [label]="'תאריך התחלה'"
            (dateChange)="onStartDateChange($event)">
          </app-modern-dual-date-picker>
        </div>
        
        <!-- End Date with Hebrew-Gregorian picker -->
        <div class="form-group full-width">
          <app-modern-dual-date-picker
            [(ngModel)]="editingCampaign!.endDate"
            [label]="'תאריך סיום'"
            (dateChange)="onEndDateChange($event)">
          </app-modern-dual-date-picker>
        </div>
        
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.status }}</label>
          <select class="form-control" [(ngModel)]="editingCampaign!.status">
            <option value="draft">{{ (i18n.terms$ | async)?.draft }}</option>
            <option value="active">{{ (i18n.terms$ | async)?.activeStatus }}</option>
            <option value="completed">{{ (i18n.terms$ | async)?.completedStatus }}</option>
            <option value="cancelled">{{ (i18n.terms$ | async)?.cancelledStatus }}</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.campaignManager }}</label>
          <select class="form-control" [(ngModel)]="editingCampaign!.managerId">
            <option value="">{{ (i18n.terms$ | async)?.selectManager }}</option>
            <option *ngFor="let user of users" [value]="user.id">{{user.name}}</option>
          </select>
        </div>
        
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="editingCampaign!.isActive"> {{ (i18n.terms$ | async)?.activeCampaign }}
          </label>
        </div>
        
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="editingCampaign!.isPublic"> {{ (i18n.terms$ | async)?.displayedOnWebsite }}
          </label>
        </div>
        
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.imageLink }}</label>
          <input type="url" class="form-control" 
                 [(ngModel)]="editingCampaign!.imageUrl" 
                 [placeholder]="(i18n.terms$ | async)?.imageLinkPlaceholder">
        </div>
        
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.pageLink }}</label>
          <input type="url" class="form-control" 
                 [(ngModel)]="editingCampaign!.websiteUrl" 
                 [placeholder]="(i18n.terms$ | async)?.pageLinkPlaceholder">
        </div>
        
        <div class="form-group full-width">
          <label>{{ (i18n.terms$ | async)?.campaignDescription }}</label>
          <textarea class="form-control" rows="3" 
                    [(ngModel)]="editingCampaign!.description" 
                    [placeholder]="(i18n.terms$ | async)?.describeCampaignGoals"></textarea>
        </div>
        
        <div class="form-group full-width">
          <label>{{ (i18n.terms$ | async)?.internalNotes }}</label>
          <textarea class="form-control" rows="2" 
                    [(ngModel)]="editingCampaign!.internalNotes" 
                    [placeholder]="(i18n.terms$ | async)?.notesForTeam"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <!-- Action buttons for dinner campaigns -->
      <div class="action-buttons" *ngIf="editingCampaign?.campaignType === 'דינעער' && editingCampaign && !editingCampaign._.isNew()">
        <button class="btn btn-info" (click)="openBlessingsBook()" title="ספר ברכות">
          📖 ספר ברכות
        </button>
      </div>
      
      <!-- Regular action buttons -->
      <div class="action-buttons" *ngIf="editingCampaign && !editingCampaign._.isNew()">
        <button class="btn btn-outline-primary" (click)="openDonors()" title="תורמים">
          👥 תורמים
        </button>
        <button class="btn btn-outline-success" (click)="openContacts()" title="אנשי קשר ופעילים">
          📞 אנשי קשר ופעילים
        </button>
      </div>
      
      <div class="main-buttons">
        <button class="btn btn-secondary" (click)="closeModal()">{{ (i18n.terms$ | async)?.cancel }}</button>
        <button class="btn btn-primary" (click)="saveCampaign()">{{ (i18n.terms$ | async)?.saveCampaign }}</button>
      </div>
    </div>
  </div>
</div>

<div class="module-container">

  <!-- HEADER: Sticky top - ×›×•×ª×¨×ª + ×›×¤×ª×•×¨ ×”×•×¡×¤×” + ×¤×™×œ×˜×¨×™× -->
  <div class="module-header">
    <div class="header-top">
      <h1>{{ (i18n.terms$ | async)?.campaignsManagement }}</h1>
      <button class="btn btn-primary add-campaign-btn" (click)="createCampaign()">
        {{ (i18n.terms$ | async)?.newCampaign }}
      </button>
    </div>

    <!-- ×›×¨×˜×™×¡×™ ×¡×™×›×•× -->
    <div class="summary-cards">
      <div class="summary-card active-campaigns">
        <div class="card-icon">ğŸ¯</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.activeCampaignsCard }}</h3>
          <span class="count">{{activeCampaigns}}</span>
        </div>
      </div>
      <div class="summary-card target-amount">
        <div class="card-icon">ğŸ’°</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.totalTargetAmountCard }}</h3>
          <span class="amount">{{formatCurrency(totalTargetAmount)}}</span>
        </div>
      </div>
      <div class="summary-card raised-amount">
        <div class="card-icon">ğŸ“Š</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.collectedSoFar }}</h3>
          <span class="amount">{{formatCurrency(totalRaisedAmount)}}</span>
        </div>
      </div>
      <div class="summary-card success-rate">
        <div class="card-icon">ğŸ“ˆ</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.successRate }}</h3>
          <span class="percentage">{{totalTargetAmount > 0 ? ((totalRaisedAmount / totalTargetAmount) * 100).toFixed(1) : 0}}%</span>
        </div>
      </div>
    </div>

    <div class="filters-section">
      <div class="filter-row">
        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.campaignName }}</label>
          <input type="text" class="form-control"
                 [(ngModel)]="filterName"
                 (ngModelChange)="applyFilters()"
                 [placeholder]="(i18n.terms$ | async)?.searchByName">
        </div>

        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.activeInactive }}</label>
          <select class="form-control"
                  [(ngModel)]="filterActive"
                  (ngModelChange)="applyFilters()">
            <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
            <option value="true">{{ (i18n.terms$ | async)?.activeStatus }}</option>
            <option value="false">{{ (i18n.terms$ | async)?.inactiveStatus }}</option>
          </select>
        </div>

        <!-- <div class="filter-actions">
          <button class="btn btn-secondary" (click)="clearFilters()">{{ (i18n.terms$ | async)?.clearFilters }}</button>
          <button class="btn btn-info" (click)="loadData()" [disabled]="loading">{{ (i18n.terms$ | async)?.refresh }}</button>
        </div> -->
      </div>
    </div>
  </div>

  <!-- CONTENT: ××–×•×¨ ×”×ª×•×›×Ÿ ×”××¨×›×–×™ -->
  <div class="module-content">

    <!-- Table Body: Scrollable area -->
    <div class="table-body">
      <div class="loading-overlay" *ngIf="loading">
        <div class="spinner">{{ (i18n.terms$ | async)?.loadingCampaigns }}</div>
      </div>

      <table class="data-table">
      <thead>
        <tr>
          <th class="sortable" [class.sorted]="isSorted('name')" (click)="toggleSort('name', $event)">
            {{ (i18n.terms$ | async)?.campaignName }}
            <span class="sort-icon" *ngIf="getSortIcon('name')">{{ getSortIcon('name') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('targetAmount')" (click)="toggleSort('targetAmount', $event)">
            {{ (i18n.terms$ | async)?.financialTarget }}
            <span class="sort-icon" *ngIf="getSortIcon('targetAmount')">{{ getSortIcon('targetAmount') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('raisedAmount')" (click)="toggleSort('raisedAmount', $event)">
            {{ (i18n.terms$ | async)?.collected }}
            <span class="sort-icon" *ngIf="getSortIcon('raisedAmount')">{{ getSortIcon('raisedAmount') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('progressPercentage')" (click)="toggleSort('progressPercentage', $event)">
            {{ (i18n.terms$ | async)?.progressPercentage }}
            <span class="sort-icon" *ngIf="getSortIcon('progressPercentage')">{{ getSortIcon('progressPercentage') }}</span>
          </th>
          <th>{{ (i18n.terms$ | async)?.inviteesHeader }}</th>
          <th>{{ (i18n.terms$ | async)?.blessingsHeader }}</th>
          <th class="sortable" [class.sorted]="isSorted('startDate')" (click)="toggleSort('startDate', $event)">
            {{ (i18n.terms$ | async)?.startDate }}
            <span class="sort-icon" *ngIf="getSortIcon('startDate')">{{ getSortIcon('startDate') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('endDate')" (click)="toggleSort('endDate', $event)">
            {{ (i18n.terms$ | async)?.endDate }}
            <span class="sort-icon" *ngIf="getSortIcon('endDate')">{{ getSortIcon('endDate') }}</span>
          </th>
          <th>{{ (i18n.terms$ | async)?.actions }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let campaign of campaigns" [class.inactive]="!campaign.isActive">
          <td>
            <div class="campaign-info">
              <strong>{{campaign.name}}</strong>
              <small *ngIf="campaign.description">{{campaign.description}}</small>
            </div>
          </td>
          <td class="amount">{{formatCurrency(campaign.targetAmount)}}</td>
          <td class="amount raised">{{formatCurrency(campaign.raisedAmount)}}</td>
          <td>
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="campaign.progressPercentage"></div>
              </div>
              <span class="progress-text">{{campaign.progressPercentage}}%</span>
            </div>
          </td>
          <td>{{getInviteesCount(campaign)}}</td>
          <td>{{getBlessingCount(campaign)}}</td>
          <td>{{formatHebrewDate(campaign.startDate)}}</td>
          <td>{{formatHebrewDate(campaign.endDate)}}</td>
          <td class="actions">
            <button class="btn-icon btn-invited" [title]="(i18n.terms$ | async)?.inviteesList" (click)="openInvitedList(campaign)">ğŸ‘¥</button>
            <button class="btn-icon btn-blessings" [title]="(i18n.terms$ | async)?.blessingsBook" (click)="openBlessingsBook(campaign)">ğŸ“–</button>
            <button class="btn-icon btn-edit" [title]="(i18n.terms$ | async)?.edit" (click)="editCampaign(campaign)">âœ</button>
            <button class="btn-icon btn-delete" [title]="(i18n.terms$ | async)?.delete" (click)="deleteCampaign(campaign)">ğŸ—‘</button>
          </td>
        </tr>
        <tr *ngIf="!loading && campaigns.length === 0">
          <td colspan="9" class="no-data">
            <div class="no-campaigns-icon">ğŸ¯</div>
            <h3>{{ (i18n.terms$ | async)?.noCampaigns }}</h3>
            <p>{{ (i18n.terms$ | async)?.noCampaignsMatchingCriteria }}</p>
            <button class="btn btn-primary" (click)="createCampaign()">{{ (i18n.terms$ | async)?.createFirstCampaign }}</button>
          </td>
        </tr>
      </tbody>
    </table>
    </div>

    <!-- Table Footer: Sticky bottom - Pagination -->
    <div class="table-footer">
      <div class="pagination-controls">
        <button
          class="btn-page"
          (click)="firstPage()"
          [disabled]="currentPage === 1 || loading">
          â® {{ (i18n.terms$ | async)?.first }}
        </button>

        <button
          class="btn-page"
          (click)="previousPage()"
          [disabled]="currentPage === 1 || loading">
          â† {{ (i18n.terms$ | async)?.previous }}
        </button>

        <div class="page-numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            class="btn-page-number"
            [class.active]="page === currentPage"
            (click)="goToPage(page)"
            [disabled]="loading">
            {{page}}
          </button>
        </div>

        <button
          class="btn-page"
          (click)="nextPage()"
          [disabled]="currentPage === totalPages || loading">
          {{ (i18n.terms$ | async)?.next }} â†’
        </button>

        <button
          class="btn-page"
          (click)="lastPage()"
          [disabled]="currentPage === totalPages || loading">
          {{ (i18n.terms$ | async)?.last }} â­
        </button>
      </div>

      <div class="pagination-info">
        <span>{{ (i18n.terms$ | async)?.showing }} {{(currentPage - 1) * pageSize + 1}} - {{Math.min(currentPage * pageSize, totalCount)}} {{ (i18n.terms$ | async)?.of }} {{totalCount}}</span>
      </div>
    </div>
  </div>

  <!-- FOOTER: Sticky bottom - (×¨×™×§ ×›×¨×’×¢, ×œ×¢×ª×™×“) -->
  <div class="module-footer">
    <!-- ××§×•× ×œ×¡×™×›×•××™×, ×¡×˜×˜×™×¡×˜×™×§×•×ª, ×•×›×•' -->
  </div>

</div>

<div class="modal-overlay" *ngIf="showAddCampaignModal">
  <div class="modal-content campaign-modal">
    <div class="modal-header">
      <h2>{{editingCampaign?._?.isNew() ? ((i18n.terms$ | async)?.newCampaign) : ((i18n.terms$ | async)?.editCampaign)}}</h2>
      <button class="modal-close" (click)="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.campaignName }} *</label>
          <input type="text" class="form-control"
                 [(ngModel)]="editingCampaign!.name"
                 [placeholder]="(i18n.terms$ | async)?.enterCampaignName">
        </div>

        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.financialTarget }} *</label>
          <input type="number" class="form-control"
                 [(ngModel)]="editingCampaign!.targetAmount"
                 placeholder="0">
        </div>

        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.currency }}</label>
          <select class="form-control" [(ngModel)]="editingCampaign!.currency" (change)="onLocationChange()">
            <option value="ILS">{{ (i18n.terms$ | async)?.shekelOption }}</option>
            <option value="USD">{{ (i18n.terms$ | async)?.dollarOption }}</option>
            <option value="EUR">{{ (i18n.terms$ | async)?.euroOption }}</option>
          </select>
        </div>

        <!-- New fields -->
        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.eventLocation }}</label>
          <input type="text" class="form-control"
                 [(ngModel)]="editingCampaign!.eventLocation"
                 (ngModelChange)="onLocationChange()"
                 [placeholder]="(i18n.terms$ | async)?.eventLocationPlaceholder">
        </div>

        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.campaignTypeLabel }}</label>
          <select class="form-control" [(ngModel)]="editingCampaign!.campaignType" (change)="onCampaignTypeChange()">
            <option value="×¨×’×™×œ">{{ (i18n.terms$ | async)?.campaignTypeRegular }}</option>
            <option value="×“×™× ×¢×¨">{{ (i18n.terms$ | async)?.campaignTypeDinner }}</option>
          </select>
        </div>

        <!-- Start Date with Hebrew-Gregorian picker -->
        <div class="form-group full-width">
          <app-modern-dual-date-picker
            [(ngModel)]="editingCampaign!.startDate"
            [label]="(i18n.terms$ | async)?.startDateLabel || ''"
            (dateChange)="onStartDateChange($event)">
          </app-modern-dual-date-picker>
        </div>

        <!-- End Date with Hebrew-Gregorian picker -->
        <div class="form-group full-width">
          <app-modern-dual-date-picker
            [(ngModel)]="editingCampaign!.endDate"
            [label]="(i18n.terms$ | async)?.endDateLabel || ''"
            (dateChange)="onEndDateChange($event)">
          </app-modern-dual-date-picker>
        </div>

        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="editingCampaign!.isActive"> {{ (i18n.terms$ | async)?.activeCampaign }}
          </label>
        </div>

        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.imageLink }}</label>
          <input type="url" class="form-control"
                 [(ngModel)]="editingCampaign!.imageUrl"
                 [placeholder]="(i18n.terms$ | async)?.imageLinkPlaceholder">
        </div>

        <div class="form-group">
          <label>{{ (i18n.terms$ | async)?.pageLink }}</label>
          <input type="url" class="form-control"
                 [(ngModel)]="editingCampaign!.websiteUrl"
                 [placeholder]="(i18n.terms$ | async)?.pageLinkPlaceholder">
        </div>

        <div class="form-group full-width">
          <label>{{ (i18n.terms$ | async)?.campaignDescription }}</label>
          <textarea class="form-control" rows="3"
                    [(ngModel)]="editingCampaign!.description"
                    [placeholder]="(i18n.terms$ | async)?.describeCampaignGoals"></textarea>
        </div>

        <div class="form-group full-width">
          <label>{{ (i18n.terms$ | async)?.internalNotes }}</label>
          <textarea class="form-control" rows="2"
                    [(ngModel)]="editingCampaign!.internalNotes"
                    [placeholder]="(i18n.terms$ | async)?.notesForTeam"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <!-- Action buttons for dinner campaigns -->
      <div class="action-buttons" *ngIf="editingCampaign?.campaignType === '×“×™× ×¢×¨' && editingCampaign && !editingCampaign._.isNew()">
        <button class="btn btn-info" (click)="openBlessingsBook()" [title]="(i18n.terms$ | async)?.blessingsBook">
          ğŸ“– {{ (i18n.terms$ | async)?.blessingsBookButton }}
        </button>
      </div>

      <!-- Regular action buttons -->
      <div class="action-buttons" *ngIf="editingCampaign && !editingCampaign._.isNew()">
        <button class="btn btn-outline-primary" (click)="openDonors()" [title]="(i18n.terms$ | async)?.donorsButton">
          ğŸ‘¥ {{ (i18n.terms$ | async)?.donorsButton }}
        </button>
        <button class="btn btn-outline-success" (click)="openContacts()" [title]="(i18n.terms$ | async)?.contactsActivists">
          ğŸ“ {{ (i18n.terms$ | async)?.contactsActivists }}
        </button>
      </div>

      <div class="main-buttons">
        <button class="btn btn-secondary" (click)="closeModal()">{{ (i18n.terms$ | async)?.cancel }}</button>
        <button class="btn btn-primary" (click)="saveCampaign()">{{ (i18n.terms$ | async)?.saveCampaign }}</button>
      </div>
    </div>
  </div>
</div>

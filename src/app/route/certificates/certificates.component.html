<div class="module-container">

  <!-- HEADER: Sticky top -->
  <div class="module-header">
    <div class="header-top">
      <h1>{{ (i18n.terms$ | async)?.certificatesAndMemorials }}</h1>
      <button class="btn btn-primary create-certificate-btn" (click)="openCreateModal()">{{ (i18n.terms$ | async)?.createNewCertificate }}</button>
    </div>

    <div class="certificate-types">
    <div class="type-card memorial-cert">
      <div class="card-icon">ğŸ•¯ï¸</div>
      <!-- <h3>{{ (i18n.terms$ | async)?.memorialCertificatesCard }}</h3>
      <p>{{ (i18n.terms$ | async)?.memorialCertDescription }}</p> -->
      <div class="stats stats-vertical">
        <span class="count">{{memorialCertificatesCount}}</span>
        <span class="label">{{ (i18n.terms$ | async)?.activeCertificatesMemorials }}</span>
      </div>
    </div>

    <div class="type-card memorial-cert">
      <div class="card-icon">ğŸ“…</div>
      <!-- <h3>{{ (i18n.terms$ | async)?.memorialDay }}</h3>
      <p>{{ (i18n.terms$ | async)?.memorialDayDescription }}</p> -->
      <div class="stats stats-vertical">
        <span class="count">{{memorialDayCertificatesCount}}</span>
        <span class="label">{{ (i18n.terms$ | async)?.activeCertificatesDay }}</span>
      </div>
    </div>
  </div>

  <div class="filters-section">
    <div class="filter-row">
      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.certificateType }}</label>
        <select class="form-control" [(ngModel)]="filterCertificateType" (ngModelChange)="onFilterChange()">
          <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
          <option value="memorial">{{ (i18n.terms$ | async)?.memorialCertificate }}</option>
          <option value="memorialDay">{{ (i18n.terms$ | async)?.memorialDay }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.dateFromFilter }}</label>
        <app-modern-dual-date-picker
          [(ngModel)]="filterDateFrom"
          [label]="(i18n.terms$ | async)?.dateFromFilter || ''"
          [compact]="true"
          [showOnlyHebrew]="true"
          (dateChange)="onFilterChange()">
        </app-modern-dual-date-picker>
      </div>

      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.dateToFilter }}</label>
        <app-modern-dual-date-picker
          [(ngModel)]="filterDateTo"
          [label]="(i18n.terms$ | async)?.dateToFilter || ''"
          [compact]="true"
          [showOnlyHebrew]="true"
          (dateChange)="onFilterChange()">
        </app-modern-dual-date-picker>
      </div>

      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.donorSearch }}</label>
        <input type="text" class="form-control"
               [placeholder]="(i18n.terms$ | async)?.donorNamePlaceholder"
               [(ngModel)]="donorSearchText"
               (ngModelChange)="onDonorSearchChange($event)">
      </div>

      <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.parasha }}</label>
        <select class="form-control" [(ngModel)]="filterFromParasha" (ngModelChange)="onFromParashaChange()">
          <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
          <option *ngFor="let parasha of parashotList" [value]="parasha">{{ parasha }}</option>
        </select>
      </div>

      <!-- <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.toParasha }}</label>
        <select class="form-control" [(ngModel)]="filterToParasha" (ngModelChange)="onToParashaChange()">
          <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
          <option *ngFor="let parasha of parashotList" [value]="parasha">{{ parasha }}</option>
        </select>
      </div> -->
    </div>
  </div>
  </div>

  <!-- CONTENT: Main scrollable area -->
  <div class="module-content">

    <!-- Table Body: Scrollable area -->
    <div class="table-body">
      <div class="loading-overlay" *ngIf="loading">
        <div class="spinner">×˜×•×¢×Ÿ...</div>
      </div>

      <table class="data-table">
      <thead>
        <tr>
          <th class="sortable" [class.sorted]="isSorted('recipientName')" (click)="toggleSort('recipientName', $event)">
            {{ (i18n.terms$ | async)?.donorRecipient }}
            <span class="sort-icon" *ngIf="getSortIcon('recipientName')">{{ getSortIcon('recipientName') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('type')" (click)="toggleSort('type', $event)">
            {{ (i18n.terms$ | async)?.certificateTypeHeader }}
            <span class="sort-icon" *ngIf="getSortIcon('type')">{{ getSortIcon('type') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('eventDate')" (click)="toggleSort('eventDate', $event)">
            {{ (i18n.terms$ | async)?.eventDate }}
            <span class="sort-icon" *ngIf="getSortIcon('eventDate')">{{ getSortIcon('eventDate') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('amount')" (click)="toggleSort('amount', $event)">
            {{ (i18n.terms$ | async)?.amountEvent }}
            <span class="sort-icon" *ngIf="getSortIcon('amount')">{{ getSortIcon('amount') }}</span>
          </th>
          <th>{{ (i18n.terms$ | async)?.nextReminderColumn }}</th>
          <th>{{ (i18n.terms$ | async)?.blessingsColumn }}</th>
          <th>{{ (i18n.terms$ | async)?.mainText }}</th>
          <th>{{ (i18n.terms$ | async)?.actionsHeaderCert }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let certificate of certificates">
          <td class="donor-name">
            <strong>{{certificate.recipientName}}</strong>
            <small *ngIf="certificate.donor">{{getDonorName(certificate)}}</small>
          </td>
          <td>
            <span class="cert-type-badge type-{{certificate.type}}">{{getCertificateTypeText(certificate)}}</span>
          </td>
          <td>
            <span class="event-date">{{ formatHebrewDate(certificate.eventDate) }}</span>
          </td>
          <td class="amount-col">
            <span class="amount" *ngIf="certificate.amount">â‚ª{{certificate.amount | number}}</span>
            <span class="event" *ngIf="certificate.eventName">{{ (i18n.terms$ | async)?.eventNameDisplay }}: {{certificate.eventName}}</span>
          </td>
          <td>{{getNextReminderDate(certificate)}}</td>
          <td>{{getBlessingCount(certificate)}}</td>
          <td class="text-col">
            <span class="special-text">{{certificate.mainText | slice:0:30}}<span *ngIf="certificate && certificate.mainText && certificate.mainText.length > 30">...</span></span>
          </td>
          <td class="actions">
            <!-- <button class="btn-icon btn-view" [title]="(i18n.terms$ | async)?.previewAction">ğŸ‘</button> -->
            <button class="btn-icon btn-edit" [title]="(i18n.terms$ | async)?.editAction" (click)="openEditModal(certificate)">âœ</button>
            <!-- <button class="btn-icon btn-reminder" [title]="certificate.reminderId ? ((i18n.terms$ | async)?.reminderExists) : ((i18n.terms$ | async)?.createReminderButton)" (click)="createReminder(certificate)">
              {{ certificate.reminderId ? 'ğŸ””' : 'ğŸ””â•' }}
            </button> -->
            <button class="btn-icon btn-delete" [title]="(i18n.terms$ | async)?.delete" (click)="deleteCertificate(certificate)">ğŸ—‘</button>
          </td>
        </tr>
        <tr *ngIf="!loading && certificates.length === 0">
          <td colspan="8" class="no-data">
            <p>{{ (i18n.terms$ | async)?.noDataFound }}</p>
          </td>
        </tr>
      </tbody>
    </table>
    </div>

    <!-- Table Footer: Sticky pagination -->
    <div class="table-footer">
    <div class="pagination-controls">
      <button
        class="btn-page"
        (click)="firstPage()"
        [disabled]="currentPage === 1 || loading">
        â® ×¨××©×•×Ÿ
      </button>

      <button
        class="btn-page"
        (click)="previousPage()"
        [disabled]="currentPage === 1 || loading">
        â† {{ (i18n.terms$ | async)?.previousPage }}
      </button>

      <div class="page-numbers">
        <button
          *ngFor="let page of getPageNumbers()"
          class="btn-page-number"
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
          [disabled]="loading">
          {{page}}
        </button>
      </div>

      <button
        class="btn-page"
        (click)="nextPage()"
        [disabled]="currentPage === totalPages || loading">
        {{ (i18n.terms$ | async)?.nextPage }} â†’
      </button>

      <button
        class="btn-page"
        (click)="lastPage()"
        [disabled]="currentPage === totalPages || loading">
        ××—×¨×•×Ÿ â­
      </button>
    </div>

    <div class="pagination-info">
      <span>××¦×™×’ {{(currentPage - 1) * pageSize + 1}} - {{Math.min(currentPage * pageSize, totalCount)}} ××ª×•×š {{totalCount}}</span>
    </div>
    </div>

  </div>

  <!-- FOOTER: Sticky bottom -->
  <div class="module-footer">
  </div>

</div>


<div class="module-container">

  <!-- HEADER: Sticky top - ×›×•×ª×¨×ª + ×›×¤×ª×•×¨ ×”×•×¡×¤×” + ×¤×™×œ×˜×¨×™× -->
  <div class="module-header">

    <!-- ×¡×™×›×•× ×›×¨×˜×™×¡×™× -->
    <div class="summary-cards">
      <div class="summary-card total">
        <div class="card-icon">ğŸ’°</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.totalDonationsSum }}</h3>
          <div class="currency-totals" [class.single-currency]="donationTotalsByCurrency.length <= 1">
            <div class="currency-row" *ngFor="let item of donationTotalsByCurrency">
              <span class="amount">{{ item.symbol }}{{ item.amount | number }}</span>
            </div>
            <div class="currency-row" *ngIf="donationTotalsByCurrency.length === 0">
              <span class="amount">-</span>
            </div>
          </div>
        </div>
      </div>
      <div class="summary-card donors">
        <div class="card-icon">ğŸ‘¥</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.numberOfDonations }}</h3>
          <span class="count">{{ totalFullDonationsCount }}</span>
        </div>
      </div>
      <div class="summary-card commitment">
        <div class="card-icon">ğŸ“‹</div>
        <div class="card-content">
          <h3>×¡×”"×› ×”×ª×—×™×™×‘×•×™×•×ª</h3>
          <div class="currency-totals" [class.single-currency]="commitmentTotalsByCurrency.length <= 1">
            <div class="currency-row" *ngFor="let item of commitmentTotalsByCurrency">
              <span class="amount commitment-amount">{{ item.paid | number }} / {{ item.symbol }}{{ item.total | number }}</span>
            </div>
            <div class="currency-row" *ngIf="commitmentTotalsByCurrency.length === 0">
              <span class="amount">-</span>
            </div>
          </div>
        </div>
      </div>
      <div class="summary-card commitment-count">
        <div class="card-icon">ğŸ”¢</div>
        <div class="card-content">
          <h3>××¡' ×”×ª×—×™×™×‘×•×™×•×ª</h3>
          <span class="count commitment-count-value">{{ totalCommitmentCount }}</span>
        </div>
      </div>
    </div>

    <!-- ×¤×™×œ×˜×¨×™× -->
    <div class="filters-section">
      <div class="filter-row">
        <div class="filter-group search-group">
          <input
            type="text"
            class="form-control"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onFilterChange()"
            [placeholder]="(i18n.terms$ | async)?.searchNameAddressPhone">
        </div>

        <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.dateFromFilter }}</label>
          <app-modern-dual-date-picker
            [(ngModel)]="dateFrom"
            [label]="(i18n.terms$ | async)?.dateFromFilter || ''"
            [compact]="true"
            [showOnlyHebrew]="true"
            (dateChange)="onFilterChange()">
          </app-modern-dual-date-picker>
        </div>

        <div class="filter-group">
        <label>{{ (i18n.terms$ | async)?.dateToFilter }}</label>
          <app-modern-dual-date-picker
            [(ngModel)]="dateTo"
            [label]="(i18n.terms$ | async)?.dateToFilter || ''"
            [compact]="true"
            [showOnlyHebrew]="true"
            (dateChange)="onFilterChange()">
          </app-modern-dual-date-picker>
        </div>

        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.donationMethodFilter }}</label>
          <select
            class="form-control"
            [(ngModel)]="selectedMethodId"
            (ngModelChange)="onFilterChange()">
            <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
            <option *ngFor="let method of donationMethods" [value]="method.id">{{ method.name }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.amountFromFilter }}</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="amountFrom"
            (ngModelChange)="onFilterChange()"
            placeholder="0">
        </div>

        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.campaignFilter }}</label>
          <select
            class="form-control"
            [(ngModel)]="selectedCampaignId"
            (ngModelChange)="onFilterChange()">
            <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
            <option *ngFor="let campaign of campaigns" [value]="campaign.id">{{ campaign.name }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.donationType }}</label>
          <select
            class="form-control"
            [(ngModel)]="selectedDonationType"
            (ngModelChange)="onFilterChange()">
            <option value="">{{ (i18n.terms$ | async)?.everything }}</option>
            <option value="full">{{ (i18n.terms$ | async)?.fullDonation }}</option>
            <option value="commitment">{{ (i18n.terms$ | async)?.commitment }}</option>
          </select>
        </div>

        <div class="filter-group filter-action">
          <button class="btn btn-primary add-donation-btn" (click)="createDonation()">
            {{ (i18n.terms$ | async)?.recordNewDonation }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENT: ××–×•×¨ ×”×ª×•×›×Ÿ ×”××¨×›×–×™ -->
  <div class="module-content">

    <!-- Table Body: Scrollable area -->
    <div class="table-body">
      <div class="loading-overlay" *ngIf="loading">
        <div class="spinner">×˜×•×¢×Ÿ...</div>
      </div>

      <table class="data-table">
      <thead>
        <tr>
          <th class="sortable" [class.sorted]="isSorted('donorName')" (click)="toggleSort('donorName', $event)">
            {{ (i18n.terms$ | async)?.donorColumn }}
            <span class="sort-icon" *ngIf="getSortIcon('donorName')">{{ getSortIcon('donorName') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('address')" (click)="toggleSort('address', $event)">
            {{ (i18n.terms$ | async)?.homeAddressColumn }}
            <span class="sort-icon" *ngIf="getSortIcon('address')">{{ getSortIcon('address') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('donationDate')" (click)="toggleSort('donationDate', $event)">
            {{ (i18n.terms$ | async)?.dateColumn }}
            <span class="sort-icon" *ngIf="getSortIcon('donationDate')">{{ getSortIcon('donationDate') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('donationType')" (click)="toggleSort('donationType', $event)">
            {{ (i18n.terms$ | async)?.donationType }}
            <span class="sort-icon" *ngIf="getSortIcon('donationType')">{{ getSortIcon('donationType') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('method')" (click)="toggleSort('method', $event)">
            {{ (i18n.terms$ | async)?.methodColumn }}
            <span class="sort-icon" *ngIf="getSortIcon('method')">{{ getSortIcon('method') }}</span>
          </th>
          <!-- <th class="sortable" [class.sorted]="isSorted('amountInShekel')" (click)="toggleSort('amountInShekel', $event)">
            {{ (i18n.terms$ | async)?.amountInShekelColumn }}
            <span class="sort-icon" *ngIf="getSortIcon('amountInShekel')">{{ getSortIcon('amountInShekel') }}</span>
          </th> -->
          <th class="sortable" [class.sorted]="isSorted('amount')" (click)="toggleSort('amount', $event)">
            {{ (i18n.terms$ | async)?.amountColumn }}
            <span class="sort-icon" *ngIf="getSortIcon('amount')">{{ getSortIcon('amount') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('currency')" (click)="toggleSort('currency', $event)">
            {{ (i18n.terms$ | async)?.currencyColumn }}
            <span class="sort-icon" *ngIf="getSortIcon('currency')">{{ getSortIcon('currency') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('campaign')" (click)="toggleSort('campaign', $event)">
            {{ (i18n.terms$ | async)?.campaign }}
            <span class="sort-icon" *ngIf="getSortIcon('campaign')">{{ getSortIcon('campaign') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('fundraiser')" (click)="toggleSort('fundraiser', $event)">
            {{ (i18n.terms$ | async)?.fundraiserColumn }}
            <span class="sort-icon" *ngIf="getSortIcon('fundraiser')">{{ getSortIcon('fundraiser') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('reason')" (click)="toggleSort('reason', $event)">
            {{ (i18n.terms$ | async)?.reason }}
            <span class="sort-icon" *ngIf="getSortIcon('reason')">{{ getSortIcon('reason') }}</span>
          </th>
          <th class="actions-header">
            <div class="actions-header-content">
              <span>{{ (i18n.terms$ | async)?.actionsColumn }}</span>
              <div class="header-buttons">
                <button class="btn-icon-header" (click)="refreshData()" [title]="'×¨×¢× ×•×Ÿ'">
                  <mat-icon>refresh</mat-icon>
                </button>
                <button class="btn-icon-header" (click)="onPrint()" [title]="'×”×“×¤×¡×”'">
                  <mat-icon>print</mat-icon>
                </button>
                <button class="btn-icon-header btn-excel" (click)="onExport()" [title]="'×™×™×¦×•× ×œ××§×¡×œ'">
                  <span class="excel-x">X</span>
                </button>
              </div>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let donation of donations">
          <td class="donor-name">
            <a class="donor-link" (click)="openDonorDetails(donation); $event.stopPropagation()">
              {{ getDonorName(donation) }}
            </a>
          </td>
          <td class="donor-address">{{ getDonorHomeAddress(donation) }}</td>
          <td>{{ formatHebrewDate(donation.donationDate) }}</td>
          <td>
            <span [class.commitment-highlight]="donation.donationType === 'commitment'">
              {{ getDonationTypeDisplay(donation) }}
            </span>
          </td>
          <td>
            <span class="method-badge method-{{donation.donationMethod?.type}}">{{ getMethodName(donation) }}</span>
          </td>
          <!-- <td class="amount">{{ formatAmountInShekel(donation) }}</td> -->
          <td class="amount" [class.commitment-highlight]="donation.donationType === 'commitment'">
            <div>{{ getAmountDisplay(donation) }}</div>
          </td>
          <td>{{ currencyTypes[donation.currencyId]?.symbol }}</td>
          <td>{{ getCampaignName(donation) }}</td>
          <td>{{ donation.donor?.fundraiser?.name || '-' }}</td>
          <td class="reason-cell" [title]="donation.reason || ''">{{ truncateReason(donation.reason) }}</td>
          <td class="actions">
            <button class="btn-icon btn-letter" (click)="printLetter(donation)"
              [title]="(i18n.terms$ | async)?.letterGeneration">âœ‰</button>
            <!-- <mat-divider vertical></mat-divider> -->
            <button class="btn-icon btn-edit" (click)="editDonation(donation)"
              [title]="(i18n.terms$ | async)?.edit">âœ</button>
            <button class="btn-icon btn-delete" (click)="deleteDonation(donation)"
              [title]="(i18n.terms$ | async)?.delete">ğŸ—‘</button>
          </td>
        </tr>
        <tr *ngIf="!loading && donations.length === 0">
          <td colspan="12" class="no-data">
            <p>{{ (i18n.terms$ | async)?.noDataFound }}</p>
          </td>
        </tr>
      </tbody>
    </table>
    </div>

    <!-- Table Footer: Sticky bottom - Pagination -->
    <div class="table-footer">
      <div class="pagination-info">
        <span>{{ (i18n.terms$ | async)?.showing }} {{(currentPage - 1) * pageSize + 1}} - {{Math.min(currentPage * pageSize, totalCount)}} {{ (i18n.terms$ | async)?.of }} {{totalCount}}</span>
      </div>

      <div class="pagination-controls">
        <button
          class="btn-page"
          (click)="firstPage()"
          [disabled]="currentPage === 1 || loading">
          {{ (i18n.terms$ | async)?.first }} â­
        </button>

        <button
          class="btn-page"
          (click)="previousPage()"
          [disabled]="currentPage === 1 || loading">
          {{ (i18n.terms$ | async)?.previous }} â†’
        </button>

        <div class="page-numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            class="btn-page-number"
            [class.active]="page === currentPage"
            (click)="goToPage(page)"
            [disabled]="loading">
            {{page}}
          </button>
        </div>

        <button
          class="btn-page"
          (click)="nextPage()"
          [disabled]="currentPage === totalPages || loading">
          â† {{ (i18n.terms$ | async)?.next }}
        </button>

        <button
          class="btn-page"
          (click)="lastPage()"
          [disabled]="currentPage === totalPages || loading">
          â® {{ (i18n.terms$ | async)?.last }}
        </button>
      </div>
    </div>
  </div>

  <!-- FOOTER: Sticky bottom - (×¨×™×§ ×›×¨×’×¢, ×œ×¢×ª×™×“) -->
  <div class="module-footer">
    <!-- ××§×•× ×œ×¡×™×›×•××™×, ×¡×˜×˜×™×¡×˜×™×§×•×ª, ×•×›×•' -->
  </div>

</div>

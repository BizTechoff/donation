<div class="module-container">

  <!-- HEADER: Sticky top -->
  <div class="module-header">
    <div class="header-top">
      <h1>{{ (i18n.terms$ | async)?.donorGifts }}</h1>
      <div class="header-actions">
        <button class="btn btn-secondary manage-catalog-btn" (click)="manageGiftCatalog()">
          {{ (i18n.terms$ | async)?.manageGiftCatalog }}
        </button>
        <button class="btn btn-primary add-btn" (click)="createDonorGift()">
          {{ (i18n.terms$ | async)?.addGiftToDonor }}
        </button>
      </div>
    </div>

    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon">üéÅ</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.totalGifts }}</h3>
          <span class="count">{{ totalCount }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon">üì¶</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.deliveredGifts }}</h3>
          <span class="count">{{ deliveredCount }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon">‚è≥</div>
        <div class="card-content">
          <h3>{{ (i18n.terms$ | async)?.pendingGifts }}</h3>
          <span class="count">{{ pendingCount }}</span>
        </div>
      </div>
    </div>

    <div class="filters-section">
      <div class="filter-row">
        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.searchDonor }}</label>
          <input type="text" class="form-control"
                 [(ngModel)]="searchDonorName"
                 (ngModelChange)="applyFilters()"
                 [placeholder]="(i18n.terms$ | async)?.donorNamePlaceholder">
        </div>

        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.donor }}</label>
          <div class="donor-filter-field">
            <input type="text" class="form-control"
                   [value]="selectedDonor ? (selectedDonor.firstName + ' ' + selectedDonor.lastName) : ''"
                   [placeholder]="(i18n.terms$ | async)?.allDonors || '◊õ◊ú ◊î◊™◊ï◊®◊û◊ô◊ù'"
                   readonly
                   (click)="openDonorSelectionModal()">
            <button mat-icon-button (click)="openDonorSelectionModal()" [title]="(i18n.terms$ | async)?.searchDonorTitle">
              <mat-icon>search</mat-icon>
            </button>
            <button mat-icon-button *ngIf="selectedDonor" (click)="clearDonorFilter()" [title]="(i18n.terms$ | async)?.clearFilterTitle">
              <mat-icon>clear</mat-icon>
            </button>
          </div>
        </div>

        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.giftType }}</label>
          <select class="form-control" [(ngModel)]="selectedGiftId" (ngModelChange)="applyFilters()">
            <option value="">{{ (i18n.terms$ | async)?.allGifts }}</option>
            <option *ngFor="let gift of gifts" [value]="gift.id">
              {{ gift.name }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>{{ (i18n.terms$ | async)?.year }}</label>
          <select class="form-control" [(ngModel)]="selectedYear" (ngModelChange)="applyFilters()">
            <option value="">{{ (i18n.terms$ | async)?.allYears }}</option>
            <option *ngFor="let year of years" [value]="year">{{ year }}</option>
          </select>
        </div>

        <!-- <div class="filter-group">
          <button class="btn btn-secondary" (click)="clearFilters()">
            {{ (i18n.terms$ | async)?.clearFilters }}
          </button>
        </div> -->
      </div>
    </div>
  </div>

  <!-- CONTENT: Main scrollable area -->
  <div class="module-content">

    <!-- Table Body: Scrollable area -->
    <div class="table-body">
      <div class="loading-overlay" *ngIf="loading">
        <div class="spinner">{{ (i18n.terms$ | async)?.loading }}</div>
      </div>

      <table class="data-table">
      <thead>
        <tr>
          <th class="sortable" [class.sorted]="isSorted('donor')" (click)="toggleSort('donor', $event)">
            {{ (i18n.terms$ | async)?.donor }}
            <span class="sort-icon">{{ getSortIcon('donor') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('gift')" (click)="toggleSort('gift', $event)">
            {{ (i18n.terms$ | async)?.gift }}
            <span class="sort-icon">{{ getSortIcon('gift') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('deliveryDate')" (click)="toggleSort('deliveryDate', $event)">
            {{ (i18n.terms$ | async)?.deliveryDate }}
            <span class="sort-icon">{{ getSortIcon('deliveryDate') }}</span>
          </th>
          <th class="sortable" [class.sorted]="isSorted('isDelivered')" (click)="toggleSort('isDelivered', $event)">
            {{ (i18n.terms$ | async)?.status }}
            <span class="sort-icon">{{ getSortIcon('isDelivered') }}</span>
          </th>
          <th>{{ (i18n.terms$ | async)?.notes }}</th>
          <th>{{ (i18n.terms$ | async)?.actions }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let donorGift of donorGifts">
          <td>{{ getDonorName(donorGift) }}</td>
          <td>{{ donorGift.gift?.name || '-' }}</td>
          <td>{{ formatHebrewDate(donorGift.deliveryDate) }}</td>
          <td>
            <span class="status-badge" [class.delivered]="donorGift.isDelivered" [class.pending]="!donorGift.isDelivered">
              {{ donorGift.isDelivered ? (i18n.terms$ | async)?.delivered : (i18n.terms$ | async)?.pending }}
            </span>
          </td>
          <td>{{ donorGift.notes || '-' }}</td>
          <td class="actions" (click)="$event.stopPropagation()">
            <button class="btn-icon btn-edit" (click)="editDonorGift(donorGift)" [title]="(i18n.terms$ | async)?.edit">‚úè</button>
            <button class="btn-icon btn-delete" (click)="deleteDonorGift(donorGift)" [title]="(i18n.terms$ | async)?.delete">üóë</button>
          </td>
        </tr>
        <tr *ngIf="!loading && donorGifts.length === 0">
          <td colspan="6" class="no-data">
            <p>{{ (i18n.terms$ | async)?.noGiftsFound }}</p>
          </td>
        </tr>
      </tbody>
    </table>
    </div>

    <!-- Table Footer: Sticky pagination -->
    <div class="table-footer">
      <div class="pagination-controls">
        <button
          class="btn-page"
          (click)="firstPage()"
          [disabled]="currentPage === 1 || loading">
          ‚èÆ {{ (i18n.terms$ | async)?.first }}
        </button>

        <button
          class="btn-page"
          (click)="previousPage()"
          [disabled]="currentPage === 1 || loading">
          ‚Üê {{ (i18n.terms$ | async)?.previous }}
        </button>

        <div class="page-numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            class="btn-page-number"
            [class.active]="page === currentPage"
            [disabled]="page === -1"
            (click)="page !== -1 && goToPage(page)">
            {{ page === -1 ? '...' : page }}
          </button>
        </div>

        <button
          class="btn-page"
          (click)="nextPage()"
          [disabled]="currentPage === totalPages || loading">
          {{ (i18n.terms$ | async)?.next }} ‚Üí
        </button>

        <button
          class="btn-page"
          (click)="lastPage()"
          [disabled]="currentPage === totalPages || loading">
          {{ (i18n.terms$ | async)?.last }} ‚è≠
        </button>
      </div>

      <div class="pagination-info">
        <span>{{ (i18n.terms$ | async)?.showing }} {{(currentPage - 1) * pageSize + 1}} - {{Math.min(currentPage * pageSize, totalCount)}} {{ (i18n.terms$ | async)?.of }} {{totalCount}}</span>
      </div>
    </div>
  </div>

</div>

<div class="module-container" [attr.dir]="i18n.lang.RTL ? 'rtl' : 'ltr'" [class.fullscreen]="isFullscreen">

  <!-- HEADER: Sticky top -->
  <div class="module-header">
    <div class="header-top">
      <h1>{{ i18n.terms.mapTitle }}</h1>
      <div class="map-controls">
        <button class="btn btn-primary" (click)="refreshMap()">{{ i18n.terms.refreshMap }}</button>
        <button class="btn btn-polygon"
                (click)="togglePolygonMode()"
                [class.active]="isPolygonMode"
                [matTooltip]="isPolygonMode ? '爪 爪 爪专 驻' : '爪专 驻 注 驻'"
                *ngIf="isFullscreen">
          <mat-icon>pentagon</mat-icon>
        </button>
        <!-- <button class="btn btn-info" (click)="geocodeMissingAddresses()" [disabled]="loading">{{ i18n.terms.convertAddresses }}</button> -->
        <button class="btn btn-fullscreen" (click)="toggleFullscreen()" [matTooltip]="isFullscreen ? '爪 住 ' : '住 '">
          <mat-icon>{{ isFullscreen ? 'fullscreen_exit' : 'fullscreen' }}</mat-icon>
        </button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon"></div>
        <div class="card-content">
          <h3>{{ i18n.terms.totalDonors }}</h3>
          <span class="count">{{ totalDonors }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon"></div>
        <div class="card-content">
          <h3>{{ i18n.terms.activeDonors }}</h3>
          <span class="count">{{ activeDonors }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon"></div>
        <div class="card-content">
          <h3>{{ i18n.terms.mapAverageDonation }}</h3>
          <span class="count">{{ averageDonation | number:'1.0-0' }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon"></div>
        <div class="card-content">
          <h3>{{ i18n.terms.donorsOnMap }}</h3>
          <span class="count">{{ donorsOnMap }}</span>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filter-row">
        <!-- Status Filter -->
        <!-- <div class="filter-group">
          <label>{{ i18n.terms.filterByStatus || '住 驻 住住' }}</label>
          <div class="status-chips">
            <div *ngFor="let option of statusOptions"
                 class="status-chip"
                 [class.selected]="mapFilters.statusFilter.includes(option.value)"
                 (click)="toggleStatusFilter(option.value)">
              <div class="chip-color" [style.background-color]="option.color"></div>
              <span>{{ option.label }}</span>
            </div>
          </div>
        </div> -->

        <!-- Search Filter -->
        <div class="filter-group">
          <label>{{ i18n.terms.search || '驻砖' }}</label>
          <input type="text"
                 class="form-control"
                 [(ngModel)]="mapFilters.searchTerm"
                 (ngModelChange)="onFilterChange()"
                 [placeholder]="i18n.terms.searchDonorNameAddress || '驻砖 驻 砖  转转'">
        </div>

        <!-- Coordinates Filter -->
        <!-- <div class="filter-group">
          <label>{{ i18n.terms.filterByLocation || '拽' }}</label>
          <select class="form-control" [(ngModel)]="mapFilters.hasCoordinates" (ngModelChange)="onFilterChange()">
            <option [ngValue]="null">{{ i18n.terms.all || '' }}</option>
            <option [ngValue]="true">{{ i18n.terms.withCoordinates || '注 拽专转' }}</option>
            <option [ngValue]="false">{{ i18n.terms.withoutCoordinates || ' 拽专转' }}</option>
          </select>
        </div> -->

        <!-- Donation Count Filter -->
        <div class="filter-group">
          <label>{{ i18n.terms.minDonationCount || ' 转专转' }}</label>
          <input type="number"
                 class="form-control"
                 min="0"
                 [(ngModel)]="mapFilters.minDonationCount"
                 (ngModelChange)="onFilterChange()">
        </div>

        <!-- Clear Filters Button -->
        <!-- <div class="filter-group">
          <button class="btn btn-secondary" (click)="clearMapFilters()" [disabled]="!hasActiveFilters()">
            {{ i18n.terms.clearFilters || '拽 驻专' }}
          </button>
        </div> -->
      </div>

      <!-- Results Counter -->
      <div class="results-counter">
        {{ i18n.terms.showing || '爪' }}:
        <strong>{{ donorsOnMap }}</strong>
        {{ i18n.terms.outOf || '转' }}
        <strong>{{ totalDonors }}</strong>
        {{ i18n.terms.donors || '转专' }}
      </div>
    </div>
  </div>

  <!-- CONTENT: Main scrollable area -->
  <div class="module-content">
    <!-- Map Container - Full screen -->
    <div class="map-container">
      <div id="donors-map" class="leaflet-map" #mapElement></div>

      <!-- Color legend - always visible on map -->
      <div class="map-legend">
        <h4>{{ i18n.terms.legend }}</h4>
        <div class="legend-items">
          <div *ngFor="let option of statusOptions"
               class="legend-item"
               [class.selected]="mapFilters.statusFilter.includes(option.value)"
               (click)="toggleStatusFilter(option.value)">
            <div class="legend-color" [style.background-color]="option.color"></div>
            <span>{{ option.label }}</span>
          </div>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div *ngIf="loading" class="loading-overlay">
        <div class="loading-spinner">{{ i18n.terms.loadingMap }}</div>
      </div>
    </div>
  </div>

</div>

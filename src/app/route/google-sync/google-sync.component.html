<div class="user-details-container">
  <h2>Google Contacts - סנכרון אנשי קשר</h2>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-section">
    <mat-spinner diameter="32"></mat-spinner>
    <span>טוען...</span>
  </div>

  <!-- Error -->
  <div *ngIf="errorMessage" class="error-section">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage }}</span>
    <button mat-icon-button (click)="errorMessage = ''">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Not Connected -->
  <mat-card *ngIf="!loading && !status.isConnected" class="connect-card">
    <mat-card-header>
      <mat-icon mat-card-avatar class="google-icon">contacts</mat-icon>
      <mat-card-title>חיבור Google Contacts</mat-card-title>
      <mat-card-subtitle>סנכרון דו-צדדי של תורמים עם Google Contacts</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <p>חבר את חשבון Google שלך כדי לסנכרן את התורמים באופן אוטומטי עם Google Contacts.</p>
      <ul>
        <li>כל התורמים יתווספו לקבוצה ייעודית "Donation Platform"</li>
        <li>שינויים בפלטפורמה יעודכנו ב-Google ולהיפך</li>
        <li>סנכרון אוטומטי כל 6 שעות</li>
      </ul>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="connectGoogle()">
        <mat-icon>link</mat-icon>
        חבר חשבון Google
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Connected -->
  <div *ngIf="!loading && status.isConnected" class="connected-section">
    <!-- Status Card -->
    <mat-card class="status-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="connected-icon">check_circle</mat-icon>
        <mat-card-title>מחובר</mat-card-title>
        <mat-card-subtitle>{{ status.googleEmail }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <p *ngIf="status.lastSyncedAt">סנכרון אחרון: {{ status.lastSyncedAt | date:'dd/MM/yyyy HH:mm' }}</p>
        <p *ngIf="!status.lastSyncedAt">טרם בוצע סנכרון</p>
      </mat-card-content>
      <mat-card-actions>
        <button mat-raised-button color="warn" (click)="disconnectGoogle()">
          <mat-icon>link_off</mat-icon>
          נתק חשבון
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Sync Controls -->
    <mat-card class="sync-card">
      <mat-card-header>
        <mat-card-title>סנכרון ידני</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field>
          <mat-label>פתרון קונפליקטים</mat-label>
          <mat-select [(value)]="conflictResolution">
            <mat-option value="platform_wins">הפלטפורמה מנצחת</mat-option>
            <mat-option value="google_wins">Google מנצח</mat-option>
            <mat-option value="newest_wins">העדכני מנצח</mat-option>
            <mat-option value="manual">ידני (סימון קונפליקט)</mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-content>
      <mat-card-actions>
        <button mat-raised-button color="primary" (click)="triggerSync()" [disabled]="syncing">
          <mat-icon *ngIf="!syncing">sync</mat-icon>
          <mat-spinner *ngIf="syncing" diameter="20"></mat-spinner>
          {{ syncing ? 'מסנכרן...' : 'סנכרן עכשיו' }}
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Sync Result -->
    <mat-card *ngIf="lastSyncResult" class="result-card" [class.success]="lastSyncResult.success" [class.error]="!lastSyncResult.success">
      <mat-card-header>
        <mat-card-title>תוצאות סנכרון</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="result-stats">
          <div class="stat">
            <span class="stat-value">{{ lastSyncResult.donorsPushed }}</span>
            <span class="stat-label">נשלחו ל-Google</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ lastSyncResult.contactsPulled }}</span>
            <span class="stat-label">נמשכו מ-Google</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ lastSyncResult.conflicts }}</span>
            <span class="stat-label">קונפליקטים</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ lastSyncResult.errors }}</span>
            <span class="stat-label">שגיאות</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ (lastSyncResult.duration / 1000).toFixed(1) }}s</span>
            <span class="stat-label">משך</span>
          </div>
        </div>
        <div *ngIf="lastSyncResult.errorDetails.length" class="error-details">
          <h4>פרטי שגיאות:</h4>
          <ul>
            <li *ngFor="let err of lastSyncResult.errorDetails">{{ err }}</li>
          </ul>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Sync Logs -->
    <mat-card *ngIf="syncLogs.length" class="logs-card">
      <mat-card-header>
        <mat-card-title>היסטוריית סנכרונים</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="syncLogs" class="logs-table">
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>תאריך</th>
            <td mat-cell *matCellDef="let log">{{ log.createdDate | date:'dd/MM/yyyy HH:mm' }}</td>
          </ng-container>
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>סוג</th>
            <td mat-cell *matCellDef="let log">{{ log.syncType === 'manual' ? 'ידני' : log.syncType === 'scheduled' ? 'מתוזמן' : 'ראשוני' }}</td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>סטטוס</th>
            <td mat-cell *matCellDef="let log">
              <mat-icon [class]="log.status">{{ log.status === 'completed' ? 'check_circle' : log.status === 'failed' ? 'error' : 'hourglass_empty' }}</mat-icon>
            </td>
          </ng-container>
          <ng-container matColumnDef="pushed">
            <th mat-header-cell *matHeaderCellDef>נשלחו</th>
            <td mat-cell *matCellDef="let log">{{ log.donorsPushed }}</td>
          </ng-container>
          <ng-container matColumnDef="pulled">
            <th mat-header-cell *matHeaderCellDef>נמשכו</th>
            <td mat-cell *matCellDef="let log">{{ log.contactsPulled }}</td>
          </ng-container>
          <ng-container matColumnDef="duration">
            <th mat-header-cell *matHeaderCellDef>משך</th>
            <td mat-cell *matCellDef="let log">{{ (log.duration / 1000).toFixed(1) }}s</td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="['date', 'type', 'status', 'pushed', 'pulled', 'duration']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['date', 'type', 'status', 'pushed', 'pulled', 'duration'];"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>
</div>

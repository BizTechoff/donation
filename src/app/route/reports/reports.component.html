<div class="reports-container">


  <!-- ×ª×¤×¨×™×˜ ×˜××‘×™× -->
  <div class="reports-tabs-wrapper" *ngIf="!isExpandedView">
    <div class="reports-tabs">
      <button class="tab-button" [class.active]="activeReport === 'donations'" (click)="switchReport('donations')">
        <span class="tab-icon">ğŸ’°</span>
        {{ (i18n.terms$ | async)?.donationsReport }}
      </button>
      <button class="tab-button" [class.active]="activeReport === 'payments'" (click)="switchReport('payments')">
        <span class="tab-icon">ğŸ’³</span>
        {{ (i18n.terms$ | async)?.paymentsReport }}
      </button>
      <button class="tab-button" [class.active]="activeReport === 'yearly'" (click)="switchReport('yearly')">
        <span class="tab-icon">ğŸ“…</span>
        {{ (i18n.terms$ | async)?.yearlySummaryReport }}
      </button>
      <button class="tab-button" [class.active]="activeReport === 'blessings'" (click)="switchReport('blessings')">
        <span class="tab-icon">ğŸ“–</span>
        {{ (i18n.terms$ | async)?.blessingsReport }}
      </button>
      <button class="tab-button" [class.active]="activeReport === 'personalDonor'"
        (click)="switchReport('personalDonor')">
        <span class="tab-icon">ğŸ‘¤</span>
        ×“×•×— ××™×©×™ ×œ×ª×•×¨×
      </button>
    </div>

    <div class="header-actions">
      <button class="btn btn-secondary" (click)="refreshData()">
        <span class="btn-icon">ğŸ”„</span>
        {{ (i18n.terms$ | async)?.refreshData }}
      </button>
      <button class="btn btn-outline" (click)="exportSpecificReport('excel')">
        <span class="btn-icon">ğŸ“Š</span>
        Excel
      </button>
    </div>
  </div>

  <!-- ××¡× ×Ÿ ×ª××¨×™×›×™× - ×¨×§ ×œ×“×•×— ×”×›×œ×œ×™ -->
  <div class="date-filter" *ngIf="activeReport === 'general'">
    <div class="filter-group">
      <label>{{ (i18n.terms$ | async)?.dateFrom }}</label>
      <input type="date" class="form-control" [(ngModel)]="dateRange.from" (change)="onDateRangeChange()">
    </div>
    <div class="filter-group">
      <label>{{ (i18n.terms$ | async)?.dateTo }}</label>
      <input type="date" class="form-control" [(ngModel)]="dateRange.to" (change)="onDateRangeChange()">
    </div>
  </div>

  <!-- ××¡× × ×™× ×¡×¤×¦×™×¤×™×™× ×œ×“×•×—×•×ª -->
  <div class="specific-filters" *ngIf="activeReport !== 'general'">
    <!-- ×›×¤×ª×•×¨ ×”×¨×—×‘×” -->
    <button class="expand-toggle-btn" (click)="toggleExpandedView()"
      [matTooltip]="isExpandedView ? '×ª×¦×•×’×” ×¨×’×™×œ×”' : '×”×¨×—×‘ ×“×•×—'" [dir]="'rtl'">
      <mat-icon>{{ isExpandedView ? 'fullscreen_exit' : 'fullscreen' }}</mat-icon>
    </button>

    <div class="filter-row">

      <!-- ×¡×•×’ ×§×™×‘×•×¥ -->
      <div class="filter-group" *ngIf="activeReport === 'donations'">
        <label>×§×™×‘×•×¥ ×œ×¤×™</label>
        <select class="form-control" [(ngModel)]="filters.groupBy" (ngModelChange)="applyFilters()">
          <option value="donor">×ª×•×¨×</option>
          <option value="campaign">×§××¤×™×™×Ÿ</option>
          <option value="paymentMethod">×××¦×¢×™ ×ª×©×œ×•×</option>
          <option value="fundraiser">××ª×¨×™×</option>
        </select>
      </div>

      <!-- ××¡× ×Ÿ ×©× ×™× -->
      <div class="filter-group" *ngIf="activeReport === 'donations' || activeReport === 'yearly'">
        <label>{{ (i18n.terms$ | async)?.filterByYears }}</label>
        <select class="form-control" [(ngModel)]="filters.selectedYear" (ngModelChange)="applyFilters()">
          <option value="last4">4 ×©× ×™× ××—×•×¨× ×•×ª</option>
          <option *ngFor="let year of availableYears" [value]="year">{{year}}</option>
        </select>
      </div>

      <!-- ××¡× ×Ÿ ×‘×—×™×¨×ª ×ª×•×¨××™× (××©×•×ª×£ ×œ×ª×¨×•××•×ª ×•×ª×©×œ×•××™×) -->
      <div class="filter-group donor-filter-group" *ngIf="activeReport === 'donations' || activeReport === 'payments'">
        <label>{{ (i18n.terms$ | async)?.filterByDonor }}</label>
        <div class="donor-filter-input-wrapper">
          <input type="text" class="form-control donor-filter-input" [value]="getSelectedDonorsText()" readonly
            (click)="openDonorSelectionModal()" [placeholder]="(i18n.terms$ | async)?.clickToSelectDonorsPlaceholder">
          <button class="donor-filter-search-btn" (click)="openDonorSelectionModal()"
            [matTooltip]="(i18n.terms$ | async)?.selectDonorsTooltip" [dir]="'rtl'">
            <mat-icon>search</mat-icon>
          </button>
          <button *ngIf="filters.selectedDonorIds.length > 0" class="donor-filter-clear-btn"
            (click)="clearSelectedDonors(); $event.stopPropagation()" [matTooltip]="'× ×§×” ×‘×—×™×¨×”'" [dir]="'rtl'">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </div>

      <!-- ××¡× ×Ÿ ×§××¤×™×™×Ÿ - ×‘×“×•×— ×ª×¨×•××•×ª -->
      <div class="filter-group" *ngIf="activeReport === 'donations'">
        <label>{{ (i18n.terms$ | async)?.filterByCampaign }}</label>
        <select class="form-control" [(ngModel)]="filters.selectedCampaign" (ngModelChange)="applyFilters()">
          <option value="">{{ (i18n.terms$ | async)?.all }}</option>
          <option *ngFor="let campaign of availableCampaigns" [value]="campaign.id">{{campaign.name}}</option>
        </select>
      </div>

      <!-- ××¡× ×Ÿ ×§××¤×™×™×Ÿ - ×‘×“×•×— ×‘×¨×›×•×ª (××•×“×œ ×‘×—×™×¨×”) -->
      <div class="filter-group donor-filter-group" *ngIf="activeReport === 'blessings'">
        <label>{{ (i18n.terms$ | async)?.campaign }}</label>
        <div class="donor-filter-input-wrapper">
          <input type="text" class="form-control donor-filter-input" [value]="getSelectedCampaignText()" readonly
            (click)="openCampaignSelectionModal()" [placeholder]="(i18n.terms$ | async)?.selectCampaignTitle">
          <button class="donor-filter-search-btn" (click)="openCampaignSelectionModal()"
            [matTooltip]="(i18n.terms$ | async)?.selectCampaignTooltip" [dir]="'rtl'">
            <mat-icon>search</mat-icon>
          </button>
          <button *ngIf="filters.selectedCampaign" class="donor-filter-clear-btn"
            (click)="clearSelectedCampaign(); $event.stopPropagation()" [matTooltip]="'× ×§×” ×‘×—×™×¨×”'" [dir]="'rtl'">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </div>

      <!-- ××¤×©×¨×•×™×•×ª ×ª×¦×•×’×” -->
      <div class="display-options" *ngIf="activeReport === 'donations'">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="filters.showDonorDetails" (ngModelChange)="applyFilters()">
          ×”×¦×’ ×¤×¨×˜×™ ×ª×•×¨×
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="filters.showActualPayments" (ngModelChange)="applyFilters()">
          ×”×¦×’ ×ª×¨×•××•×ª ×‘×¤×•×¢×œ
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="filters.showCurrencySummary" (ngModelChange)="applyFilters()">
          ×”×¦×’ ×¡×™×›×•× ××˜×‘×¢×•×ª
        </label>
      </div>
    </div>
  </div>

  <!-- ×ª×•×›×Ÿ ×”×“×•×—×•×ª -->
  <div class="reports-content">

    <!-- ×“×•×— ×›×œ×œ×™ -->
    <div *ngIf="activeReport === 'general'" class="general-report">

      <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×•×ª -->
      <div class="stats-section">
        <h2>{{ (i18n.terms$ | async)?.generalStatistics }}</h2>
        <div class="stats-grid">
          <div class="stat-card total-donations">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-content">
              <h3>{{ (i18n.terms$ | async)?.totalDonationsAmount }}</h3>
              <div class="stat-number">{{formatCurrency(totalStats.amount)}}</div>
              <div class="stat-subtitle">{{totalStats.donations}} {{ (i18n.terms$ | async)?.donationsUnit }}</div>
            </div>
          </div>

          <div class="stat-card active-donors">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-content">
              <h3>{{ (i18n.terms$ | async)?.activeDonorsTitle }}</h3>
              <div class="stat-number">{{totalStats.donors}}</div>
              <div class="stat-subtitle">{{ (i18n.terms$ | async)?.registeredInSystemLabel }}</div>
            </div>
          </div>

          <div class="stat-card avg-donation">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-content">
              <h3>{{ (i18n.terms$ | async)?.averageDonation }}</h3>
              <div class="stat-number">{{formatCurrency(totalStats.avgDonation)}}</div>
              <div class="stat-subtitle">{{ (i18n.terms$ | async)?.perDonation }}</div>
            </div>
          </div>

          <div class="stat-card recurring-amount">
            <div class="stat-icon">ğŸ”„</div>
            <div class="stat-content">
              <h3>{{ (i18n.terms$ | async)?.fixedIncome }}</h3>
              <div class="stat-number">{{formatCurrency(totalStats.recurringAmount)}}</div>
              <div class="stat-subtitle">{{ (i18n.terms$ | async)?.monthly }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ××’××•×ª ×—×•×“×©×™×•×ª -->
      <div class="trends-section">
        <h2>{{ (i18n.terms$ | async)?.monthlyTrends }}</h2>
        <div class="chart-container">
          <div class="monthly-chart">
            <div class="chart-bars">
              <div *ngFor="let month of monthlyData" class="bar-group">
                <div class="bar donations-bar" [style.height.%]="(month.donations / getMaxDonations()) * 100"
                  [title]="month.donations + ' ' + (i18n.terms$ | async)?.donationsUnit">
                </div>
                <div class="bar amount-bar" [style.height.%]="(month.amount / getMaxAmount()) * 100"
                  [title]="formatCurrency(month.amount)">
                </div>
                <div class="bar-label">{{month.month}}</div>
              </div>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-color donations"></span>
                <span>{{ (i18n.terms$ | async)?.donationsAmount }}</span>
              </div>
              <div class="legend-item">
                <span class="legend-color amount"></span>
                <span>{{ (i18n.terms$ | async)?.donationsSum }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- × ×™×ª×•×— ×§××¤×™×™× ×™× -->
      <div class="campaigns-analysis">
        <h2>{{ (i18n.terms$ | async)?.campaignPerformance }}</h2>
        <div class="analysis-grid">
          <div class="chart-section">
            <h3>{{ (i18n.terms$ | async)?.donationDistributionByCampaign }}</h3>
            <div class="pie-chart-container">
              <div class="pie-chart">
                <div *ngFor="let campaign of campaignData.slice(0, 6); let i = index" class="pie-slice"
                  [style.--percentage]="campaign.percentage" [style.--color]="getPieColor(i)"
                  [title]="campaign.label + ': ' + formatCurrency(campaign.value)">
                </div>
              </div>
              <div class="pie-legend">
                <div *ngFor="let campaign of campaignData.slice(0, 6); let i = index" class="legend-item">
                  <span class="legend-color" [style.background-color]="getPieColor(i)"></span>
                  <span class="legend-text">{{campaign.label}}</span>
                  <span class="legend-value">{{formatPercentage(campaign.percentage!)}}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="top-campaigns">
            <h3>{{ (i18n.terms$ | async)?.topCampaigns }}</h3>
            <div class="campaigns-list">
              <div *ngFor="let campaign of topCampaigns" class="campaign-item">
                <div class="campaign-info">
                  <strong>{{campaign.name}}</strong>
                  <div class="campaign-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="getProgressPercentage(campaign)">
                      </div>
                    </div>
                    <span class="progress-text">
                      {{formatCurrency(campaign.raisedAmount)}} / {{formatCurrency(campaign.targetAmount)}}
                    </span>
                  </div>
                </div>
                <div class="campaign-percentage">
                  {{getProgressPercentage(campaign)}}%
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- × ×™×ª×•×— ×ª×•×¨××™× -->
      <div class="donors-analysis">
        <h2>{{ (i18n.terms$ | async)?.donorAnalysis }}</h2>
        <div class="analysis-grid">
          <div class="donor-types">
            <h3>{{ (i18n.terms$ | async)?.distributionByDonorType }}</h3>
            <div class="bar-chart">
              <div *ngFor="let type of donorTypeData" class="bar-item">
                <div class="bar-info">
                  <span class="bar-label">{{type.label}}</span>
                  <span class="bar-value">{{formatCurrency(type.value)}}</span>
                </div>
                <div class="bar-container">
                  <div class="bar-fill" [style.width.%]="type.percentage"></div>
                </div>
                <div class="bar-percentage">{{formatPercentage(type.percentage!)}}</div>
              </div>
            </div>
          </div>

          <div class="top-donors">
            <h3>{{ (i18n.terms$ | async)?.topDonors }}</h3>
            <div class="donors-list">
              <div *ngFor="let donorData of topDonors.slice(0, 8)" class="donor-item">
                <div class="donor-info">
                  <strong>{{donorData.donor.fullName}}</strong>
                  <small>{{donorData.count}} {{ (i18n.terms$ | async)?.donationsUnit }}</small>
                </div>
                <div class="donor-amount">{{formatCurrency(donorData.total)}}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- × ×™×ª×•×— ×’×™××•×’×¨×¤×™ -->
      <div class="geographic-analysis" *ngIf="regionData.length > 0">
        <h2>{{ (i18n.terms$ | async)?.geographicDistribution }}</h2>
        <div class="regions-chart">
          <div *ngFor="let region of regionData" class="region-item">
            <div class="region-info">
              <span class="region-name">{{region.label}}</span>
              <span class="region-amount">{{formatCurrency(region.value)}}</span>
            </div>
            <div class="region-bar">
              <div class="bar-fill" [style.width.%]="region.percentage"></div>
            </div>
            <span class="region-percentage">{{formatPercentage(region.percentage!)}}</span>
          </div>
        </div>
      </div>

      <!-- ×¤×¢×™×œ×•×ª ××—×¨×•× ×” -->
      <div class="recent-activity">
        <h2>{{ (i18n.terms$ | async)?.recentActivity }}</h2>
        <div class="activity-list">
          <div *ngFor="let activity of recentActivity.slice(0, 10)" class="activity-item">
            <div class="activity-icon">ğŸ’°</div>
            <div class="activity-content">
              <div class="activity-description">{{activity.description}}</div>
              <div class="activity-details">
                <span class="activity-date">{{formatDate(activity.date)}}</span>
                <span class="activity-campaign" *ngIf="activity.campaign">â€¢ {{activity.campaign}}</span>
              </div>
            </div>
            <div class="activity-amount">{{formatCurrency(activity.amount)}}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ×“×•×— ×ª×¨×•××•×ª -->
    <div *ngIf="activeReport === 'donations'" class="donations-report">

      <!-- ×˜×‘×œ×” ××§×•×‘×¦×ª -->
      <div class="report-table grouped-report">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sortable-header" (click)="onSortChange('donorName')">
                {{ (i18n.terms$ | async)?.nameColumn }} <mat-icon
                  class="sort-icon">{{getSortIcon('donorName')}}</mat-icon>
              </th>
              <th *ngIf="filters.showDonorDetails && filters.groupBy === 'donor'" class="sortable-header"
                (click)="onSortChange('address')">
                {{ (i18n.terms$ | async)?.addressColumn }} <mat-icon
                  class="sort-icon">{{getSortIcon('address')}}</mat-icon>
              </th>
              <th *ngIf="filters.showDonorDetails && filters.groupBy === 'donor'" class="sortable-header"
                (click)="onSortChange('phones')">
                {{ (i18n.terms$ | async)?.phonesColumn }} <mat-icon
                  class="sort-icon">{{getSortIcon('phones')}}</mat-icon>
              </th>
              <th *ngIf="filters.showDonorDetails && filters.groupBy === 'donor'" class="sortable-header"
                (click)="onSortChange('emails')">
                {{ (i18n.terms$ | async)?.emailsColumn }} <mat-icon
                  class="sort-icon">{{getSortIcon('emails')}}</mat-icon>
              </th>
              <th *ngFor="let year of hebrewYears" class="sortable-header" (click)="onSortChange('year_' + year)">
                {{year}} <mat-icon class="sort-icon">{{getSortIcon('year_' + year)}}</mat-icon>
              </th>
              <th *ngIf="filters.showActualPayments">{{ (i18n.terms$ | async)?.actualPaymentsColumn }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of groupedDonationReport">
              <td><strong>{{row.donorName}}</strong></td>
              <td *ngIf="filters.showDonorDetails && filters.groupBy === 'donor'">{{row.donorDetails?.address || '-'}}
              </td>
              <td *ngIf="filters.showDonorDetails && filters.groupBy === 'donor'">
                <div *ngIf="row.donorDetails && row.donorDetails.phones && row.donorDetails.phones.length > 0">
                  <div *ngFor="let phone of row.donorDetails.phones">{{phone}}</div>
                </div>
                <span
                  *ngIf="!row.donorDetails || !row.donorDetails.phones || row.donorDetails.phones.length === 0">-</span>
              </td>
              <td *ngIf="filters.showDonorDetails && filters.groupBy === 'donor'">
                <div *ngIf="row.donorDetails && row.donorDetails.emails && row.donorDetails.emails.length > 0">
                  <div *ngFor="let email of row.donorDetails.emails">{{email}}</div>
                </div>
                <span
                  *ngIf="!row.donorDetails || !row.donorDetails.emails || row.donorDetails.emails.length === 0">-</span>
              </td>
              <td *ngFor="let year of hebrewYears">
                {{formatYearTotal(row.yearlyTotals, year)}}
              </td>
              <td *ngIf="filters.showActualPayments">
                <div *ngFor="let year of hebrewYears">
                  <span *ngIf="row.actualPayments && row.actualPayments[year]">
                    {{year}}: â‚ª{{row.actualPayments[year].toLocaleString()}}
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination Controls -->
        <div class="pagination-container" *ngIf="totalRecords > 0">
          <div class="pagination-info">
            <span>{{ (i18n.terms$ | async)?.showingText }} {{(currentPage - 1) * pageSize + 1}} - {{Math.min(currentPage
              * pageSize, totalRecords)}} {{ (i18n.terms$ | async)?.ofText }}
              {{totalRecords}} {{ (i18n.terms$ | async)?.resultsText }}</span>
          </div>

          <div class="pagination-controls">
            <button class="page-btn" (click)="onPageChange(1)" [disabled]="currentPage === 1">
              <mat-icon>first_page</mat-icon>
            </button>
            <button class="page-btn" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
              <mat-icon>chevron_right</mat-icon>
            </button>

            <button *ngFor="let page of getPageNumbers()" class="page-btn" [class.active]="page === currentPage"
              (click)="onPageChange(page)">
              {{page}}
            </button>

            <button class="page-btn" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <button class="page-btn" (click)="onPageChange(totalPages)" [disabled]="currentPage === totalPages">
              <mat-icon>last_page</mat-icon>
            </button>
          </div>

          <div class="page-size-selector">
            <label>{{ (i18n.terms$ | async)?.rowsPerPageLabel }}</label>
            <select class="form-control-sm" [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange($event)">
              <option *ngFor="let size of pageSizeOptions" [value]="size">{{size}}</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ×˜×‘×œ×ª ×¡×™×›×•× ××˜×‘×¢×•×ª -->
      <div *ngIf="filters.showCurrencySummary && currencySummaryData.length > 0" class="currency-summary-section">
        <h3>×¡×™×›×•× ×œ×¤×™ ××˜×‘×¢×•×ª</h3>
        <table class="data-table currency-summary">
          <thead>
            <tr>
              <th>××˜×‘×¢</th>
              <th *ngFor="let year of hebrewYears">{{year}}</th>
              <th>×¡×”"×›</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let curr of currencySummaryData">
              <td><strong>{{curr.currency}}</strong></td>
              <td *ngFor="let year of hebrewYears">
                {{formatCurrencyWithSymbol(curr.yearlyTotals[year] || 0, curr.currency)}}
              </td>
              <td><strong>{{formatCurrencyWithSymbol(curr.totalAmount, curr.currency)}}</strong></td>
            </tr>
            <tr class="shgetratesekel-row">
              <td><strong>×‘×©×§×œ×™×</strong></td>
              <td *ngFor="let year of hebrewYears">
                â‚ª{{getCurrencySummaryYearTotal(year).toLocaleString()}}
              </td>
              <td><strong>â‚ª{{getTotalInShekel().toLocaleString()}}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ×“×•×— ×ª×©×œ×•××™× -->
    <div *ngIf="activeReport === 'payments'" class="payments-report">
      <h2>{{ (i18n.terms$ | async)?.paymentsReportTitle }}</h2>

      <div class="report-summary">
        <div class="summary-card">
          <div class="summary-icon">âœ…</div>
          <div class="summary-content">
            <h3>{{ (i18n.terms$ | async)?.fullyPaid }}</h3>
            <div class="summary-number">{{getPaymentStatusSummary().fullyPaid}}</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">âš ï¸</div>
          <div class="summary-content">
            <h3>{{ (i18n.terms$ | async)?.partiallyPaid }}</h3>
            <div class="summary-number">{{getPaymentStatusSummary().partiallyPaid}}</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">âŒ</div>
          <div class="summary-content">
            <h3>{{ (i18n.terms$ | async)?.notPaid }}</h3>
            <div class="summary-number">{{getPaymentStatusSummary().notPaid}}</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">ğŸ’¸</div>
          <div class="summary-content">
            <h3>{{ (i18n.terms$ | async)?.totalDebt }}</h3>
            <div class="summary-number">{{formatCurrency(getPaymentStatusSummary().totalDebt)}}</div>
          </div>
        </div>
      </div>

      <div class="report-table">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sortable" [class.sorted]="isPaymentSorted('donorName')"
                (click)="togglePaymentSort('donorName', $event)">
                {{ (i18n.terms$ | async)?.donorNameColumn }}
                <span class="sort-icon" *ngIf="getPaymentSortIcon('donorName')">{{ getPaymentSortIcon('donorName')
                  }}</span>
              </th>
              <th>{{ (i18n.terms$ | async)?.addressColumn }}</th>
              <th>{{ (i18n.terms$ | async)?.cityColumn }}</th>
              <th>{{ (i18n.terms$ | async)?.lastDateColumn }}</th>
              <th class="sortable" [class.sorted]="isPaymentSorted('promisedAmount')"
                (click)="togglePaymentSort('promisedAmount', $event)">
                {{ (i18n.terms$ | async)?.commitmentColumn }}
                <span class="sort-icon" *ngIf="getPaymentSortIcon('promisedAmount')">{{
                  getPaymentSortIcon('promisedAmount') }}</span>
              </th>
              <th class="sortable" [class.sorted]="isPaymentSorted('actualAmount')"
                (click)="togglePaymentSort('actualAmount', $event)">
                {{ (i18n.terms$ | async)?.actualPaymentColumn }}
                <span class="sort-icon" *ngIf="getPaymentSortIcon('actualAmount')">{{ getPaymentSortIcon('actualAmount')
                  }}</span>
              </th>
              <th class="sortable" [class.sorted]="isPaymentSorted('remainingDebt')"
                (click)="togglePaymentSort('remainingDebt', $event)">
                {{ (i18n.terms$ | async)?.remainingDebtColumn }}
                <span class="sort-icon" *ngIf="getPaymentSortIcon('remainingDebt')">{{
                  getPaymentSortIcon('remainingDebt') }}</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let payment of paginatedPaymentReport">
              <td>{{payment.donorName}}</td>
              <td>{{payment.address || '-'}}</td>
              <td>{{payment.city || '-'}}</td>
              <td>{{formatHebrewDate(payment.lastDonationDate)}}</td>
              <td>{{formatCurrency(payment.promisedAmount)}}</td>
              <td>{{formatCurrency(payment.actualAmount)}}</td>
              <td>{{formatCurrency(payment.remainingDebt)}}</td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination Controls -->
        <div class="table-footer" *ngIf="paymentTotalCount > 0">
          <div class="pagination-controls">
            <button (click)="firstPaymentPage()" [disabled]="paymentCurrentPage === 1">â® {{ (i18n.terms$ |
              async)?.firstButton }}</button>
            <button (click)="previousPaymentPage()" [disabled]="paymentCurrentPage === 1">â† {{ (i18n.terms$ |
              async)?.previousButton }}</button>
            <div class="page-numbers">
              <button *ngFor="let page of getPaymentPageNumbers()" (click)="goToPaymentPage(page)"
                [class.active]="page === paymentCurrentPage" [disabled]="page === -1">
                {{ page === -1 ? '...' : page }}
              </button>
            </div>
            <button (click)="nextPaymentPage()" [disabled]="paymentCurrentPage === paymentTotalPages">{{ (i18n.terms$ |
              async)?.nextButton }} â†’</button>
            <button (click)="lastPaymentPage()" [disabled]="paymentCurrentPage === paymentTotalPages">{{ (i18n.terms$ |
              async)?.lastButton }} â­</button>
          </div>
          <div class="pagination-info">
            <span>{{ (i18n.terms$ | async)?.showingText }} {{(paymentCurrentPage - 1) * paymentPageSize + 1}} -
              {{Math.min(paymentCurrentPage * paymentPageSize, paymentTotalCount)}} {{ (i18n.terms$ | async)?.ofText }}
              {{paymentTotalCount}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ×“×•×— ×¡×™×›×•× ×©× ×™× -->
    <div *ngIf="activeReport === 'yearly'" class="yearly-report">
      <h2>{{ (i18n.terms$ | async)?.yearlySummaryTitle }}</h2>

      <div class="report-table">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sortable" [class.sorted]="isYearlySummarySorted('year')"
                (click)="toggleYearlySummarySort('year', $event)">
                {{ (i18n.terms$ | async)?.yearColumn }}
                <span class="sort-icon" *ngIf="getYearlySummarySortIcon('year')">{{ getYearlySummarySortIcon('year')
                  }}</span>
              </th>
              <th>{{ (i18n.terms$ | async)?.shekel || '×©×§×œ' }}</th>
              <th>{{ (i18n.terms$ | async)?.dollar || '×“×•×œ×¨' }}</th>
              <th>{{ (i18n.terms$ | async)?.euro || '×™×•×¨×•' }}</th>
              <th class="sortable" [class.sorted]="isYearlySummarySorted('totalInShekel')"
                (click)="toggleYearlySummarySort('totalInShekel', $event)">
                {{ (i18n.terms$ | async)?.totalByShekel || '×¡×”"×› ×‘×©×§×œ×™×' }}
                <span class="sort-icon" *ngIf="getYearlySummarySortIcon('totalInShekel')">{{
                  getYearlySummarySortIcon('totalInShekel') }}</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let yearData of paginatedYearlySummaryReport">
              <td>
                <strong>{{yearData.hebrewYear}}</strong>
                <br>
                <small style="color: #999;">({{yearData.year}})</small>
              </td>
              <td>{{(yearData.currencies['ILS'] || 0) > 0 ? 'â‚ª' +
                Math.round(yearData.currencies['ILS']).toLocaleString() : '-'}}</td>
              <td>{{(yearData.currencies['USD'] || 0) > 0 ? '$' +
                Math.round(yearData.currencies['USD']).toLocaleString() : '-'}}</td>
              <td>{{(yearData.currencies['EUR'] || 0) > 0 ? 'â‚¬' +
                Math.round(yearData.currencies['EUR']).toLocaleString() : '-'}}</td>
              <td><strong>â‚ª{{Math.round(yearData.totalInShekel).toLocaleString()}}</strong></td>
            </tr>
          </tbody>
          <tfoot *ngIf="yearlySummaryData.length > 0">
            <tr style="background-color: #f5f5f5; font-weight: bold; border-top: 2px solid #333;">
              <td><strong>{{ (i18n.terms$ | async)?.totalText }}</strong></td>
              <td>{{getTotalByCurrency('ILS') > 0 ? 'â‚ª' + Math.round(getTotalByCurrency('ILS')).toLocaleString() : '-'}}
              </td>
              <td>{{getTotalByCurrency('USD') > 0 ? '$' + Math.round(getTotalByCurrency('USD')).toLocaleString() : '-'}}
              </td>
              <td>{{getTotalByCurrency('EUR') > 0 ? 'â‚¬' + Math.round(getTotalByCurrency('EUR')).toLocaleString() : '-'}}
              </td>
              <td><strong style="color: #27ae60;">â‚ª{{Math.round(getGrandTotalInShekel()).toLocaleString()}}</strong>
              </td>
            </tr>
          </tfoot>
        </table>

        <!-- Pagination Controls -->
        <div class="table-footer" *ngIf="yearlySummaryTotalCount > 0">
          <div class="pagination-controls">
            <button (click)="firstYearlySummaryPage()" [disabled]="yearlySummaryCurrentPage === 1">â® ×¨××©×•×Ÿ</button>
            <button (click)="previousYearlySummaryPage()" [disabled]="yearlySummaryCurrentPage === 1">â† ×”×§×•×“×</button>
            <div class="page-numbers">
              <button *ngFor="let page of getYearlySummaryPageNumbers()" (click)="goToYearlySummaryPage(page)"
                [class.active]="page === yearlySummaryCurrentPage" [disabled]="page === -1">
                {{ page === -1 ? '...' : page }}
              </button>
            </div>
            <button (click)="nextYearlySummaryPage()"
              [disabled]="yearlySummaryCurrentPage === yearlySummaryTotalPages">×”×‘× â†’</button>
            <button (click)="lastYearlySummaryPage()"
              [disabled]="yearlySummaryCurrentPage === yearlySummaryTotalPages">××—×¨×•×Ÿ â­</button>
          </div>
          <div class="pagination-info">
            <span>××¦×™×’ {{(yearlySummaryCurrentPage - 1) * yearlySummaryPageSize + 1}} -
              {{Math.min(yearlySummaryCurrentPage * yearlySummaryPageSize, yearlySummaryTotalCount)}} ××ª×•×š
              {{yearlySummaryTotalCount}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ×“×•×— ×‘×¨×›×•×ª -->
    <div *ngIf="activeReport === 'blessings'" class="blessings-report">
      <h2>{{ (i18n.terms$ | async)?.blessingsReportTitle }}</h2>
      <p class="report-subtitle">{{ (i18n.terms$ | async)?.trackingPurpose }}</p>

      <div class="report-summary">
        <div class="summary-card">
          <div class="summary-icon">ğŸ“</div>
          <div class="summary-content">
            <h3>{{ (i18n.terms$ | async)?.preMadeBlessings }}</h3>
            <div class="summary-number">{{getBlessingSummary().preMade}}</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">âœï¸</div>
          <div class="summary-content">
            <h3>{{ (i18n.terms$ | async)?.customBlessings }}</h3>
            <div class="summary-number">{{getBlessingSummary().custom}}</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">â“</div>
          <div class="summary-content">
            <h3>{{ (i18n.terms$ | async)?.notChosenBlessings }}</h3>
            <div class="summary-number">{{getBlessingSummary().notChosen}}</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">ğŸ“Š</div>
          <div class="summary-content">
            <h3>{{ (i18n.terms$ | async)?.totalBlessingsCount }}</h3>
            <div class="summary-number">{{getBlessingSummary().total}}</div>
          </div>
        </div>
      </div>

      <div class="report-table">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sortable" [class.sorted]="isBlessingsSorted('lastName')"
                (click)="toggleBlessingsSort('lastName', $event)">
                {{ (i18n.terms$ | async)?.lastNameColumn }}
                <span class="sort-icon" *ngIf="getBlessingsSortIcon('lastName')">{{ getBlessingsSortIcon('lastName')
                  }}</span>
              </th>
              <th class="sortable" [class.sorted]="isBlessingsSorted('firstName')"
                (click)="toggleBlessingsSort('firstName', $event)">
                {{ (i18n.terms$ | async)?.firstNameColumn }}
                <span class="sort-icon" *ngIf="getBlessingsSortIcon('firstName')">{{ getBlessingsSortIcon('firstName')
                  }}</span>
              </th>
              <th class="sortable" [class.sorted]="isBlessingsSorted('blessingBookType')"
                (click)="toggleBlessingsSort('blessingBookType', $event)">
                {{ (i18n.terms$ | async)?.blessingTypeColumn }}
                <span class="sort-icon" *ngIf="getBlessingsSortIcon('blessingBookType')">{{
                  getBlessingsSortIcon('blessingBookType') }}</span>
              </th>
              <th>{{ (i18n.terms$ | async)?.notesColumn }}</th>
              <th class="sortable" [class.sorted]="isBlessingsSorted('status')"
                (click)="toggleBlessingsSort('status', $event)">
                {{ (i18n.terms$ | async)?.statusColumn }}
                <span class="sort-icon" *ngIf="getBlessingsSortIcon('status')">{{ getBlessingsSortIcon('status')
                  }}</span>
              </th>
              <th>{{ (i18n.terms$ | async)?.phoneColumn }}</th>
              <th>{{ (i18n.terms$ | async)?.mobileColumn }}</th>
              <th>{{ (i18n.terms$ | async)?.emailColumn }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let blessing of paginatedBlessingsReport">
              <td>{{blessing.lastName}}</td>
              <td>{{blessing.firstName}}</td>
              <td>
                <span class="blessing-type">
                  {{blessing.blessingBookType}}
                </span>
              </td>
              <td>{{blessing.notes}}</td>
              <td>
                <span class="status-badge" [class]="'status-' + blessing.status">
                  {{blessing.status}}
                </span>
              </td>
              <td>{{blessing.phone}}</td>
              <td>{{blessing.mobile}}</td>
              <td>{{blessing.email}}</td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination Controls -->
        <div class="table-footer" *ngIf="blessingsTotalCount > 0">
          <div class="pagination-controls">
            <button (click)="firstBlessingsPage()" [disabled]="blessingsCurrentPage === 1">â® ×¨××©×•×Ÿ</button>
            <button (click)="previousBlessingsPage()" [disabled]="blessingsCurrentPage === 1">â† ×”×§×•×“×</button>
            <div class="page-numbers">
              <button *ngFor="let page of getBlessingsPageNumbers()" (click)="goToBlessingsPage(page)"
                [class.active]="page === blessingsCurrentPage" [disabled]="page === -1">
                {{ page === -1 ? '...' : page }}
              </button>
            </div>
            <button (click)="nextBlessingsPage()" [disabled]="blessingsCurrentPage === blessingsTotalPages">×”×‘×
              â†’</button>
            <button (click)="lastBlessingsPage()" [disabled]="blessingsCurrentPage === blessingsTotalPages">××—×¨×•×Ÿ
              â­</button>
          </div>
          <div class="pagination-info">
            <span>××¦×™×’ {{(blessingsCurrentPage - 1) * blessingsPageSize + 1}} - {{Math.min(blessingsCurrentPage *
              blessingsPageSize, blessingsTotalCount)}} ××ª×•×š {{blessingsTotalCount}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ×“×•×— ××™×©×™ ×œ×ª×•×¨× -->
    <div *ngIf="activeReport === 'personalDonor'" class="personal-donor-report">
      <!-- Filters Section -->
      <div class="personal-report-filters" *ngIf="!isPersonalReportPrintMode">
        <div class="filter-row">
          <!-- ×‘×—×™×¨×ª ×ª×•×¨× -->
          <div class="filter-group donor-filter-group">
            <label>×ª×•×¨×</label>
            <div class="donor-filter-input-wrapper">
              <input type="text" class="form-control donor-filter-input"
                [value]="selectedDonorForPersonalReport?.fullName || '×‘×—×¨ ×ª×•×¨×'" readonly
                (click)="selectDonorForPersonalReport()">
              <button class="donor-filter-search-btn" (click)="selectDonorForPersonalReport()" matTooltip="×‘×—×¨ ×ª×•×¨×"
                dir="rtl">
                <mat-icon>search</mat-icon>
              </button>
              <button *ngIf="selectedDonorForPersonalReport" class="donor-filter-clear-btn"
                (click)="selectedDonorForPersonalReport = null; personalDonorReportData = null; $event.stopPropagation()"
                matTooltip="× ×§×” ×‘×—×™×¨×”" dir="rtl">
                <mat-icon>clear</mat-icon>
              </button>
            </div>
          </div>

          <!-- ××ª××¨×™×š -->
          <div class="filter-group date-filter-group">
            <label>××ª××¨×™×š</label>
            <input type="date" class="form-control" [(ngModel)]="personalReportFromDate"
              (change)="onPersonalReportFromDateChange()">
            <small class="hebrew-date-hint">{{personalReportFromDateHebrew || '\u00A0'}}</small>
          </div>

          <!-- ×¢×“ ×ª××¨×™×š -->
          <div class="filter-group date-filter-group">
            <label>×¢×“ ×ª××¨×™×š</label>
            <input type="date" class="form-control" [(ngModel)]="personalReportToDate"
              (change)="onPersonalReportToDateChange()">
            <small class="hebrew-date-hint">{{personalReportToDateHebrew || '\u00A0'}}</small>
          </div>

          <!-- ×›×¤×ª×•×¨×™× -->
          <div class="filter-actions">
            <button class="btn btn-primary" (click)="loadPersonalDonorReport()"
              [disabled]="!selectedDonorForPersonalReport || !personalReportFromDate">
              <mat-icon>description</mat-icon>
              ×”×¤×§ ×“×•×—
            </button>
            <button class="btn btn-secondary" (click)="printPersonalDonorReport()"
              [disabled]="!personalDonorReportData">
              <mat-icon>print</mat-icon>
              ×”×“×¤×¡
            </button>
            <button class="btn btn-outline" (click)="clearPersonalDonorReport()">
              <mat-icon>refresh</mat-icon>
              × ×§×”
            </button>
          </div>
        </div>
      </div>

      <!-- Report Display -->
      <div class="personal-report-display" *ngIf="personalDonorReportData"
        [class.print-mode]="isPersonalReportPrintMode">
        <div class="report-page">

          <!-- Donations Table -->
          <div class="report-table personal-donor-table">
            <table class="data-table">
              <thead>
                <tr>
                  <th class="sortable" [class.sorted]="isPersonalDonorSorted('date')"
                    (click)="togglePersonalDonorSort('date', $event)">
                    ×ª××¨×™×š
                    <span class="sort-icon" *ngIf="getPersonalDonorSortIcon('date')">{{ getPersonalDonorSortIcon('date') }}</span>
                  </th>
                  <th class="sortable" [class.sorted]="isPersonalDonorSorted('dateHebrew')"
                    (click)="togglePersonalDonorSort('dateHebrew', $event)">
                    ×ª××¨×™×š ×¢×‘×¨×™
                    <span class="sort-icon" *ngIf="getPersonalDonorSortIcon('dateHebrew')">{{ getPersonalDonorSortIcon('dateHebrew') }}</span>
                  </th>
                  <th class="sortable" [class.sorted]="isPersonalDonorSorted('commitment')"
                    (click)="togglePersonalDonorSort('commitment', $event)">
                    ×”×ª×—×™×™×‘×•×ª
                    <span class="sort-icon" *ngIf="getPersonalDonorSortIcon('commitment')">{{ getPersonalDonorSortIcon('commitment') }}</span>
                  </th>
                  <th class="sortable" [class.sorted]="isPersonalDonorSorted('amount')"
                    (click)="togglePersonalDonorSort('amount', $event)">
                    ×¡×›×•×
                    <span class="sort-icon" *ngIf="getPersonalDonorSortIcon('amount')">{{ getPersonalDonorSortIcon('amount') }}</span>
                  </th>
                  <th class="sortable" [class.sorted]="isPersonalDonorSorted('notes')"
                    (click)="togglePersonalDonorSort('notes', $event)">
                    ×”×¢×¨×•×ª
                    <span class="sort-icon" *ngIf="getPersonalDonorSortIcon('notes')">{{ getPersonalDonorSortIcon('notes') }}</span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let donation of personalDonorReportData.donations">
                  <td>{{formatDateForReport(donation.date)}}</td>
                  <td>{{donation.dateHebrew}}</td>
                  <td>{{donation.commitment > 0 ? donation.commitment + ' ' + getCurrencySymbol(donation.currencySymbol) : '' }}</td>
                  <td>{{donation.amount}} {{getCurrencySymbol(donation.currencySymbol)}}</td>
                  <td>{{donation.notes}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!personalDonorReportData && !isPersonalReportPrintMode">
        <mat-icon>description</mat-icon>
        <p>×‘×—×¨ ×ª×•×¨× ×•×ª××¨×™×›×™× ×œ×”×¤×§×ª ×“×•×— ××™×©×™</p>
      </div>
    </div>

  </div>
</div>
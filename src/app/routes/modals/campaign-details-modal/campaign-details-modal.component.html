<!-- Campaign Details Modal -->
<div *ngIf="!this.loading" class="modal-overlay" (click)="closeModal($event)">
  <div class="modal-content campaign-details-modal" (click)="$event.stopPropagation()">

    <!-- Modal Header with gradient and icon -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <mat-icon>{{isNewCampaign ? 'add_circle' : 'campaign'}}</mat-icon>
        </div>
        <div class="header-text">
          <h2>{{isNewCampaign ? (i18n.terms$ | async)?.createNewCampaignTitle : (i18n.terms$ |
            async)?.campaignDetailsTitle}}</h2>
          <p class="header-subtitle" *ngIf="!isNewCampaign && campaign">
            {{campaign.name}}
          </p>
        </div>
      </div>
      <button class="modal-close" (click)="closeModal()" [matTooltip]="(i18n.terms$ | async)?.closeButton"
        [dir]="'rtl'">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="loading">
      <div class="loading-spinner">{{ (i18n.terms$ | async)?.loadingData }}</div>
    </div>

    <div class="modal-body">
      <div class="details-grid" *ngIf="campaign && !loading">

        <!-- Status Display -->
        <div class="section status-section" *ngIf="!isNewCampaign">
          <h3>{{ (i18n.terms$ | async)?.campaignStatusSection }}</h3>
          <div class="status-display">
            <!-- <div class="status-badge" [class.draft]="isDraft" [class.active]="isActive" [class.completed]="isCompleted"
              [class.cancelled]="isCancelled">
              <mat-icon>{{isDraft ? 'edit' : isActive ? 'play_circle' : isCompleted ? 'check_circle' :
                'cancel'}}</mat-icon>
              <span>{{isDraft ? (i18n.terms$ | async)?.draftStatusBadge : isActive ? (i18n.terms$ |
                async)?.activeStatusBadge : isCompleted ? (i18n.terms$ | async)?.completedStatusBadge : (i18n.terms$ |
                async)?.cancelledStatusBadge}}</span>
            </div> -->
            <div class="progress-info" *ngIf="campaign.targetAmount > 0">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="calculatedProgressPercentage"></div>
              </div>
              <span class="progress-text">{{calculatedProgressPercentage}}% (
                <ng-container *ngIf="raisedByCurrency.length <= 1">{{calculatedRaisedAmount | number:'1.0-0'}}</ng-container>
                <ng-container *ngIf="raisedByCurrency.length > 1"><span *ngFor="let c of raisedByCurrency; let i = index">{{i > 0 ? ' + ' : ''}}{{c.symbol}}{{c.total | number:'1.0-0'}}</span></ng-container>
                / {{campaign.targetAmount}} {{currencyTypes[campaign.currencyId]?.symbol}})</span>
            </div>
          </div>
        </div>

        <!-- 住 拽驻 -->
        <div class="section campaign-type-section">
          <h3>{{ (i18n.terms$ | async)?.campaignTypeSection }}</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="campaign-type-selector">
                <div class="campaign-type-option" [class.active]="campaign.campaignType === '专'">
                  <label class="campaign-type-card">
                    <input type="radio" name="campaignType" value="专" [(ngModel)]="campaign.campaignType"
                      [disabled]="!canEdit" (ngModelChange)="markAsChanged()" class="campaign-type-radio">
                    <div class="campaign-type-content">
                      <mat-icon class="campaign-type-icon">campaign</mat-icon>
                      <div class="campaign-type-text">
                        <span class="campaign-type-label">{{ (i18n.terms$ | async)?.regularCampaignType }}</span>
                        <!-- <span class="campaign-type-description">拽驻 住 住驻 住专</span> -->
                      </div>
                    </div>
                  </label>
                </div>

                <div class="campaign-type-option" [class.active]="campaign.campaignType === '注专'">
                  <label class="campaign-type-card">
                    <input type="radio" name="campaignType" value="注专" [(ngModel)]="campaign.campaignType"
                      [disabled]="!canEdit" (ngModelChange)="markAsChanged()" class="campaign-type-radio">
                    <div class="campaign-type-content">
                      <mat-icon class="campaign-type-icon">restaurant</mat-icon>
                      <div class="campaign-type-text">
                        <span class="campaign-type-label">{{ (i18n.terms$ | async)?.dinnerCampaignType }}</span>
                        <!-- <span class="campaign-type-description">专注 住 住驻 </span> -->
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Basic Campaign Information -->
        <div class="section basic-details">
          <h3>{{ (i18n.terms$ | async)?.basicCampaignInfoSection }}</h3>
          <div class="form-grid">

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">title</mat-icon>
                <label>{{ (i18n.terms$ | async)?.campaignNameLabel }}</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="campaign.name" [disabled]="!canEdit"
                [placeholder]="(i18n.terms$ | async)?.campaignNamePlaceholder" (ngModelChange)="markAsChanged()">
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">place</mat-icon>
                <label>{{ (i18n.terms$ | async)?.eventLocationLabel }}</label>
              </div>
              <app-osm-address-input [label]="(i18n.terms$ | async)?.eventLocationLabel || '拽 专注'"
                [placeholder]="(i18n.terms$ | async)?.eventLocationPlaceholder || '拽 拽 专注...'"
                countryCode="il" [disabled]="!canEdit" [(place)]="campaign.eventLocation"
                (placeChange)="onEventPlaceSelected($event)">
              </app-osm-address-input>
            </div>

          </div>

            <h4></h4>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">description</mat-icon>
                <label>{{ (i18n.terms$ | async)?.descriptionLabel }}</label>
              </div>
              <textarea class="form-control" [(ngModel)]="campaign.description" [disabled]="!canEdit"
                [placeholder]="(i18n.terms$ | async)?.descriptionPlaceholder" rows="3"
                (ngModelChange)="markAsChanged()"></textarea>
            </div>

          </div>
        </div>

        <!-- Financial Information -->
        <div class="section financial-details">
          <h3>{{ (i18n.terms$ | async)?.financialInfoSection }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">attach_money</mat-icon>
                <label>{{ (i18n.terms$ | async)?.targetAmountLabel }}</label>
              </div>
              <input type="number" class="form-control" [(ngModel)]="campaign.targetAmount" [disabled]="!canEdit"
                [placeholder]="(i18n.terms$ | async)?.targetAmountPlaceholder" min="0" step="0.01"
                (ngModelChange)="markAsChanged()">
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">monetization_on</mat-icon>
                <label>{{ (i18n.terms$ | async)?.currencyLabel }}</label>
              </div>
              <select class="form-control" [(ngModel)]="campaign.currencyId" [disabled]="!canEdit"
                (ngModelChange)="markAsChanged()">
                <option *ngFor="let currency of currencyTypes | keyvalue" [value]="currency.key">
                  {{ currency.value.label }} ({{ currency.value.symbol }})
                </option>
              </select>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">payment</mat-icon>
                <label>{{ (i18n.terms$ | async)?.standardDonationLabel }}</label>
              </div>
              <input type="number" class="form-control" [(ngModel)]="campaign.defaultDonationAmount"
                [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.standardDonationPlaceholder" min="0"
                step="1" (ngModelChange)="markAsChanged()">
            </div>

            <!-- <div class="form-group" *ngIf="!isNewCampaign">
              <div class="field-title">
                <mat-icon class="field-icon">savings</mat-icon>
                <label>{{ (i18n.terms$ | async)?.raisedAmountLabel }}</label>
              </div>
              <input type="number" class="form-control" [value]="campaign.raisedAmount" disabled
                [placeholder]="(i18n.terms$ | async)?.raisedAmountPlaceholder" step="0.01">
            </div>

            <div class="form-group" *ngIf="!isNewCampaign">
              <div class="field-title">
                <mat-icon class="field-icon">trending_up</mat-icon>
                <label>{{ (i18n.terms$ | async)?.completionPercentageLabel }}</label>
              </div>
              <input type="text" class="form-control" [value]="campaign.progressPercentage + '%'" disabled>
            </div> -->

          </div>
        </div>

        <!-- Dates Information -->
        <div class="section dates-details">
          <h3>{{ (i18n.terms$ | async)?.datesSection }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">event</mat-icon>
                <label>{{ (i18n.terms$ | async)?.startDateLabel }}</label>
              </div>
              <app-modern-dual-date-picker [(ngModel)]="campaign.startDate" [disabled]="!canEdit" [compact]="false"
                [calendar_open_heb_and_eng_parallel]="true" (dateChange)="markAsChanged()">
              </app-modern-dual-date-picker>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">event_available</mat-icon>
                <label>{{ (i18n.terms$ | async)?.endDateLabel }}</label>
              </div>
              <app-modern-dual-date-picker [(ngModel)]="campaign.endDate" [disabled]="!canEdit" [compact]="false"
                [calendar_open_heb_and_eng_parallel]="true" (dateChange)="markAsChanged()">
              </app-modern-dual-date-picker>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div class="section settings-details">
          <h3>{{ (i18n.terms$ | async)?.settingsSection }}</h3>
          <div class="form-grid">

            <!-- <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="campaign.isPublic"
                       [disabled]="!canEdit" (ngModelChange)="markAsChanged()">
                <mat-icon class="checkbox-icon">{{campaign.isPublic ? 'check_box' : 'check_box_outline_blank'}}</mat-icon>
                <span>{{ (i18n.terms$ | async)?.displayOnWebsiteLabel }}</span>
              </label>
            </div> -->

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">link</mat-icon>
                <label>{{ (i18n.terms$ | async)?.dinnerInvitationLinkLabel }}</label>
              </div>
              <input type="url" class="form-control" [(ngModel)]="campaign.websiteUrl" [disabled]="!canEdit"
                placeholder="https://example.com" (ngModelChange)="markAsChanged()">
            </div>

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">image</mat-icon>
                <label>{{ (i18n.terms$ | async)?.dinnerBlessingBookLinkLabel }}</label>
              </div>
              <input type="url" class="form-control" [(ngModel)]="campaign.imageUrl" [disabled]="!canEdit"
                placeholder="https://example.com/image.jpg" (ngModelChange)="markAsChanged()">
            </div>

            <!-- <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">notes</mat-icon>
                <label>{{ (i18n.terms$ | async)?.internalNotesLabel }}</label>
              </div>
              <textarea class="form-control" [(ngModel)]="campaign.internalNotes"
                        [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.internalNotesPlaceholder" rows="3"
                        (ngModelChange)="markAsChanged()"></textarea>
            </div> -->
          </div>
        </div>

      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      

      <div class="footer-actions-right">
        <button mat-raised-button color="accent" *ngIf="!isNewCampaign" (click)="openCampaignDonations()"
          class="action-button donations-list-button">
          <span class="btn-emoji"></span>
          {{ (i18n.terms$ | async)?.donations }}
        </button>

        <div class="footer-divider" *ngIf="!isNewCampaign"></div>

        <button mat-raised-button color="accent" *ngIf="campaign && campaign.campaignType === '注专'" (click)="openInvitedList()"
          class="action-button invited-list-button">
          <span class="btn-emoji"></span>
          {{ (i18n.terms$ | async)?.invitedListButton }}
        </button>

        <div class="footer-divider" *ngIf="!isNewCampaign"></div>

        <button mat-raised-button color="primary" *ngIf="campaign && campaign.campaignType === '注专'" (click)="openBlessingBook()"
          class="action-button blessing-book-button">
          <span class="btn-emoji"></span>
          {{ (i18n.terms$ | async)?.blessingBookButton }}
        </button>
        <!-- <div class="footer-divider" *ngIf="!isNewCampaign"></div> -->
      </div>


      <div class="footer-actions-right">
        <!-- <button mat-stroked-button color="warn" *ngIf="!isNewCampaign" (click)="deleteCampaign()" class="action-button">
          <mat-icon>delete</mat-icon>
          {{ (i18n.terms$ | async)?.deleteCampaignButton }}
        </button> -->

        <button mat-stroked-button (click)="closeModal()" class="cancel-button">
          <mat-icon>close</mat-icon>
          {{ (i18n.terms$ | async)?.cancelButton }}
        </button>
        <button mat-raised-button color="primary" (click)="saveCampaign()" class="save-button" [disabled]="loading">
          <mat-icon>save</mat-icon>
          {{ (i18n.terms$ | async)?.saveCampaignButton }}
        </button>
      </div>
    </div>
  </div>
</div>
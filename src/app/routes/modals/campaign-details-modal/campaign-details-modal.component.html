<!-- Campaign Details Modal -->
<div *ngIf="!this.loading" class="modal-overlay" (click)="closeModal($event)">
  <div class="modal-content campaign-details-modal" (click)="$event.stopPropagation()">

    <!-- Modal Header with gradient and icon -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <mat-icon>{{isNewCampaign ? 'add_circle' : 'campaign'}}</mat-icon>
        </div>
        <div class="header-text">
          <h2>{{isNewCampaign ? (i18n.terms$ | async)?.createNewCampaignTitle : (i18n.terms$ | async)?.campaignDetailsTitle}}</h2>
          <p class="header-subtitle" *ngIf="!isNewCampaign && campaign">
            {{campaign.name}}
          </p>
        </div>
      </div>
      <button class="modal-close" (click)="closeModal()" [matTooltip]="(i18n.terms$ | async)?.closeButton" [dir]="'rtl'">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="loading">
      <div class="loading-spinner">{{ (i18n.terms$ | async)?.loadingData }}</div>
    </div>

    <div class="modal-body">
      <div class="details-grid" *ngIf="campaign && !loading">

        <!-- Status Display -->
        <div class="section status-section" *ngIf="!isNewCampaign">
          <h3>{{ (i18n.terms$ | async)?.campaignStatusSection }}</h3>
          <div class="status-display">
            <div class="status-badge" [class.draft]="isDraft" [class.active]="isActive"
                 [class.completed]="isCompleted" [class.cancelled]="isCancelled">
              <mat-icon>{{isDraft ? 'edit' : isActive ? 'play_circle' : isCompleted ? 'check_circle' : 'cancel'}}</mat-icon>
              <span>{{isDraft ? (i18n.terms$ | async)?.draftStatusBadge : isActive ? (i18n.terms$ | async)?.activeStatusBadge : isCompleted ? (i18n.terms$ | async)?.completedStatusBadge : (i18n.terms$ | async)?.cancelledStatusBadge}}</span>
            </div>
            <div class="progress-info" *ngIf="campaign.targetAmount > 0">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="campaign.progressPercentage"></div>
              </div>
              <span class="progress-text">{{campaign.progressPercentage}}% ({{campaign.raisedAmount}} / {{campaign.targetAmount}} {{campaign.currency}})</span>
            </div>
          </div>
        </div>

        <!-- סוג קמפיין -->
        <div class="section campaign-type-section">
          <h3>{{ (i18n.terms$ | async)?.campaignTypeSection }}</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="campaign-type-selector">
                <div class="campaign-type-option" [class.active]="campaign.campaignType === 'רגיל'">
                  <label class="campaign-type-card">
                    <input type="radio"
                           name="campaignType"
                           value="רגיל"
                           [(ngModel)]="campaign.campaignType"
                           [disabled]="!canEdit"
                           (ngModelChange)="markAsChanged()"
                           class="campaign-type-radio">
                    <div class="campaign-type-content">
                      <mat-icon class="campaign-type-icon">campaign</mat-icon>
                      <div class="campaign-type-text">
                        <span class="campaign-type-label">{{ (i18n.terms$ | async)?.regularCampaignType }}</span>
                        <!-- <span class="campaign-type-description">קמפיין גיוס כספים סטנדרטי</span> -->
                      </div>
                    </div>
                  </label>
                </div>

                <div class="campaign-type-option" [class.active]="campaign.campaignType === 'דינער'">
                  <label class="campaign-type-card">
                    <input type="radio"
                           name="campaignType"
                           value="דינער"
                           [(ngModel)]="campaign.campaignType"
                           [disabled]="!canEdit"
                           (ngModelChange)="markAsChanged()"
                           class="campaign-type-radio">
                    <div class="campaign-type-content">
                      <mat-icon class="campaign-type-icon">restaurant</mat-icon>
                      <div class="campaign-type-text">
                        <span class="campaign-type-label">{{ (i18n.terms$ | async)?.dinnerCampaignType }}</span>
                        <!-- <span class="campaign-type-description">אירוע גיוס כספים חגיגי</span> -->
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Basic Campaign Information -->
        <div class="section basic-details">
          <h3>{{ (i18n.terms$ | async)?.basicCampaignInfoSection }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">title</mat-icon>
                <label>{{ (i18n.terms$ | async)?.campaignNameLabel }}</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="campaign.name"
                     [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.campaignNamePlaceholder"
                     (ngModelChange)="markAsChanged()">
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">supervisor_account</mat-icon>
                <label>{{ (i18n.terms$ | async)?.campaignManagerLabel }}</label>
              </div>
              <select class="form-control" [(ngModel)]="campaign.managerId"
                      [disabled]="!canEdit" (ngModelChange)="onManagerChange()">
                <option value="">{{ (i18n.terms$ | async)?.selectManagerPlaceholder }}</option>
                <option *ngFor="let user of users" [value]="user.id">
                  {{ getUserDisplayName(user) }}
                </option>
              </select>
            </div>

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">place</mat-icon>
                <label>{{ (i18n.terms$ | async)?.eventLocationLabel }}</label>
              </div>
              <app-osm-address-input
                [label]="(i18n.terms$ | async)?.eventLocationLabel || 'מיקום האירוע'"
                [placeholder]="(i18n.terms$ | async)?.eventLocationPlaceholder || 'הקלד מיקום האירוע...'"
                countryCode="il"
                [disabled]="!canEdit"
                [(place)]="campaign.eventLocation"
                (placeChange)="onEventPlaceSelected($event)">
              </app-osm-address-input>
            </div>

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">description</mat-icon>
                <label>{{ (i18n.terms$ | async)?.descriptionLabel }}</label>
              </div>
              <textarea class="form-control" [(ngModel)]="campaign.description"
                        [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.descriptionPlaceholder" rows="3"
                        (ngModelChange)="markAsChanged()"></textarea>
            </div>
          </div>
        </div>

        <!-- Financial Information -->
        <div class="section financial-details">
          <h3>{{ (i18n.terms$ | async)?.financialInfoSection }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">attach_money</mat-icon>
                <label>{{ (i18n.terms$ | async)?.targetAmountLabel }}</label>
              </div>
              <input type="number" class="form-control" [(ngModel)]="campaign.targetAmount"
                     [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.targetAmountPlaceholder" min="0" step="0.01"
                     (ngModelChange)="markAsChanged()">
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">monetization_on</mat-icon>
                <label>{{ (i18n.terms$ | async)?.currencyLabel }}</label>
              </div>
              <select class="form-control" [(ngModel)]="campaign.currency"
                      [disabled]="!canEdit" (ngModelChange)="markAsChanged()">
                <option value="ILS">{{ (i18n.terms$ | async)?.shekelILS }}</option>
                <option value="USD">{{ (i18n.terms$ | async)?.dollarUSD }}</option>
                <option value="EUR">{{ (i18n.terms$ | async)?.euroEUR }}</option>
                <option value="GBP">{{ (i18n.terms$ | async)?.poundGBP }}</option>
                <option value="CAD">{{ (i18n.terms$ | async)?.dollarCAD }}</option>
                <option value="AUD">{{ (i18n.terms$ | async)?.dollarAUD }}</option>
              </select>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">payment</mat-icon>
                <label>{{ (i18n.terms$ | async)?.standardDonationLabel }}</label>
              </div>
              <input type="number" class="form-control" [(ngModel)]="campaign.defaultDonationAmount"
                     [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.standardDonationPlaceholder" min="0" step="1"
                     (ngModelChange)="markAsChanged()">
            </div>

            <div class="form-group" *ngIf="!isNewCampaign">
              <div class="field-title">
                <mat-icon class="field-icon">savings</mat-icon>
                <label>{{ (i18n.terms$ | async)?.raisedAmountLabel }}</label>
              </div>
              <input type="number" class="form-control" [value]="campaign.raisedAmount"
                     disabled [placeholder]="(i18n.terms$ | async)?.raisedAmountPlaceholder" step="0.01">
            </div>

            <div class="form-group" *ngIf="!isNewCampaign">
              <div class="field-title">
                <mat-icon class="field-icon">trending_up</mat-icon>
                <label>{{ (i18n.terms$ | async)?.completionPercentageLabel }}</label>
              </div>
              <input type="text" class="form-control" [value]="campaign.progressPercentage + '%'"
                     disabled>
            </div>
          </div>
        </div>

        <!-- Dates Information -->
        <div class="section dates-details">
          <h3>{{ (i18n.terms$ | async)?.datesSection }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">event</mat-icon>
                <label>{{ (i18n.terms$ | async)?.startDateLabel }}</label>
              </div>
              <app-modern-dual-date-picker
                [(ngModel)]="campaign.startDate"
                [disabled]="!canEdit"
                [compact]="false"
                [calendar_open_heb_and_eng_parallel]="true"
                (dateChange)="markAsChanged()">
              </app-modern-dual-date-picker>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">event_available</mat-icon>
                <label>{{ (i18n.terms$ | async)?.endDateLabel }}</label>
              </div>
              <app-modern-dual-date-picker
                [(ngModel)]="campaign.endDate"
                [disabled]="!canEdit"
                [compact]="false"
                [calendar_open_heb_and_eng_parallel]="true"
                (dateChange)="markAsChanged()">
              </app-modern-dual-date-picker>
            </div>
          </div>
        </div>

        <!-- Management Information -->
        <div class="section management-details">
          <h3>{{ (i18n.terms$ | async)?.inviteesSection }}</h3>
          <div class="form-grid">

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">group_work</mat-icon>
                <label>{{ (i18n.terms$ | async)?.generalCriteriaLabel }}</label>
              </div>
              <div class="criteria-selection-grid">
                <!-- אנ"ש criteria with include/exclude options -->
                <div class="criteria-option-container">
                  <div class="criteria-card-header">
                    <mat-icon class="criteria-icon">groups</mat-icon>
                    <span class="criteria-title">{{ (i18n.terms$ | async)?.anashCriteria }}</span>
                  </div>
                  <div class="criteria-options">
                    <label class="option-label">
                      <input type="checkbox" [(ngModel)]="campaign.isAnash"
                             [disabled]="!canEdit || campaign.excludeAnash"
                             (ngModelChange)="onAnashIncludeChange()">
                      <span class="visual-option-label">
                        <span class="option-icon include">✓</span>
                      </span>
                    </label>
                    <label class="option-label exclude-option">
                      <input type="checkbox" [(ngModel)]="campaign.excludeAnash"
                             [disabled]="!canEdit || campaign.isAnash"
                             (ngModelChange)="onAnashExcludeChange()">
                      <span class="visual-option-label">
                        <span class="option-icon exclude">✗</span>
                      </span>
                    </label>
                  </div>
                </div>

                <!-- תושבי המדינה criteria with include/exclude options -->
                <div class="criteria-option-container">
                  <div class="criteria-card-header">
                    <mat-icon class="criteria-icon">location_on</mat-icon>
                    <span class="criteria-title">{{ (i18n.terms$ | async)?.sameCountryCriteria }}</span>
                  </div>
                  <div class="criteria-options">
                    <label class="option-label">
                      <input type="checkbox" [(ngModel)]="campaign.sameCountryOnly"
                             [disabled]="!canEdit || campaign.excludeSameCountry"
                             (ngModelChange)="onSameCountryIncludeChange()">
                      <span class="visual-option-label">
                        <span class="option-icon include">✓</span>
                      </span>
                    </label>
                    <label class="option-label exclude-option">
                      <input type="checkbox" [(ngModel)]="campaign.excludeSameCountry"
                             [disabled]="!canEdit || campaign.sameCountryOnly"
                             (ngModelChange)="onSameCountryExcludeChange()">
                      <span class="visual-option-label">
                        <span class="option-icon exclude">✗</span>
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">group_work</mat-icon>
                <label>{{ (i18n.terms$ | async)?.categoryField }}</label>
              </div>
              <div class="level-selection-grid">
                <div class="level-option" [class.active]="campaign.circle === 'platinum'">
                  <label class="level-card">
                    <input type="radio" name="campaignCircle" value="platinum" [(ngModel)]="campaign.circle"
                           [disabled]="!canEdit" (ngModelChange)="markAsChanged()" class="level-radio">
                    <div class="level-content">
                      <span class="level-icon">👑</span>
                      <span class="level-label">{{ (i18n.terms$ | async)?.circlePlatinum }}</span>
                    </div>
                  </label>
                </div>

                <div class="level-option" [class.active]="campaign.circle === 'gold'">
                  <label class="level-card">
                    <input type="radio" name="campaignCircle" value="gold" [(ngModel)]="campaign.circle"
                           [disabled]="!canEdit" (ngModelChange)="markAsChanged()" class="level-radio">
                    <div class="level-content">
                      <span class="level-icon">🥇</span>
                      <span class="level-label">{{ (i18n.terms$ | async)?.circleGold }}</span>
                    </div>
                  </label>
                </div>

                <div class="level-option" [class.active]="campaign.circle === 'silver'">
                  <label class="level-card">
                    <input type="radio" name="campaignCircle" value="silver" [(ngModel)]="campaign.circle"
                           [disabled]="!canEdit" (ngModelChange)="markAsChanged()" class="level-radio">
                    <div class="level-content">
                      <span class="level-icon">🥈</span>
                      <span class="level-label">{{ (i18n.terms$ | async)?.circleSilver }}</span>
                    </div>
                  </label>
                </div>

                <div class="level-option" [class.active]="campaign.circle === 'regular'">
                  <label class="level-card">
                    <input type="radio" name="campaignCircle" value="regular" [(ngModel)]="campaign.circle"
                           [disabled]="!canEdit" (ngModelChange)="markAsChanged()" class="level-radio">
                    <div class="level-content">
                      <span class="level-icon">⭕</span>
                      <span class="level-label">{{ (i18n.terms$ | async)?.circleRegular }}</span>
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-group age-range-container">
              <div class="field-title">
                <mat-icon class="field-icon">cake</mat-icon>
                <label>{{ (i18n.terms$ | async)?.ageRangeLabel }}</label>
              </div>
              <div class="age-range-inputs">
                <input type="number" class="form-control" [(ngModel)]="campaign.minAge"
                       [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.ageFromPlaceholder"
                       min="0" max="120"
                       (ngModelChange)="markAsChanged()">
                <span class="age-separator">-</span>
                <input type="number" class="form-control" [(ngModel)]="campaign.maxAge"
                       [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.ageToPlaceholder"
                       min="0" max="120"
                       (ngModelChange)="markAsChanged()">
              </div>
            </div>

            <!-- <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">group</mat-icon>
                <label>{{ (i18n.terms$ | async)?.socialCircleLabel }}</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="campaign.socialCircle"
                     [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.socialCirclePlaceholder"
                     (ngModelChange)="markAsChanged()">
            </div> -->

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">people</mat-icon>
                <label>{{ (i18n.terms$ | async)?.activistsAndContactsLabel }}</label>
              </div>
              <div class="criteria-selection-grid">
                <div class="criteria-option">
                  <button type="button" class="criteria-card action-card" (click)="openActivists()">
                    <div class="criteria-content">
                      <mat-icon class="criteria-icon">volunteer_activism</mat-icon>
                      <span class="criteria-label">{{ (i18n.terms$ | async)?.activistsLabel }}</span>
                    </div>
                  </button>
                </div>

                <div class="criteria-option">
                  <button type="button" class="criteria-card action-card" (click)="openContacts()">
                    <div class="criteria-content">
                      <mat-icon class="criteria-icon">contacts</mat-icon>
                      <span class="criteria-label">{{ (i18n.terms$ | async)?.contactsLabel }}</span>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div class="section settings-details">
          <h3>{{ (i18n.terms$ | async)?.settingsSection }}</h3>
          <div class="form-grid">

            <!-- <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="campaign.isPublic"
                       [disabled]="!canEdit" (ngModelChange)="markAsChanged()">
                <mat-icon class="checkbox-icon">{{campaign.isPublic ? 'check_box' : 'check_box_outline_blank'}}</mat-icon>
                <span>{{ (i18n.terms$ | async)?.displayOnWebsiteLabel }}</span>
              </label>
            </div> -->

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">link</mat-icon>
                <label>{{ (i18n.terms$ | async)?.dinnerInvitationLinkLabel }}</label>
              </div>
              <input type="url" class="form-control" [(ngModel)]="campaign.websiteUrl"
                     [disabled]="!canEdit" placeholder="https://example.com"
                     (ngModelChange)="markAsChanged()">
            </div>

            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">image</mat-icon>
                <label>{{ (i18n.terms$ | async)?.dinnerBlessingBookLinkLabel }}</label>
              </div>
              <input type="url" class="form-control" [(ngModel)]="campaign.imageUrl"
                     [disabled]="!canEdit" placeholder="https://example.com/image.jpg"
                     (ngModelChange)="markAsChanged()">
            </div>

            <!-- <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">notes</mat-icon>
                <label>{{ (i18n.terms$ | async)?.internalNotesLabel }}</label>
              </div>
              <textarea class="form-control" [(ngModel)]="campaign.internalNotes"
                        [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.internalNotesPlaceholder" rows="3"
                        (ngModelChange)="markAsChanged()"></textarea>
            </div> -->
          </div>
        </div>

      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="footer-actions-left">
        <!-- Campaign Status Toggle - Light Switch Style -->
        <div class="light-switch-container">
          <label class="light-switch" [class.active]="campaign.isActive">
            <input type="checkbox" [(ngModel)]="campaign.isActive"
                   [disabled]="!canEdit" (ngModelChange)="toggleCampaignActive()">
            <span class="switch-slider">
              <span class="switch-handle">
                <mat-icon class="switch-icon">{{campaign.isActive ? 'light_mode' : 'dark_mode'}}</mat-icon>
              </span>
            </span>
            <span class="switch-label">{{campaign.isActive ? (i18n.terms$ | async)?.campaignActiveLabel : (i18n.terms$ | async)?.campaignInactiveLabel}}</span>
          </label>
        </div>

        <!-- Campaign Action Buttons -->
        <button mat-raised-button color="primary"
                *ngIf="canActivate"
                (click)="activateCampaign()"
                [disabled]="loading"
                class="action-button">
          <mat-icon>play_circle</mat-icon>
          {{ (i18n.terms$ | async)?.activateCampaignButton }}
        </button>

        <button mat-raised-button color="accent"
                *ngIf="canComplete"
                (click)="completeCampaign()"
                [disabled]="loading"
                class="action-button">
          <mat-icon>check_circle</mat-icon>
          {{ (i18n.terms$ | async)?.markAsCompletedButton }}
        </button>
      </div>

      <div class="footer-actions-right">
        <button mat-raised-button
                color="primary"
                *ngIf="!isNewCampaign"
                (click)="openNewDonation()"
                class="action-button new-donation-button">
          <mat-icon>add_circle</mat-icon>
          {{ (i18n.terms$ | async)?.newDonationButton }}
        </button>

        <button mat-raised-button
                color="accent"
                *ngIf="campaign.campaignType === 'דינער'"
                (click)="openInvitedList()"
                class="action-button invited-list-button">
          <mat-icon>list_alt</mat-icon>
          {{ (i18n.terms$ | async)?.invitedListButton }}
        </button>

        <button mat-raised-button
                color="primary"
                *ngIf="campaign.campaignType === 'דינער'"
                (click)="openBlessingBook()"
                class="action-button blessing-book-button">
          <mat-icon>menu_book</mat-icon>
          {{ (i18n.terms$ | async)?.blessingBookButton }}
        </button>

        <button mat-stroked-button
                color="warn"
                *ngIf="!isNewCampaign"
                (click)="deleteCampaign()"
                class="action-button">
          <mat-icon>delete</mat-icon>
          {{ (i18n.terms$ | async)?.deleteCampaignButton }}
        </button>

        <button mat-stroked-button
                (click)="closeModal()"
                class="cancel-button">
          <mat-icon>close</mat-icon>
          {{ (i18n.terms$ | async)?.cancelButton }}
        </button>
        <button mat-raised-button
                color="primary"
                (click)="saveCampaign()"
                class="save-button"
                [disabled]="loading">
          <mat-icon>save</mat-icon>
          {{ (i18n.terms$ | async)?.saveCampaignButton }}
        </button>
      </div>
    </div>
  </div>
</div>
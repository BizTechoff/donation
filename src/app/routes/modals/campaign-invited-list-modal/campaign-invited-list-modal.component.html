<!-- Campaign Invited List Modal -->
<div *ngIf="!loading || campaign" class="modal-overlay" (click)="closeModal($event)">
  <div class="modal-content invited-list-modal" (click)="$event.stopPropagation()">

    <!-- Modal Header - Fixed, Non-scrolling -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <mat-icon>people</mat-icon>
        </div>
        <div class="header-text">
          <h2>{{ (i18n.terms$ | async)?.inviteesSection }}</h2>
          <p class="header-subtitle" *ngIf="campaign">
            {{campaign.name}} - {{invitedDonors.length}} {{ (i18n.terms$ | async)?.invitees }}
          </p>
        </div>
      </div>
      <button class="modal-close" (click)="closeModal()" [matTooltip]="(i18n.terms$ | async)?.closeButton" [dir]="'rtl'">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Display Options Section - Fixed, Non-scrolling -->
    <div class="filters-section" *ngIf="campaign">
      <div class="display-options-section">
        <label class="display-option-checkbox">
          <input type="checkbox" [(ngModel)]="showOnlySelected">
          <span class="checkbox-label">הצג רק מסומנים</span>
        </label>
        <label class="display-option-checkbox">
          <input type="checkbox" [(ngModel)]="showSelectedFirst">
          <span class="checkbox-label">הצג מסומנים ראשונים ברשימה</span>
        </label>
        <div class="free-search-container">
          <mat-icon class="search-icon">search</mat-icon>
          <input type="text"
                 class="free-search-input"
                 [(ngModel)]="freeSearchText"
                 (ngModelChange)="onFreeSearchChange()"
                 placeholder="חיפוש חופשי...">
          <button *ngIf="freeSearchText"
                  class="clear-search-btn"
                  (click)="freeSearchText = ''; onFreeSearchChange()"
                  [matTooltip]="'נקה חיפוש'"
                  [dir]="'rtl'">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="loading && !campaign">
      <div class="loading-spinner">
        <mat-icon class="spinner">refresh</mat-icon>
        <p>{{ (i18n.terms$ | async)?.loadingData }}</p>
      </div>
    </div>

    <!-- Modal Body - Scrollable Table -->
    <div class="modal-body">
      <div class="table-container" *ngIf="campaign && !loading">
        <table class="donors-table">
          <thead>
            <tr>
              <th class="checkbox-column">
                <input type="checkbox"
                       [checked]="isAllSelected()"
                       (change)="toggleAllSelection()">
              </th>
              <th class="sortable" (click)="sortBy('firstName')">
                {{ (i18n.terms$ | async)?.name }}
                <span class="sort-icon">{{getSortIcon('firstName')}}</span>
              </th>
              <th class="sortable" (click)="sortBy('phone')">
                {{ (i18n.terms$ | async)?.phone }}
                <span class="sort-icon">{{getSortIcon('phone')}}</span>
              </th>
              <th class="sortable" (click)="sortBy('email')">
                {{ (i18n.terms$ | async)?.email }}
                <span class="sort-icon">{{getSortIcon('email')}}</span>
              </th>
              <!-- <th class="sortable" (click)="sortBy('level')">
                {{ (i18n.terms$ | async)?.level }}
                <span class="sort-icon">{{getSortIcon('level')}}</span>
              </th> -->
              <th class="sortable" (click)="sortBy('city')">
                {{ (i18n.terms$ | async)?.city }}
                <span class="sort-icon">{{getSortIcon('city')}}</span>
              </th>
              <!-- <th>{{ (i18n.terms$ | async)?.actions }}</th> -->
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let donor of displayedDonors" class="donor-row">
              <td class="checkbox-column">
                <input type="checkbox"
                       [checked]="isSelected(donor.id)"
                       (change)="toggleSelection(donor.id)">
              </td>
              <td class="donor-name clickable" (click)="openDonorDetails(donor)">
                <strong>{{getDonorDisplayName(donor)}}</strong>
              </td>
              <td>{{getDonorPhone(donor)}}</td>
              <td>{{getDonorEmail(donor)}}</td>
              <!-- <td>
                <span class="level-badge">{{getDonorLevel(donor)}}</span>
              </td> -->
              <td>{{getDonorCity(donor)}}</td>
              <!-- <td class="actions">
                <button mat-icon-button
                        [matTooltip]="(i18n.terms$ | async)?.donorDetails"
                        [dir]="'rtl'"
                        (click)="openDonorDetails(donor)">
                  <mat-icon>info</mat-icon>
                </button>
              </td> -->
            </tr>
          </tbody>
        </table>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="displayedDonors.length === 0">
          <mat-icon>people_outline</mat-icon>
          <p>{{ (i18n.terms$ | async)?.noInviteesFound }}</p>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls" *ngIf="totalPages > 1">
          <button class="btn-page" (click)="firstPage()" [disabled]="currentPage === 1 || loading">
            ⏮ ראשון
          </button>
          <button class="btn-page" (click)="previousPage()" [disabled]="currentPage === 1 || loading">
            ← הקודם
          </button>
          <div class="page-numbers">
            <button *ngFor="let page of getPageNumbers()"
                    class="btn-page-number"
                    [class.active]="page === currentPage"
                    (click)="goToPage(page)"
                    [disabled]="loading">
              {{page}}
            </button>
          </div>
          <button class="btn-page" (click)="nextPage()" [disabled]="currentPage === totalPages || loading">
            הבא →
          </button>
          <button class="btn-page" (click)="lastPage()" [disabled]="currentPage === totalPages || loading">
            אחרון ⏭
          </button>
          <div class="pagination-info">
            <span>מוצג {{(currentPage - 1) * pageSize + 1}}-{{Math.min(currentPage * pageSize, totalFilteredCount)}} מתוך {{totalFilteredCount}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer - Fixed, Non-scrolling -->
    <div class="modal-footer">
      <!-- Selection Actions -->
      <div class="selection-actions">
        <button mat-stroked-button (click)="selectAll()" [disabled]="loading || invitedDonors.length === 0">
          <mat-icon>check_box</mat-icon>
          {{ (i18n.terms$ | async)?.selectAll }}
        </button>
        <button mat-stroked-button (click)="deselectAll()" [disabled]="loading || selectedCount === 0">
          <mat-icon>check_box_outline_blank</mat-icon>
          {{ (i18n.terms$ | async)?.deselectAll }}
        </button>
      </div>

      <div class="footer-stats">
        <span class="stat-item">
          <mat-icon>people</mat-icon>
          {{ (i18n.terms$ | async)?.totalInvitees }}: {{invitedDonors.length}}
        </span>
        <span class="stat-item" *ngIf="true || selectedCount > 0">
          <mat-icon>check_circle</mat-icon>
          {{ (i18n.terms$ | async)?.selectedInvitees }}: {{selectedCount}}
        </span>
      </div>

      

      <!-- Save Filters Button -->
      <div class="filters-actions">
        <button mat-raised-button
                color="accent"
                (click)="exportToExcel()"
                [disabled]="loading || invitedDonors.length === 0">
          <mat-icon>file_download</mat-icon>
          {{ (i18n.terms$ | async)?.exportToExcel }}
        </button>
      </div>

      <div class="footer-actions">
        <button mat-raised-button color="primary" (click)="saveCampaign()" [disabled]="loading">
          <mat-icon>save</mat-icon>
          {{ (i18n.terms$ | async)?.saveInviteesButton }}
        </button>

        <!-- <button mat-raised-button
                color="primary"
                (click)="sendInvitations()"
                [disabled]="loading || invitedDonors.length === 0">
          <mat-icon>send</mat-icon>
          {{ (i18n.terms$ | async)?.sendInvitations }}
        </button> -->

        <button mat-stroked-button
                (click)="closeModal()">
          <mat-icon>close</mat-icon>
          {{ (i18n.terms$ | async)?.closeButton }}
        </button>
      </div>
    </div>
  </div>
</div>

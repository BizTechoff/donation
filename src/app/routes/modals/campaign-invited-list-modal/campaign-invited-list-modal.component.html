<!-- Campaign Invited List Modal -->
<div *ngIf="!loading || campaign" class="modal-overlay" (click)="closeModal($event)">
  <div class="modal-content invited-list-modal" (click)="$event.stopPropagation()">

    <!-- Modal Header - Fixed, Non-scrolling -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <mat-icon>people</mat-icon>
        </div>
        <div class="header-text">
          <h2>{{ (i18n.terms$ | async)?.inviteesSection }}</h2>
          <p class="header-subtitle" *ngIf="campaign">
            {{campaign.name}} - {{invitedDonors.length}} {{ (i18n.terms$ | async)?.invitees }}
          </p>
        </div>
      </div>
      <button class="modal-close" (click)="closeModal()" [matTooltip]="(i18n.terms$ | async)?.closeButton" [dir]="'rtl'">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Filters Section - Fixed, Non-scrolling -->
    <div class="filters-section" *ngIf="campaign">
      <div class="section-title">
        <mat-icon>filter_list</mat-icon>
        <h3>{{ (i18n.terms$ | async)?.generalCriteriaLabel }}</h3>
        <button class="clear-filters-btn"
                (click)="clearFilters()"
                [disabled]="!hasActiveFilters"
                [matTooltip]="'נקה פילטרים'"
                [dir]="'rtl'">
          <mat-icon>clear_all</mat-icon>
          <span>נקה פילטרים</span>
        </button>
      </div>

      <div class="filters-grid">
        <!-- אנ"ש criteria with include/exclude options -->
        <div class="filter-item">
          <div class="filter-header">
            <mat-icon class="filter-icon">groups</mat-icon>
            <span class="filter-label">{{ (i18n.terms$ | async)?.anashCriteria }}</span>
          </div>
          <div class="filter-options">
            <label class="option-checkbox">
              <input type="checkbox" [(ngModel)]="campaign.isAnash"
                     [disabled]="!canEdit || campaign.excludeAnash"
                     (ngModelChange)="onAnashIncludeChange()">
              <span class="checkbox-label include">✓ כולל</span>
            </label>
            <label class="option-checkbox">
              <input type="checkbox" [(ngModel)]="campaign.excludeAnash"
                     [disabled]="!canEdit || campaign.isAnash"
                     (ngModelChange)="onAnashExcludeChange()">
              <span class="checkbox-label exclude">✗ לא כולל</span>
            </label>
          </div>
        </div>

        <!-- Alumni Filter -->
        <div class="filter-item">
          <div class="filter-header">
            <mat-icon class="filter-icon">school</mat-icon>
            <span class="filter-label">בוגרים</span>
          </div>
          <div class="filter-options">
            <label class="option-checkbox">
              <input type="checkbox" [(ngModel)]="includeAlumni"
                     [disabled]="!canEdit || excludeAlumni"
                     (ngModelChange)="onAlumniIncludeChange()">
              <span class="checkbox-label include">✓ כולל</span>
            </label>
            <label class="option-checkbox">
              <input type="checkbox" [(ngModel)]="excludeAlumni"
                     [disabled]="!canEdit || includeAlumni"
                     (ngModelChange)="onAlumniExcludeChange()">
              <span class="checkbox-label exclude">✗ לא כולל</span>
            </label>
          </div>
        </div>

        <!-- Country Filter -->
        <div class="filter-item">
          <div class="filter-header">
            <mat-icon class="filter-icon">public</mat-icon>
            <span class="filter-label">מדינה</span>
          </div>
          <select class="filter-select"
                  [(ngModel)]="selectedCountry"
                  [disabled]="!canEdit"
                  (ngModelChange)="onFilterChange()">
            <option value="">הכל</option>
            <option *ngFor="let country of countries" [value]="country">{{country}}</option>
          </select>
        </div>

        <!-- City Filter -->
        <div class="filter-item">
          <div class="filter-header">
            <mat-icon class="filter-icon">location_city</mat-icon>
            <span class="filter-label">עיר</span>
          </div>
          <select class="filter-select"
                  [(ngModel)]="selectedCity"
                  [disabled]="!canEdit"
                  (ngModelChange)="onFilterChange()">
            <option value="">הכל</option>
            <option *ngFor="let city of cities" [value]="city">{{city}}</option>
          </select>
        </div>

        <!-- Neighborhood Filter -->
        <div class="filter-item">
          <div class="filter-header">
            <mat-icon class="filter-icon">home</mat-icon>
            <span class="filter-label">שכונה</span>
          </div>
          <select class="filter-select"
                  [(ngModel)]="selectedNeighborhood"
                  [disabled]="!canEdit"
                  (ngModelChange)="onFilterChange()">
            <option value="">הכל</option>
            <option *ngFor="let neighborhood of neighborhoods" [value]="neighborhood">{{neighborhood}}</option>
          </select>
        </div>

        <!-- Circle Entity Filter -->
        <div class="filter-item">
          <div class="filter-header">
            <mat-icon class="filter-icon">group</mat-icon>
            <span class="filter-label">חוג</span>
          </div>
          <select class="filter-select"
                  [(ngModel)]="selectedCircleId"
                  [disabled]="!canEdit"
                  (ngModelChange)="onFilterChange()">
            <option value="">הכל</option>
            <option *ngFor="let circle of circles" [value]="circle.id">{{circle.name}}</option>
          </select>
        </div>

        <!-- Age Range Filter -->
        <div class="filter-item age-filter">
          <div class="filter-header">
            <mat-icon class="filter-icon">cake</mat-icon>
            <span class="filter-label">{{ (i18n.terms$ | async)?.ageRangeLabel }}</span>
          </div>
          <div class="age-inputs">
            <input type="number" class="age-input" [(ngModel)]="campaign.minAge"
                   [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.ageFromPlaceholder"
                   min="0" max="120"
                   (ngModelChange)="markAsChanged()">
            <span class="age-separator">-</span>
            <input type="number" class="age-input" [(ngModel)]="campaign.maxAge"
                   [disabled]="!canEdit" [placeholder]="(i18n.terms$ | async)?.ageToPlaceholder"
                   min="0" max="120"
                   (ngModelChange)="markAsChanged()">
          </div>
        </div>

        <!-- Show All Donors Toggle - disabled when no filters are active -->
        <!-- <div class="filter-item show-all-toggle" [class.disabled]="!hasActiveFilters">
          <div class="filter-header">
            <mat-icon class="filter-icon">visibility</mat-icon>
            <span class="filter-label">{{ (i18n.terms$ | async)?.showAllDonors }}</span>
          </div>
          <div class="toggle-switch">
            <label class="switch">
              <input type="checkbox"
                     [(ngModel)]="showAllDonors"
                     [disabled]="!hasActiveFilters"
                     (ngModelChange)="loadInvitedDonors()">
              <span class="slider"></span>
            </label>
          </div>
        </div> -->
      </div>

      <!-- Display Options Section -->
      <div class="display-options-section">
        <label class="display-option-checkbox">
          <input type="checkbox" [(ngModel)]="showOnlySelected">
          <span class="checkbox-label">הצג רק מסומנים</span>
        </label>
        <label class="display-option-checkbox">
          <input type="checkbox" [(ngModel)]="showSelectedFirst">
          <span class="checkbox-label">הצג מסומנים ראשונים ברשימה</span>
        </label>
      </div>

    </div>

    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="loading && !campaign">
      <div class="loading-spinner">
        <mat-icon class="spinner">refresh</mat-icon>
        <p>{{ (i18n.terms$ | async)?.loadingData }}</p>
      </div>
    </div>

    <!-- Modal Body - Scrollable Table -->
    <div class="modal-body">
      <div class="table-container" *ngIf="campaign && !loading">
        <table class="donors-table">
          <thead>
            <tr>
              <th class="checkbox-column">
                <input type="checkbox"
                       [checked]="isAllSelected()"
                       (change)="toggleAllSelection()">
              </th>
              <th>{{ (i18n.terms$ | async)?.name }}</th>
              <th>{{ (i18n.terms$ | async)?.phone }}</th>
              <th>{{ (i18n.terms$ | async)?.email }}</th>
              <th>{{ (i18n.terms$ | async)?.level }}</th>
              <th>{{ (i18n.terms$ | async)?.city }}</th>
              <!-- <th>{{ (i18n.terms$ | async)?.actions }}</th> -->
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let donor of displayedDonors" class="donor-row">
              <td class="checkbox-column">
                <input type="checkbox"
                       [checked]="isSelected(donor.id)"
                       (change)="toggleSelection(donor.id)">
              </td>
              <td class="donor-name clickable" (click)="openDonorDetails(donor)">
                <strong>{{getDonorDisplayName(donor)}}</strong>
              </td>
              <td>{{getDonorPhone(donor)}}</td>
              <td>{{getDonorEmail(donor)}}</td>
              <td>
                <span class="level-badge">{{getDonorLevel(donor)}}</span>
              </td>
              <td>{{donor.homePlace?.city || '-'}}</td>
              <!-- <td class="actions">
                <button mat-icon-button
                        [matTooltip]="(i18n.terms$ | async)?.donorDetails"
                        [dir]="'rtl'"
                        (click)="openDonorDetails(donor)">
                  <mat-icon>info</mat-icon>
                </button>
              </td> -->
            </tr>
          </tbody>
        </table>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="displayedDonors.length === 0">
          <mat-icon>people_outline</mat-icon>
          <p>{{ (i18n.terms$ | async)?.noInviteesFound }}</p>
        </div>
      </div>
    </div>

    <!-- Modal Footer - Fixed, Non-scrolling -->
    <div class="modal-footer">
      <!-- Selection Actions -->
      <div class="selection-actions">
        <button mat-stroked-button (click)="selectAll()" [disabled]="loading || invitedDonors.length === 0">
          <mat-icon>check_box</mat-icon>
          {{ (i18n.terms$ | async)?.selectAll }}
        </button>
        <button mat-stroked-button (click)="deselectAll()" [disabled]="loading || selectedCount === 0">
          <mat-icon>check_box_outline_blank</mat-icon>
          {{ (i18n.terms$ | async)?.deselectAll }}
        </button>
      </div>

      <div class="footer-stats">
        <span class="stat-item">
          <mat-icon>people</mat-icon>
          {{ (i18n.terms$ | async)?.totalInvitees }}: {{invitedDonors.length}}
        </span>
        <span class="stat-item" *ngIf="true || selectedCount > 0">
          <mat-icon>check_circle</mat-icon>
          {{ (i18n.terms$ | async)?.selectedInvitees }}: {{selectedCount}}
        </span>
      </div>

      

      <!-- Save Filters Button -->
      <div class="filters-actions">
        <button mat-raised-button
                color="accent"
                (click)="exportToExcel()"
                [disabled]="loading || invitedDonors.length === 0">
          <mat-icon>file_download</mat-icon>
          {{ (i18n.terms$ | async)?.exportToExcel }}
        </button>
      </div>

      <div class="footer-actions">
        <button mat-raised-button color="primary" (click)="saveCampaign()" [disabled]="loading">
          <mat-icon>save</mat-icon>
          {{ (i18n.terms$ | async)?.saveInviteesButton }}
        </button>

        <!-- <button mat-raised-button
                color="primary"
                (click)="sendInvitations()"
                [disabled]="loading || invitedDonors.length === 0">
          <mat-icon>send</mat-icon>
          {{ (i18n.terms$ | async)?.sendInvitations }}
        </button> -->

        <button mat-stroked-button
                (click)="closeModal()">
          <mat-icon>close</mat-icon>
          {{ (i18n.terms$ | async)?.closeButton }}
        </button>
      </div>
    </div>
  </div>
</div>

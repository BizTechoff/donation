<!-- Donation Details Modal -->
<div class="modal-overlay">
  <div class="modal-content donation-details-modal" (click)="$event.stopPropagation()">

    <!-- Modal Header with gradient and icon -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <mat-icon>{{isNewDonation ? 'add_circle' : 'attach_money'}}</mat-icon>
        </div>
        <div class="header-text">
          <h2>{{isNewDonation ? 'רישום תרומה חדשה' : 'פרטי תרומה'}}</h2>
          <p class="header-subtitle" *ngIf="!isNewDonation && donation">
            {{getDonorDisplayName(selectedDonor)}}
          </p>
        </div>
      </div>
      <button class="modal-close" (click)="closeModal()" matTooltip="סגור" [dir]="'rtl'">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="loading">
      <div class="loading-spinner">טוען נתונים...</div>
    </div>

    <div class="modal-body">
      <div class="details-grid" *ngIf="donation && !loading">



        <!-- פרטי תורם ותשלום -->
        <div class="section donor-payment-section">
          <h3>פרטי תורם ותשלום</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">person</mat-icon>
                <label>תורם *</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.donorId" (ngModelChange)="onDonorChange($event)">
                <option value="">בחר תורם</option>
                <option *ngFor="let donor of donors" [value]="donor.id">
                  {{ getDonorDisplayName(donor) }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">campaign</mat-icon>
                <label>קמפיין</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.campaignId" (change)="onCampaignChange()">
                <option value="">ללא קמפיין</option>
                <option *ngFor="let campaign of campaigns" [value]="campaign.id">
                  {{ campaign.name }}
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- סוג תרומה -->
        <div class="section donation-type-section">
          <h3>סוג תרומה</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="donation-type-selector">
                <div class="donation-type-option" [class.active]="donation.donationType === 'full'">
                  <label class="donation-type-card">
                    <input type="radio" name="donationType" value="full" [(ngModel)]="donation.donationType"
                      class="donation-type-radio">
                    <div class="donation-type-content">
                      <mat-icon class="donation-type-icon">payments</mat-icon>
                      <div class="donation-type-text">
                        <span class="donation-type-label">תרומה מלאה</span>
                        <span class="donation-type-description">תשלום מלא ומיידי</span>
                      </div>
                    </div>
                  </label>
                </div>

                <div class="donation-type-option" [class.active]="donation.donationType === 'commitment'">
                  <label class="donation-type-card">
                    <input type="radio" name="donationType" value="commitment" [(ngModel)]="donation.donationType"
                      class="donation-type-radio">
                    <div class="donation-type-content">
                      <mat-icon class="donation-type-icon">handshake</mat-icon>
                      <div class="donation-type-text">
                        <span class="donation-type-label">התחייבות</span>
                        <span class="donation-type-description">הבטחה לתשלום בעתיד</span>
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- פרטי תרומה בסיסיים -->
        <div class="section basic-details">
          <h3>פרטי תרומה בסיסיים</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">attach_money</mat-icon>
                <label>סכום *</label>
              </div>
              <input type="number" class="form-control" [(ngModel)]="donation.amount" placeholder="הכנס סכום" min="0"
                step="0.01">
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">monetization_on</mat-icon>
                <label>מטבע</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.currency">
                <!-- מטבעות עיקריים -->
                <option value="ILS">שקל ישראלי (₪)</option>
                <option value="USD">דולר אמריקני ($)</option>
                <option value="EUR">יורו (€)</option>
                <option value="GBP">פאונד בריטי (£)</option>
                <option value="CAD">דולר קנדי (C$)</option>
                <option value="AUD">דולר אוסטרלי (A$)</option>
                <option value="CHF">פרנק שוויצרי (CHF)</option>
                <option value="JPY">ין יפני (¥)</option>

                <!-- מטבעות אירופיים -->
                <option value="SEK">כתר שוודי (SEK)</option>
                <option value="NOK">כתר נורבגי (NOK)</option>
                <option value="DKK">כתר דני (DKK)</option>
                <option value="PLN">זלוטי פולני (PLN)</option>
                <option value="HUF">פורינט הונגרי (HUF)</option>
                <option value="CZK">כתר צ'כי (CZK)</option>
                <option value="RON">לאו רומני (RON)</option>
                <option value="BGN">לב בולגרי (BGN)</option>
                <option value="HRK">קונה קרואטית (HRK)</option>
                <option value="ISK">כתר איסלנדי (ISK)</option>
                <option value="UAH">חריבניה אוקראינית (UAH)</option>
                <option value="RUB">רובל רוסי (₽)</option>
                <option value="TRY">לירה טורקית (₺)</option>

                <!-- אסיה -->
                <option value="CNY">יואן סיני (¥)</option>
                <option value="INR">רופי הודי (₹)</option>
                <option value="KRW">וון קוריאני (₩)</option>
                <option value="THB">באט תאילנדי (฿)</option>
                <option value="SGD">דולר סינגפורי (S$)</option>
                <option value="MYR">רינגיט מלזי (RM)</option>
                <option value="IDR">רופיה אינדונזית (Rp)</option>
                <option value="PHP">פזו פיליפיני (₱)</option>
                <option value="VND">דונג וייטנאמי (₫)</option>
                <option value="HKD">דולר הונג קונגי (HK$)</option>
                <option value="TWD">דולר טייוואני (NT$)</option>
                <option value="PKR">רופי פקיסטני (PKR)</option>
                <option value="BDT">טאקה בנגלדשי (৳)</option>
                <option value="LKR">רופי סרי לנקי (Rs)</option>

                <!-- אמריקה הלטינית -->
                <option value="BRL">ריאל ברזילאי (R$)</option>
                <option value="ARS">פזו ארגנטינאי (ARS)</option>
                <option value="MXN">פזו מקסיקני (MXN)</option>
                <option value="CLP">פזו צ'יליאני (CLP)</option>
                <option value="COP">פזו קולומביאני (COP)</option>
                <option value="PEN">סול פרואני (S/)</option>
                <option value="UYU">פזו אורוגוואי (UYU)</option>

                <!-- המזרח התיכון -->
                <option value="AED">דירהם איחוד האמירויות (AED)</option>
                <option value="SAR">ריאל סעודי (SAR)</option>
                <option value="JOD">דינר ירדני (JD)</option>
                <option value="EGP">פאונד מצרי (EGP)</option>
                <option value="LBP">לירה לבנונית (LBP)</option>
                <option value="BHD">דינר בחריני (BHD)</option>
                <option value="KWD">דינר כוויתי (KWD)</option>
                <option value="QAR">ריאל קטארי (QAR)</option>
                <option value="OMR">ריאל עומאני (OMR)</option>

                <!-- אפריקה -->
                <option value="ZAR">ראנד דרום אפריקני (ZAR)</option>
                <option value="NGN">נאירה ניגרית (₦)</option>
                <option value="KES">שילינג קנייתי (KSh)</option>
                <option value="ETB">ביר אתיופי (ETB)</option>
                <option value="GHS">סדי גאני (GH₵)</option>

                <!-- אוקיאניה -->
                <option value="NZD">דולר ניו זילנדי (NZ$)</option>
              </select>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">support_agent</mat-icon>
                <label>מתרים</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.fundraiserId" (change)="onFundraiserChange()">
                <option value="">בחר מתרים</option>
                <option *ngFor="let fundraiser of fundraisers" [value]="fundraiser.id">
                  {{ getFundraiserDisplayName(fundraiser) }}
                </option>
              </select>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">event</mat-icon>
                <label>תאריך תרומה *</label>
              </div>
              <app-modern-dual-date-picker [(ngModel)]="donation.donationDate" [disabled]="false" [compact]="false"
                [calendar_open_heb_and_eng_parallel]="true" (dateChange)="changed = true">
              </app-modern-dual-date-picker>
            </div>
          </div>

          <div class="form-grid">
            <!-- <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">info</mat-icon>
                <label>סטטוס תרומה *</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.status">
                <option value="pending">ממתין</option>
                <option value="completed">הושלם</option>
                <option value="cancelled">בוטל</option>
              </select>
            </div> -->

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">help</mat-icon>
                <label>סיבה</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="donation.reason" placeholder="הכנס סיבה">
            </div>
          </div>
        </div>


        <!-- אמצעי תשלום -->
        <div class="section payment-method-section" *ngIf="donation.donationType !== 'commitment'">
          <h3>אמצעי תשלום</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="payment-method-selector">
                <div class="payment-method-option" *ngFor="let method of donationMethods"
                  [class.active]="donation.donationMethodId === method.id">
                  <label class="payment-method-card">
                    <input type="radio" name="paymentMethod" [value]="method.id" [(ngModel)]="donation.donationMethodId"
                      (change)="onPaymentMethodChange()" class="payment-method-radio">
                    <div class="payment-method-content">
                      <mat-icon class="payment-method-icon">payment</mat-icon>
                      <div class="payment-method-text">
                        <span class="payment-method-label">{{ method.name }}</span>
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Details Section -->
        <div class="section payment-details-section"
          *ngIf="selectedPaymentMethod && selectedPaymentMethod.type !== 'cash'">
          <!-- Check Payment Details -->
          <div class="payment-details" *ngIf="isCheckPayment">
            <div class="payment-details-header">
              <mat-icon class="payment-icon">receipt</mat-icon>
              <h4>פרטי צ'ק</h4>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">person</mat-icon>
                  <label>שם משלם</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.payerName" placeholder="שם המשלם">
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">account_balance</mat-icon>
                  <label>מספר חשבון</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.bankAccount" placeholder="מספר חשבון">
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">tag</mat-icon>
                  <label>מספר צ'ק</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.checkNumber" placeholder="מספר צ'ק">
              </div>
            </div>
          </div>

          <!-- Bank Transfer Details -->
          <div class="payment-details" *ngIf="isTransferPayment">
            <div class="payment-details-header">
              <mat-icon class="payment-icon">account_balance</mat-icon>
              <h4>פרטי העברה בנקאית</h4>
            </div>
            <div class="form-grid">
              <!-- Bank Dropdown Selector -->
              <div class="form-group full-width">
                <div class="field-title">
                  <mat-icon class="field-icon">account_balance</mat-icon>
                  <label>בחר בנק</label>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <select class="form-control" [(ngModel)]="donation.bankId" (change)="onBankChange()" style="flex: 1;">
                    <option value="">בחר בנק</option>
                    <option *ngFor="let bank of banks" [value]="bank.id">
                      {{ bank.name }}
                    </option>
                  </select>
                  <button mat-stroked-button type="button" (click)="editBank()" class="edit-btn"
                          matTooltip="ערוך בנק"
                          [disabled]="!donation.bankId"
                          style="white-space: nowrap;">
                    <mat-icon>edit</mat-icon>
                    ערוך
                  </button>
                  <button mat-stroked-button type="button" (click)="addNewBank()" class="add-new-btn"
                          matTooltip="הוסף בנק חדש" style="white-space: nowrap;">
                    <mat-icon>add</mat-icon>
                    הוסף בנק חדש
                  </button>
                </div>
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">person</mat-icon>
                  <label>שם המעביר</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.payerName" placeholder="שם המעביר">
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">account_balance</mat-icon>
                  <label>מספר חשבון</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.bankAccount"
                       [placeholder]="selectedBank?.bankCode || 'מספר חשבון'">
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">confirmation_number</mat-icon>
                  <label>מספר אסמכתא</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.transferReference"
                  placeholder="מספר אסמכתא">
              </div>
            </div>
          </div>

          <!-- Organization Payment Details -->
          <div class="payment-details info-background" *ngIf="isOrganizationPayment">
            <div class="payment-details-header">
              <mat-icon class="payment-icon">business</mat-icon>
              <h4>פרטי עמותה</h4>
            </div>
            <div class="form-grid">
              <!-- Organization Dropdown Selector -->
              <div class="form-group full-width">
                <div class="field-title">
                  <mat-icon class="field-icon">business</mat-icon>
                  <label>בחר עמותה</label>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <select class="form-control" [(ngModel)]="donation.organizationId" (change)="onOrganizationChange()" style="flex: 1;">
                    <option value="">בחר עמותה</option>
                    <option *ngFor="let org of organizations" [value]="org.id">
                      {{ org.name }}
                    </option>
                  </select>
                  <button mat-stroked-button type="button" (click)="editOrganization()" class="edit-btn"
                          matTooltip="ערוך עמותה"
                          [disabled]="!donation.organizationId"
                          style="white-space: nowrap;">
                    <mat-icon>edit</mat-icon>
                    ערוך
                  </button>
                  <button mat-stroked-button type="button" (click)="addNewOrganization()" class="add-new-btn"
                          matTooltip="הוסף עמותה חדשה" style="white-space: nowrap;">
                    <mat-icon>add</mat-icon>
                    הוסף עמותה חדשה
                  </button>
                </div>
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">person</mat-icon>
                  <label>שם</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.payerName"
                       [placeholder]="selectedOrganization?.name || 'שם'">
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">account_balance</mat-icon>
                  <label>מס. ח"ן</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.bankAccount"
                       [placeholder]="selectedOrganization?.accountNumber || 'מספר חשבון'">
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">confirmation_number</mat-icon>
                  <label>מס. שובר</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.voucherNumber" placeholder="מספר שובר">
              </div>
            </div>
          </div>

          <!-- Credit Card Details -->
          <div class="payment-details" *ngIf="isCreditCardPayment">
            <div class="payment-details-header">
              <mat-icon class="payment-icon">credit_card</mat-icon>
              <h4>פרטי כרטיס אשראי</h4>
            </div>

            <!-- Credit Card Action Buttons -->
            <div class="form-grid" style="margin-bottom: 15px;">
              <div class="form-group full-width">
                <div style="display: flex; gap: 10px; justify-content: flex-start;">
                  <button mat-raised-button color="primary" type="button" (click)="openPaymentModal()"
                    matTooltip="ביצוע תשלום בכרטיס אשראי">
                    <mat-icon>payment</mat-icon>
                    תשלום 1
                  </button>
                  <button mat-stroked-button type="button" [disabled]="true"
                    matTooltip="הוראת קבע בכרטיס אשראי - לא זמין">
                    <mat-icon>autorenew</mat-icon>
                    הו"ק מסוג אשראי
                  </button>
                </div>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">numbers</mat-icon>
                  <label>מספר כרטיס (4 ספרות אחרונות)</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.cardNumber" maxlength="4"
                  placeholder="1234">
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">date_range</mat-icon>
                  <label>תוקף (MM/YY)</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.cardExpiry" maxlength="5"
                  placeholder="12/25">
              </div>

              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">person</mat-icon>
                  <label>שם בעל הכרטיס</label>
                </div>
                <input type="text" class="form-control" [(ngModel)]="donation.cardHolderName"
                  placeholder="ישראל ישראלי">
              </div>
            </div>
          </div>

          <!-- Standing Order Details -->
          <div class="payment-details" *ngIf="isStandingOrderPayment">
            <div class="payment-details-header">
              <mat-icon class="payment-icon">autorenew</mat-icon>
              <h4>פרטי הוראת קבע</h4>
            </div>

            <!-- Standing Order Type Selection -->
            <div class="form-grid">
              <div class="form-group full-width">
                <div class="field-title">
                  <mat-icon class="field-icon">payment</mat-icon>
                  <label>{{ (i18n.terms$ | async)?.standingOrderTypeLabel }}</label>
                </div>
                <div class="standing-order-type-selector">
                  <label class="radio-option">
                    <input type="radio" name="standingOrderType" value="bank" [(ngModel)]="donation.standingOrderType">
                    <span>{{ (i18n.terms$ | async)?.bankStandingOrder }}</span>
                  </label>
                  <label class="radio-option">
                    <input type="radio" name="standingOrderType" value="creditCard"
                      [(ngModel)]="donation.standingOrderType">
                    <span>{{ (i18n.terms$ | async)?.creditCardStandingOrder }}</span>
                  </label>
                  <label class="radio-option">
                    <input type="radio" name="standingOrderType" value="organization"
                      [(ngModel)]="donation.standingOrderType">
                    <span>{{ (i18n.terms$ | async)?.organizationStandingOrder }}</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Frequency and Payment Settings -->
            <div class="form-grid">
              <div class="form-group">
                <div class="field-title">
                  <mat-icon class="field-icon">schedule</mat-icon>
                  <label>תדירות</label>
                </div>
                <select class="form-control" [(ngModel)]="donation.frequency">
                  <option value="weekly">שבועי</option>
                  <option value="monthly">חודשי</option>
                  <option value="quarterly">רבעוני</option>
                  <option value="yearly">שנתי</option>
                </select>
              </div>

              <!-- Day selection based on frequency -->
              <div class="form-group"
                *ngIf="donation.frequency === 'monthly' || donation.frequency === 'quarterly' || donation.frequency === 'yearly'">
                <div class="field-title">
                  <mat-icon class="field-icon">today</mat-icon>
                  <label>יום בחודש</label>
                </div>
                <select class="form-control" [(ngModel)]="donation.dayOfMonth">
                  <option value="">בחר יום</option>
                  <option *ngFor="let day of getDaysOfMonth()" [value]="day">{{ day }}</option>
                </select>
              </div>

              <div class="form-group" *ngIf="donation.frequency === 'weekly'">
                <div class="field-title">
                  <mat-icon class="field-icon">calendar_view_week</mat-icon>
                  <label>יום בשבוע</label>
                </div>
                <select class="form-control" [(ngModel)]="donation.dayOfWeek">
                  <option value="">בחר יום</option>
                  <option *ngFor="let day of getDaysOfWeek()" [value]="day.value">{{ day.name }}</option>
                </select>
              </div>
            </div>

            <!-- Number of Payments Section -->
            <div class="form-grid">
              <div class="form-group full-width">
                <div class="field-title">
                  <mat-icon class="field-icon">repeat</mat-icon>
                  <label>{{ (i18n.terms$ | async)?.numberOfPaymentsLabel }}</label>
                </div>
                <div class="payment-count-selector">
                  <label class="checkbox-option">
                    <input type="checkbox" [(ngModel)]="donation.unlimitedPayments"
                      (change)="onUnlimitedPaymentsChange()">
                    <span>{{ (i18n.terms$ | async)?.unlimitedPayments }}</span>
                  </label>
                  <div class="payment-count-input" *ngIf="!donation.unlimitedPayments">
                    <input type="number" class="form-control" [(ngModel)]="donation.numberOfPayments" min="1"
                      [placeholder]="(i18n.terms$ | async)?.paymentsCount">
                  </div>
                </div>
              </div>
            </div>


            <!-- Bank Details Section -->
            <div class="bank-details-section" *ngIf="donation.standingOrderType === 'bank'">
              <h5>{{ (i18n.terms$ | async)?.bankDetailsSection }}</h5>
              <div class="form-grid">
                <!-- Bank Dropdown Selector -->
                <div class="form-group full-width">
                  <div class="field-title">
                    <mat-icon class="field-icon">account_balance</mat-icon>
                    <label>בחר בנק</label>
                  </div>
                  <div style="display: flex; gap: 10px; align-items: center;">
                    <select class="form-control" [(ngModel)]="donation.bankId" (change)="onBankChange()"
                      style="flex: 1;">
                      <option value="">בחר בנק</option>
                      <option *ngFor="let bank of banks" [value]="bank.id">
                        {{ bank.name }}
                      </option>
                    </select>
                    <button mat-stroked-button type="button" (click)="editBank()" class="edit-btn" matTooltip="ערוך בנק"
                      [disabled]="!donation.bankId" style="white-space: nowrap;">
                      <mat-icon>edit</mat-icon>
                      ערוך
                    </button>
                    <button mat-stroked-button type="button" (click)="addNewBank()" class="add-new-btn"
                      matTooltip="הוסף בנק חדש" style="white-space: nowrap;">
                      <mat-icon>add</mat-icon>
                      הוסף בנק חדש
                    </button>
                  </div>
                </div>

                <!-- Bank Fields (can be overridden) -->
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">account_balance</mat-icon>
                    <label>{{ (i18n.terms$ | async)?.bankNameLabel }}</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.bankName"
                    [placeholder]="selectedBank?.name || (i18n.terms$ | async)?.bankNameLabel">
                </div>
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">store</mat-icon>
                    <label>{{ (i18n.terms$ | async)?.bankBranchLabel }}</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.bankBranch"
                    [placeholder]="(i18n.terms$ | async)?.bankBranchLabel">
                </div>
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">account_box</mat-icon>
                    <label>{{ (i18n.terms$ | async)?.bankAccountLabel }}</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.bankAccount"
                    [placeholder]="(i18n.terms$ | async)?.bankAccountLabel">
                </div>
              </div>
            </div>

            <!-- Credit Card Details Section -->
            <div class="credit-card-details-section" *ngIf="donation.standingOrderType === 'creditCard'">
              <h5>{{ (i18n.terms$ | async)?.creditCardDetailsSection }}</h5>
              <div class="form-grid">
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">credit_card</mat-icon>
                    <label>{{ (i18n.terms$ | async)?.cardNumberLabel }}</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.cardNumber" maxlength="4"
                    pattern="[0-9]{4}" [placeholder]="(i18n.terms$ | async)?.cardNumberLabel">
                </div>
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">date_range</mat-icon>
                    <label>{{ (i18n.terms$ | async)?.cardExpiryLabel }}</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.cardExpiry" placeholder="MM/YY"
                    maxlength="5">
                </div>
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">person</mat-icon>
                    <label>{{ (i18n.terms$ | async)?.cardHolderLabel }}</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.cardHolderName"
                    [placeholder]="(i18n.terms$ | async)?.cardHolderLabel">
                </div>
              </div>
            </div>

            <!-- Organization Standing Order Details Section -->
            <div class="organization-details-section" *ngIf="donation.standingOrderType === 'organization'">
              <h5>פרטי עמותה</h5>
              <div class="form-grid">
                <!-- Organization Dropdown Selector -->
                <div class="form-group full-width">
                  <div class="field-title">
                    <mat-icon class="field-icon">business</mat-icon>
                    <label>בחר עמותה</label>
                  </div>
                  <div style="display: flex; gap: 10px; align-items: center;">
                    <select class="form-control" [(ngModel)]="donation.organizationId" (change)="onOrganizationChange()"
                      style="flex: 1;">
                      <option value="">בחר עמותה</option>
                      <option *ngFor="let org of organizations" [value]="org.id">
                        {{ org.name }}
                      </option>
                    </select>
                    <button mat-stroked-button type="button" (click)="editOrganization()" class="edit-btn"
                      matTooltip="ערוך עמותה" [disabled]="!donation.organizationId" style="white-space: nowrap;">
                      <mat-icon>edit</mat-icon>
                      ערוך
                    </button>
                    <button mat-stroked-button type="button" (click)="addNewOrganization()" class="add-new-btn"
                      matTooltip="הוסף עמותה חדשה" style="white-space: nowrap;">
                      <mat-icon>add</mat-icon>
                      הוסף עמותה חדשה
                    </button>
                  </div>
                </div>

                <!-- Organization Fields (can be overridden) -->
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">person</mat-icon>
                    <label>שם</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.payerName"
                    [placeholder]="selectedOrganization?.name || 'שם'">
                </div>
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">account_balance</mat-icon>
                    <label>מס. ח"ן</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.bankAccount" placeholder="מספר חשבון">
                </div>
                <div class="form-group">
                  <div class="field-title">
                    <mat-icon class="field-icon">confirmation_number</mat-icon>
                    <label>מס. שובר</label>
                  </div>
                  <input type="text" class="form-control" [(ngModel)]="donation.voucherNumber" placeholder="מספר שובר">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- פרטי אישור -->
        <!-- <div class="section receipt-details">
          <h3>פרטי אישור</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="receipt-status-option" [class.active]="donation.receiptIssued">
                <label class="receipt-status-card">
                  <input type="checkbox" [(ngModel)]="donation.receiptIssued" class="receipt-status-checkbox">
                  <div class="receipt-status-content">
                    <mat-icon class="receipt-status-icon">receipt_long</mat-icon>
                    <span class="receipt-status-label">התקבל אישור</span>
                  </div>
                </label>
              </div>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">confirmation_number</mat-icon>
                <label>מספר אישור</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="donation.receiptNumber"
                     placeholder="הכנס מספר אישור">
            </div>
          </div>
        </div> -->

        <!-- אפיון תרומה -->
        <div class="section donation-characterization">
          <h3>אפיון תרומה</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="donation-type-option" [class.active]="donation.isExceptional">
                <label class="donation-type-card">
                  <input type="checkbox" [(ngModel)]="donation.isExceptional" class="donation-type-checkbox">
                  <div class="donation-type-content">
                    <mat-icon class="donation-type-icon">priority_high</mat-icon>
                    <div class="donation-type-text">
                      <span class="donation-type-label">תרומה חריגה</span>
                      <span class="donation-type-description">תרומה בעלת אופי מיוחד</span>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- <div class="form-group">
              <div class="donation-type-option" [class.active]="donation.isUrgent">
                <label class="donation-type-card">
                  <input type="checkbox" [(ngModel)]="donation.isUrgent" class="donation-type-checkbox">
                  <div class="donation-type-content">
                    <mat-icon class="donation-type-icon">flash_on</mat-icon>
                    <div class="donation-type-text">
                      <span class="donation-type-label">חדר תה</span>
                      <span class="donation-type-description">דורש טיפול מיידי</span>
                    </div>
                  </div>
                </label>
              </div>
            </div> -->
          </div>
        </div>

        <!-- שותפים לתרומה -->
        <div class="section partners-section">
          <h3>שותפים לתרומה</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">group</mat-icon>
                <label>שותפים לתרומה</label>
              </div>

              <!-- Selected Partners Display -->
              <div class="partners-selected" *ngIf="selectedPartners.length > 0">
                <div class="selected-partners-list">
                  <div class="selected-partner" *ngFor="let partner of selectedPartners">
                    <span class="partner-name clickable" (click)="openPartnerDonorDetails(partner, $event)"
                      matTooltip="לחץ לפתיחת פרטי התורם" title="לחץ לפתיחת פרטי התורם">
                      {{ getPartnerDisplayName(partner) }}
                    </span>
                    <button type="button" class="remove-partner-btn" (click)="removePartner(partner)"
                      matTooltip="הסר שותף">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Add Partners Dropdown -->
              <div class="add-partner-section" style="display: flex; align-items: center; gap: 10px;">
                <div class="partners-help-text" *ngIf="selectedPartners.length === 0" style="flex: 0 0 auto;">
                  <small>לא נבחרו שותפים לתרומה זו</small>
                </div>
                <select class="form-control" (change)="onPartnerSelect($event)" value="" style="flex: 1;">
                  <option value="">בחר שותף להוספה</option>
                  <option *ngFor="let partner of getAvailablePartnersForSelection()" [value]="partner.id">
                    {{ getPartnerDisplayName(partner) }}
                  </option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- הערות -->
        <div class="section notes-section">
          <h3>הערות</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">note</mat-icon>
                <label>הערות</label>
              </div>
              <textarea class="form-control" rows="4" [(ngModel)]="donation.notes"
                placeholder="הכנס הערות..."></textarea>
            </div>

            <!-- <div class="form-group">
              <div class="anonymous-option" [class.active]="donation.isAnonymous">
                <label class="anonymous-card">
                  <input type="checkbox" [(ngModel)]="donation.isAnonymous" class="anonymous-checkbox">
                  <div class="anonymous-content">
                    <mat-icon class="anonymous-icon">visibility_off</mat-icon>
                    <span class="anonymous-label">תרומה אנונימית</span>
                  </div>
                </label>
              </div>
            </div> -->
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <div class="footer-actions-left">
        <!-- Campaign-based Actions -->
        <!-- <div class="campaign-actions" *ngIf="selectedCampaign">
          <button mat-stroked-button class="action-button campaign-contacts-btn" (click)="openCampaignContacts()"
            title="אנשי קשר ופעילים">
            <mat-icon>contacts</mat-icon>
            אנשי קשר ופעילים
          </button>
        </div> -->

        <!-- Additional Actions -->
        <button mat-stroked-button class="action-button print-letter-btn" (click)="printLetter()" title="הדפס מכתב">
          <mat-icon>print</mat-icon>
          הדפס מכתב
        </button>

        <button mat-stroked-button class="action-button add-reminder-btn" (click)="addReminder()" title="הוסף תזכורת">
          <mat-icon>alarm_add</mat-icon>
          הוסף תזכורת
        </button>

        <button mat-stroked-button class="action-button scan-btn" (click)="scanFile()" title="העלאת קובץ">
          <mat-icon>upload_file</mat-icon>
          העלאת קובץ
        </button>

        <!-- Divider -->
        <div class="footer-divider"></div>

        <!-- Admin Actions -->
        <button mat-stroked-button color="warn" *ngIf="!isNewDonation" (click)="deleteDonation()" class="action-button">
          <mat-icon>delete</mat-icon>
          מחק תרומה
        </button>
      </div>
      <div class="footer-actions-right">
        <button mat-stroked-button (click)="closeModal()" class="cancel-button">
          <mat-icon>close</mat-icon>
          ביטול
        </button>
        <button mat-raised-button color="primary" (click)="saveDonation()" class="save-button" [disabled]="loading">
          <mat-icon>save</mat-icon>
          {{isNewDonation ? 'שמור תרומה' : 'עדכן תרומה'}}
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Donation Details Modal -->
<div class="modal-overlay" (click)="closeModal($event)">
  <div class="modal-content donation-details-modal" (click)="$event.stopPropagation()">

    <!-- Modal Header with gradient and icon -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <mat-icon>{{isNewDonation ? 'add_circle' : 'attach_money'}}</mat-icon>
        </div>
        <div class="header-text">
          <h2>{{isNewDonation ? 'רישום תרומה חדשה' : 'פרטי תרומה'}}</h2>
          <p class="header-subtitle" *ngIf="!isNewDonation && donation">
            {{getDonorDisplayName(selectedDonor)}}
          </p>
        </div>
      </div>
      <button class="modal-close" (click)="closeModal()" matTooltip="סגור" [dir]="'rtl'">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="loading">
      <div class="loading-spinner">טוען נתונים...</div>
    </div>
    
    <div class="modal-body">
      <div class="details-grid" *ngIf="donation && !loading">
        <!-- סוג תרומה -->
        <div class="section donation-type-section">
          <h3>סוג תרומה</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="donation-type-selector">
                <div class="donation-type-option" [class.active]="donation.donationType === 'full'">
                  <label class="donation-type-card">
                    <input type="radio"
                           name="donationType"
                           value="full"
                           [(ngModel)]="donation.donationType"
                           class="donation-type-radio">
                    <div class="donation-type-content">
                      <mat-icon class="donation-type-icon">payments</mat-icon>
                      <div class="donation-type-text">
                        <span class="donation-type-label">תרומה מלאה</span>
                        <span class="donation-type-description">תשלום מלא ומיידי</span>
                      </div>
                    </div>
                  </label>
                </div>

                <div class="donation-type-option" [class.active]="donation.donationType === 'commitment'">
                  <label class="donation-type-card">
                    <input type="radio"
                           name="donationType"
                           value="commitment"
                           [(ngModel)]="donation.donationType"
                           class="donation-type-radio">
                    <div class="donation-type-content">
                      <mat-icon class="donation-type-icon">handshake</mat-icon>
                      <div class="donation-type-text">
                        <span class="donation-type-label">התחייבות</span>
                        <span class="donation-type-description">הבטחה לתשלום בעתיד</span>
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- פרטי תרומה בסיסיים -->
        <div class="section basic-details">
          <h3>פרטי תרומה בסיסיים</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">person</mat-icon>
                <label>תורם *</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.donorId">
                <option value="">בחר תורם</option>
                <option *ngFor="let donor of donors" [value]="donor.id">
                  {{ getDonorDisplayName(donor) }}
                </option>
              </select>
            </div>
            
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">attach_money</mat-icon>
                <label>סכום *</label>
              </div>
              <input type="number" class="form-control" [(ngModel)]="donation.amount"
                     placeholder="הכנס סכום" min="0" step="0.01">
            </div>
            
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">monetization_on</mat-icon>
                <label>מטבע</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.currency">
                <option value="ILS">שקל</option>
                <option value="USD">דולר</option>
                <option value="EUR">יורו</option>
              </select>
            </div>
            
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">event</mat-icon>
                <label>תאריך תרומה *</label>
              </div>
              <input type="date" class="form-control" [(ngModel)]="donation.donationDate">
            </div>
            
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">payment</mat-icon>
                <label>אמצעי תשלום *</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.donationMethodId" (change)="onPaymentMethodChange()">
                <option value="">בחר אמצעי תשלום</option>
                <option *ngFor="let method of donationMethods" [value]="method.id">
                  {{ method.name }}
                </option>
              </select>
            </div>

            <!-- Dynamic Payment Fields -->
            <!-- Check fields -->
            <div class="form-group" *ngIf="isCheckPayment">
              <div class="field-title">
                <mat-icon class="field-icon">account_balance</mat-icon>
                <label>שם חן</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="donation.bankName"
                     placeholder="שם חשבון">
            </div>
            <div class="form-group" *ngIf="isCheckPayment">
              <div class="field-title">
                <mat-icon class="field-icon">receipt</mat-icon>
                <label>מס' צק</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="donation.checkNumber"
                     placeholder="מספר צק">
            </div>

            <!-- Transfer fields -->
            <div class="form-group" *ngIf="isTransferPayment">
              <div class="field-title">
                <mat-icon class="field-icon">account_balance</mat-icon>
                <label>שם חן</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="donation.bankName"
                     placeholder="שם חשבון">
            </div>

            <!-- Organization fields -->
            <div class="form-group" *ngIf="isOrganizationPayment">
              <div class="field-title">
                <mat-icon class="field-icon">account_balance</mat-icon>
                <label>שם חן</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="donation.bankName"
                     placeholder="שם חשבון">
            </div>
            <div class="form-group" *ngIf="isOrganizationPayment">
              <div class="field-title">
                <mat-icon class="field-icon">confirmation_number</mat-icon>
                <label>מס' שובר</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="donation.voucherNumber"
                     placeholder="מספר שובר">
            </div>
            
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">campaign</mat-icon>
                <label>קמפיין</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.campaignId" (change)="onCampaignChange()">
                <option value="">ללא קמפיין</option>
                <option *ngFor="let campaign of campaigns" [value]="campaign.id">
                  {{ campaign.name }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">support_agent</mat-icon>
                <label>מתרים</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.fundraiserId" (change)="onFundraiserChange()">
                <option value="">בחר מתרים</option>
                <option *ngFor="let fundraiser of fundraisers" [value]="fundraiser.id">
                  {{ getFundraiserDisplayName(fundraiser) }}
                </option>
              </select>
            </div>

            <!-- Partners Section -->
            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">group</mat-icon>
                <label>שותפים לתרומה</label>
              </div>

              <!-- Selected Partners Display -->
              <div class="partners-selected" *ngIf="selectedPartners.length > 0">
                <div class="selected-partners-list">
                  <div class="selected-partner" *ngFor="let partner of selectedPartners">
                    <span class="partner-name clickable"
                          (click)="openPartnerDonorDetails(partner, $event)"
                          matTooltip="לחץ לפתיחת פרטי התורם"
                          title="לחץ לפתיחת פרטי התורם">
                      {{ getPartnerDisplayName(partner) }}
                    </span>
                    <button type="button"
                            class="remove-partner-btn"
                            (click)="removePartner(partner)"
                            matTooltip="הסר שותף">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Add Partners Dropdown -->
              <div class="add-partner-section">
                <select class="form-control" (change)="onPartnerSelect($event)" value="">
                  <option value="">בחר שותף להוספה</option>
                  <option *ngFor="let partner of getAvailablePartnersForSelection()" [value]="partner.id">
                    {{ getPartnerDisplayName(partner) }}
                  </option>
                </select>
              </div>

              <div class="partners-help-text" *ngIf="selectedPartners.length === 0">
                <small>לא נבחרו שותפים לתרומה זו</small>
              </div>
            </div>
            
            
            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">info</mat-icon>
                <label>סטטוס תרומה *</label>
              </div>
              <select class="form-control" [(ngModel)]="donation.status">
                <option value="pending">ממתין</option>
                <option value="completed">הושלם</option>
                <option value="cancelled">בוטל</option>
              </select>
            </div>

          </div>
        </div>

        <!-- פרטי אישור -->
        <div class="section receipt-details">
          <h3>פרטי אישור</h3>
          <div class="form-grid">
            <div class="form-group">
              <div class="receipt-status-option" [class.active]="donation.receiptIssued">
                <label class="receipt-status-card">
                  <input type="checkbox" [(ngModel)]="donation.receiptIssued" class="receipt-status-checkbox">
                  <div class="receipt-status-content">
                    <mat-icon class="receipt-status-icon">receipt_long</mat-icon>
                    <span class="receipt-status-label">התקבל אישור</span>
                  </div>
                </label>
              </div>
            </div>

            <div class="form-group">
              <div class="field-title">
                <mat-icon class="field-icon">confirmation_number</mat-icon>
                <label>מספר אישור</label>
              </div>
              <input type="text" class="form-control" [(ngModel)]="donation.receiptNumber"
                     placeholder="הכנס מספר אישור">
            </div>
          </div>
        </div>

        <!-- הערות -->
        <div class="section notes-section">
          <h3>הערות</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <div class="field-title">
                <mat-icon class="field-icon">note</mat-icon>
                <label>הערות</label>
              </div>
              <textarea class="form-control" rows="4" [(ngModel)]="donation.notes"
                        placeholder="הכנס הערות..."></textarea>
            </div>

            <div class="form-group">
              <div class="anonymous-option" [class.active]="donation.isAnonymous">
                <label class="anonymous-card">
                  <input type="checkbox" [(ngModel)]="donation.isAnonymous" class="anonymous-checkbox">
                  <div class="anonymous-content">
                    <mat-icon class="anonymous-icon">visibility_off</mat-icon>
                    <span class="anonymous-label">תרומה אנונימית</span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <div class="footer-actions-left">
        <!-- Campaign-based Actions -->
        <div class="campaign-actions" *ngIf="selectedCampaign">
          <button mat-stroked-button
                  class="action-button campaign-contacts-btn"
                  (click)="openCampaignContacts()"
                  title="אנשי קשר ופעילים">
            <mat-icon>contacts</mat-icon>
            אנשי קשר ופעילים
          </button>
        </div>

        <!-- Additional Actions -->
        <button mat-stroked-button
                class="action-button print-letter-btn"
                (click)="printLetter()"
                title="הדפס מכתב">
          <mat-icon>print</mat-icon>
          הדפס מכתב
        </button>

        <button mat-stroked-button
                class="action-button add-reminder-btn"
                (click)="addReminder()"
                title="הוסף תזכורת">
          <mat-icon>alarm_add</mat-icon>
          הוסף תזכורת
        </button>

        <button mat-stroked-button
                class="action-button scan-btn"
                (click)="scanFile()"
                title="סריקה">
          <mat-icon>scanner</mat-icon>
          סריקה
        </button>

        <!-- Divider -->
        <div class="footer-divider"></div>

        <!-- Admin Actions -->
        <button mat-stroked-button
                color="warn"
                *ngIf="!isNewDonation"
                (click)="deleteDonation()"
                class="action-button">
          <mat-icon>delete</mat-icon>
          מחק תרומה
        </button>
      </div>
      <div class="footer-actions-right">
        <button mat-stroked-button
                (click)="closeModal()"
                class="cancel-button">
          <mat-icon>close</mat-icon>
          ביטול
        </button>
        <button mat-raised-button
                color="primary"
                (click)="saveDonation()"
                class="save-button"
                [disabled]="loading">
          <mat-icon>save</mat-icon>
          {{isNewDonation ? 'שמור תרומה' : 'עדכן תרומה'}}
        </button>
      </div>
    </div>
  </div>
</div>
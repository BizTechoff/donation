<!-- Donor Details Modal -->
<div class="modal-overlay">
  <div class="modal-content donor-details-modal">
    <div class="modal-header">
      <h2>{{isNewDonor ? ((i18n.terms$ | async)?.addNewDonor) : ((i18n.terms$ | async)?.donorDetails)}}</h2>
      <button class="modal-close">&times;</button>
    </div>
    
    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="loading">
      <div class="loading-spinner">{{ (i18n.terms$ | async)?.loadingData }}</div>
    </div>
    
    <div class="modal-body">
      <div class="details-grid" *ngIf="donor && !loading">
        <!-- פרטים אישיים -->
        <div class="section personal-details">
          <h3>{{ (i18n.terms$ | async)?.personalDetails }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.firstName }} *</label>
              <input type="text" class="form-control" [(ngModel)]="donor.firstName" [placeholder]="(i18n.terms$ | async)?.firstName">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.lastName }} *</label>
              <input type="text" class="form-control" [(ngModel)]="donor.lastName" [placeholder]="(i18n.terms$ | async)?.lastName">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.idNumber }}</label>
              <input type="text" class="form-control" [(ngModel)]="donor.idNumber" [placeholder]="(i18n.terms$ | async)?.idNumber">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.email }}</label>
              <input type="email" class="form-control" [(ngModel)]="donor.email" [placeholder]="(i18n.terms$ | async)?.email">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.phone }}</label>
              <input type="tel" class="form-control" [(ngModel)]="donor.phone" [placeholder]="(i18n.terms$ | async)?.phone">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.address }}</label>
              <input type="text" class="form-control" [(ngModel)]="donor.address" [placeholder]="(i18n.terms$ | async)?.address">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.city }}</label>
              <input type="text" class="form-control" [(ngModel)]="donor.city" [placeholder]="(i18n.terms$ | async)?.city">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.zipCode }}</label>
              <input type="text" class="form-control" [(ngModel)]="donor.zipCode" [placeholder]="(i18n.terms$ | async)?.zipCode">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.country }}</label>
              <input type="text" class="form-control" [(ngModel)]="donor.country" [placeholder]="(i18n.terms$ | async)?.country">
            </div>
            <!-- Birth Date with Modern Hebrew-Gregorian picker -->
            <div class="form-group full-width">
              <app-modern-dual-date-picker
                [(ngModel)]="donor.birthDate"
                [label]="(i18n.terms$ | async)?.birthDate || 'תאריך לידה'"
                (dateChange)="onDateChange('birthDate', $event)">
              </app-modern-dual-date-picker>
            </div>
          </div>
        </div>

        <!-- מידע משפחתי -->
        <div class="section family-info">
          <h3>{{ (i18n.terms$ | async)?.familyInformation }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.spouseName }}</label>
              <input type="text" class="form-control" [(ngModel)]="donor.spouseName" [placeholder]="(i18n.terms$ | async)?.spouseName">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.maritalStatus }}</label>
              <select class="form-control" [(ngModel)]="donor.maritalStatus">
                <option value="">{{ (i18n.terms$ | async)?.selectOption }}</option>
                <option value="married">{{ (i18n.terms$ | async)?.married }}</option>
                <option value="single">{{ (i18n.terms$ | async)?.single }}</option>
                <option value="widowed">{{ (i18n.terms$ | async)?.widowed }}</option>
                <option value="divorced">{{ (i18n.terms$ | async)?.divorced }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.homePhone }}</label>
              <input type="tel" class="form-control" [(ngModel)]="donor.homePhone" [placeholder]="(i18n.terms$ | async)?.homePhone">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.mobilePhone }}</label>
              <input type="tel" class="form-control" [(ngModel)]="donor.mobilePhone" [placeholder]="(i18n.terms$ | async)?.mobilePhone">
            </div>
          </div>
          
          <!-- תאריכים אישיים -->
          <div class="personal-dates-section">
            <div class="section-header">
              <h4>{{ (i18n.terms$ | async)?.personalDates || 'תאריכים אישיים' }}</h4>
              <button class="mat-fab-mini" (click)="openAddDateDialog()" title="הוסף תאריך מותאם אישית">
                <span class="fab-icon">+</span>
              </button>
            </div>
            
            <div class="dates-container" [class.scrollable]="(customPersonalDates.length + 3) > 5">
              <!-- Anniversary Date -->
              <div class="form-group full-width">
                <app-modern-dual-date-picker
                  [(ngModel)]="donor.anniversaryDate"
                  [label]="(i18n.terms$ | async)?.anniversaryDate || 'תאריך נישואין'"
                  (dateChange)="onDateChange('anniversaryDate', $event)">
                </app-modern-dual-date-picker>
              </div>
              
              <!-- Father Yahrzeit -->
              <div class="form-group full-width">
                <app-modern-dual-date-picker
                  [(ngModel)]="donor.fatherYahrzeit"
                  [label]="(i18n.terms$ | async)?.fatherYahrzeit || 'יארצייט אב'"
                  (dateChange)="onDateChange('fatherYahrzeit', $event)">
                </app-modern-dual-date-picker>
              </div>
              
              <!-- Mother Yahrzeit -->
              <div class="form-group full-width">
                <app-modern-dual-date-picker
                  [(ngModel)]="donor.motherYahrzeit"
                  [label]="(i18n.terms$ | async)?.motherYahrzeit || 'יארצייט אם'"
                  (dateChange)="onDateChange('motherYahrzeit', $event)">
                </app-modern-dual-date-picker>
              </div>
              
              <!-- Donor Events displayed as date pickers -->
              <div *ngFor="let donorEvent of donorEvents; trackBy: trackDonorEventById" class="form-group full-width custom-date-item">
                <app-modern-dual-date-picker
                  [(ngModel)]="donorEvent.hebrewDate"
                  [label]="donorEvent.event?.description || 'אירוע'"
                  (dateChange)="onDonorEventDateChange(donorEvent, $event)">
                </app-modern-dual-date-picker>
                <button 
                  *ngIf="!donorEvent.event?.isRequired" 
                  class="remove-date-btn" 
                  (click)="removeDonorEvent(donorEvent)" 
                  title="הסר אירוע">
                  ×
                </button>
              </div>
              
              <!-- Custom Dates -->
              <div class="form-group full-width custom-date-item" *ngFor="let customDate of customPersonalDates; let i = index">
                <app-modern-dual-date-picker
                  [(ngModel)]="customDate.date"
                  [label]="customDate.name"
                  (dateChange)="onCustomDateChange(i, $event)">
                </app-modern-dual-date-picker>
                <button class="remove-date-btn" (click)="removeCustomDate(i)" title="הסר תאריך">
                  ×
                </button>
              </div>
            </div>
          </div>

          
          <!-- Dialog for adding event or custom date -->
          <div class="custom-date-dialog" *ngIf="showAddDateDialog">
            <div class="dialog-backdrop" (click)="closeAddDateDialog()"></div>
            <div class="dialog-content">
              <h4>הוסף אירוע או תאריך מותאם אישית</h4>
              
              <!-- Available Events Section -->
              <div class="available-events-section" *ngIf="getAvailableEvents().length > 0">
                <h5>בחר אירוע קיים:</h5>
                <div class="events-grid">
                  <div class="events-by-category" *ngFor="let category of getEventCategories()">
                    <h6 class="category-title">{{ category }}</h6>
                    <button 
                      class="event-option-btn" 
                      *ngFor="let event of getEventsByCategory(category)"
                      (click)="addEventFromDialog(event)">
                      {{ event.description }}
                    </button>
                  </div>
                </div>
                <div class="divider">או</div>
              </div>
              
              <!-- Custom Date Section -->
              <div class="custom-date-section">
                <h5>הוסף תאריך מותאם אישית:</h5>
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="newDateName" 
                  placeholder="שם האירוע (לדוגמה: יום הולדת בן)"
                  (keyup.enter)="addCustomDate()">
              </div>
              
              <div class="dialog-actions">
                <button class="btn btn-secondary" (click)="closeAddDateDialog()">ביטול</button>
                <button class="btn btn-primary" (click)="addCustomDate()" [disabled]="!newDateName.trim()">הוסף תאריך מותאם</button>
              </div>
            </div>
          </div>
        </div>

        <!-- קטגוריות ורמות -->
        <div class="section categories-levels">
          <h3>{{ (i18n.terms$ | async)?.categoriesLevels }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.level }}</label>
              <select class="form-control" [(ngModel)]="donor.level">
                <option value="">{{ (i18n.terms$ | async)?.selectOption }}</option>
                <option value="platinum">{{ (i18n.terms$ | async)?.platinum }}</option>
                <option value="gold">{{ (i18n.terms$ | async)?.gold }}</option>
                <option value="silver">{{ (i18n.terms$ | async)?.silver }}</option>
                <option value="regular">{{ (i18n.terms$ | async)?.regular }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.region }}</label>
              <select class="form-control" [(ngModel)]="donor.region">
                <option value="">{{ (i18n.terms$ | async)?.selectOption }}</option>
                <option value="center">{{ (i18n.terms$ | async)?.center }}</option>
                <option value="north">{{ (i18n.terms$ | async)?.north }}</option>
                <option value="south">{{ (i18n.terms$ | async)?.south }}</option>
                <option value="jerusalem">{{ (i18n.terms$ | async)?.jerusalem }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.circle }}</label>
              <input type="text" class="form-control" [(ngModel)]="donor.circle" [placeholder]="(i18n.terms$ | async)?.circle">
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.ageGroup }}</label>
              <select class="form-control" [(ngModel)]="donor.ageGroup">
                <option value="">{{ (i18n.terms$ | async)?.selectOption }}</option>
                <option value="18-30">18-30</option>
                <option value="31-45">31-45</option>
                <option value="46-60">46-60</option>
                <option value="60+">60+</option>
              </select>
            </div>
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.preferredLanguage }}</label>
              <select class="form-control" [(ngModel)]="donor.preferredLanguage">
                <option value="he">{{ (i18n.terms$ | async)?.hebrew }}</option>
                <option value="en">{{ (i18n.terms$ | async)?.english }}</option>
                <option value="ar">{{ (i18n.terms$ | async)?.arabic }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- העדפות יצירת קשר -->
        <div class="section contact-preferences">
          <h3>{{ (i18n.terms$ | async)?.contactPreferences }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>{{ (i18n.terms$ | async)?.receptionHours }}</label>
              <input type="text" class="form-control" [(ngModel)]="donor.receptionHours" [placeholder]="(i18n.terms$ | async)?.receptionHours">
            </div>
            <div class="form-group full-width">
              <label>{{ (i18n.terms$ | async)?.preferredDays }}</label>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.sundayAvailable">
                  {{ (i18n.terms$ | async)?.sunday }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.mondayAvailable">
                  {{ (i18n.terms$ | async)?.monday }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.tuesdayAvailable">
                  {{ (i18n.terms$ | async)?.tuesday }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.wednesdayAvailable">
                  {{ (i18n.terms$ | async)?.wednesday }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.thursdayAvailable">
                  {{ (i18n.terms$ | async)?.thursday }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.fridayAvailable">
                  {{ (i18n.terms$ | async)?.friday }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.saturdayAvailable">
                  {{ (i18n.terms$ | async)?.saturday }}
                </label>
              </div>
            </div>
            <div class="form-group full-width">
              <label>{{ (i18n.terms$ | async)?.preferredContactMethods }}</label>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.preferPhone">
                  {{ (i18n.terms$ | async)?.phoneContact }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.preferEmail">
                  {{ (i18n.terms$ | async)?.emailContact }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.preferSMS">
                  {{ (i18n.terms$ | async)?.smsContact }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.preferHomeVisit">
                  {{ (i18n.terms$ | async)?.homeVisit }}
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="donor.preferOfficeVisit">
                  {{ (i18n.terms$ | async)?.officeVisit }}
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- העדפות כלליות -->
        <div class="section preferences">
          <h3>{{ (i18n.terms$ | async)?.generalPreferences }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="donor.wantsUpdates">
                {{ (i18n.terms$ | async)?.wantsUpdates }}
              </label>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="donor.wantsTaxReceipts">
                {{ (i18n.terms$ | async)?.wantsTaxReceipts }}
              </label>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="donor.isActive">
                {{ (i18n.terms$ | async)?.active }}
              </label>
            </div>
            <div class="form-group full-width">
              <label>{{ (i18n.terms$ | async)?.generalNotes }}</label>
              <textarea class="form-control" rows="4" [(ngModel)]="donor.notes" [placeholder]="(i18n.terms$ | async)?.enterNotesPlaceholder"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary">{{ (i18n.terms$ | async)?.cancel }}</button>
      <button class="btn btn-danger" *ngIf="!isNewDonor && donor?.isActive" (click)="deactivateDonor()">{{ (i18n.terms$ | async)?.deactivate }}</button>
      <button class="btn btn-success" *ngIf="!isNewDonor && !donor?.isActive" (click)="activateDonor()">{{ (i18n.terms$ | async)?.activate }}</button>
      <button class="btn btn-danger" *ngIf="!isNewDonor" (click)="deleteDonor()">{{ (i18n.terms$ | async)?.delete }}</button>
      <button class="btn btn-primary" (click)="saveDonor()">{{ (i18n.terms$ | async)?.saveDonor }}</button>
    </div>
  </div>
</div>
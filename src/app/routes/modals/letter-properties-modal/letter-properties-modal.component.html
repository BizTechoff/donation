<!-- Letter Properties Modal -->
<div class="letter-properties-modal">

<!-- {{this.selectedLetterType?.caption}} -->
<!--
ניחום אבלים
----------------
{{ '{' }}תואר_נפטר{{ '}' }}
{{ '{' }}פרטי_נפטר{{ '}' }}
{{ '{' }}קשר_לנפטר{{ '}' }}
{{ '{' }}אב_הנפטר{{ '}' }}
{{ '{' }}סיומת_נפטר{{ '}' }}

שמחות
---------
{{ '{' }}תואר_חתן{{ '}' }}
{{ '{' }}שם_חתן{{ '}' }}
{{ '{' }}סיומת_חתן{{ '}' }}

{{ '{' }}קירבה_חתן{{ '}' }}
{{ '{' }}תואר_מחותן{{ '}' }}
{{ '{' }}שם_מחותן{{ '}' }}
{{ '{' }}סיומת_ מחותן{{ '}' }}

{{ '{' }}קירבה_אב{{ '}' }}
{{ '{' }}תואר_אב{{ '}' }}
{{ '{' }}שם_אב{{ '}' }}
{{ '{' }}סיומת_אב{{ '}' }}

{{ '{' }}קירבה_סב{{ '}' }}
{{ '{' }}סב_תואר{{ '}' }}
{{ '{' }}סב_שם{{ '}' }}
{{ '{' }}סב_סיומת{{ '}' }}
-->



  <!-- Modal Header -->
  <div class="modal-header">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>description</mat-icon>
      </div>
      <div class="header-text">
        <h2>{{ (i18n.terms$ | async)?.letterSettings }}</h2>
        <p class="header-subtitle">{{ (i18n.terms$ | async)?.selectLetterTypeSubtitle || 'בחר סוג מכתב, שורות פתיחה וסיום' }}</p>
      </div>
    </div>
    <button class="modal-close" (click)="closeModal()" matTooltip="סגור" [dir]="'rtl'">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Loading State -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="loading-spinner">מכין מכתב...</div>
  </div>

  <div class="modal-body">

    <!-- Section 1: Letter Type Selection - Hierarchical -->
    <div class="section letter-type-section">

      <!-- Step 1: Category Selection -->
      <div *ngIf="!selectedCategory">
        <h3>{{ (i18n.terms$ | async)?.selectCategoryLabel || 'בחר קטגוריה' }}</h3>
        <div class="letter-types-grid">
          <div class="letter-type-card" *ngFor="let category of categories"
            (click)="selectCategory(category)">
            <div class="card-icon">
              <mat-icon>folder</mat-icon>
            </div>
            <div class="card-content">
              <h4>{{ category.name }}</h4>
              <p>{{ category.subcategories.length }} תת-קטגוריות</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Subcategory Selection -->
      <div *ngIf="selectedCategory && !selectedSubcategory">
        <div class="breadcrumb">
          <button mat-button (click)="backToCategories()">
            <mat-icon>arrow_forward</mat-icon>
            חזור לקטגוריות
          </button>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">{{ selectedCategory.name }}</span>
        </div>
        <h3>{{ (i18n.terms$ | async)?.selectSubcategoryLabel || 'בחר תת-קטגוריה' }}</h3>
        <div class="letter-types-grid">
          <div class="letter-type-card" *ngFor="let subcategory of selectedCategory.subcategories"
            (click)="selectSubcategory(subcategory)">
            <div class="card-icon">
              <mat-icon>description</mat-icon>
            </div>
            <div class="card-content">
              <h4>{{ subcategory.name }}</h4>
              <p>{{ subcategory.letters.length }} מכתבים</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Letter Selection -->
      <div *ngIf="selectedCategory && selectedSubcategory && !selectedLetterType">
        <div class="breadcrumb">
          <button mat-button (click)="backToCategories()">
            <mat-icon>arrow_forward</mat-icon>
            חזור לקטגוריות
          </button>
          <span class="breadcrumb-separator">/</span>
          <button mat-button (click)="backToSubcategories()">
            {{ selectedCategory.name }}
          </button>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">{{ selectedSubcategory.name }}</span>
        </div>
        <h3>{{ (i18n.terms$ | async)?.selectLetterLabel || 'בחר מכתב' }}</h3>
        <div class="letter-types-grid">
          <div class="letter-type-card" *ngFor="let letter of selectedSubcategory.letters"
            (click)="selectLetterType(letter)">
            <div class="card-icon">
              <mat-icon>mail</mat-icon>
            </div>
            <div class="card-content">
              <h4>{{ letter.caption.split(' / ')[letter.caption.split(' / ').length - 1] }}</h4>
              <p>{{ letter.fields.length }} שדות</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Selected Letter Display -->
      <div *ngIf="selectedLetterType">
        <div class="breadcrumb">
          <button mat-button (click)="backToCategories()">
            <mat-icon>arrow_forward</mat-icon>
            קטגוריות
          </button>
          <span class="breadcrumb-separator">/</span>
          <button mat-button (click)="backToSubcategories()">
            {{ selectedCategory?.name }}
          </button>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">{{ selectedSubcategory?.name }}</span>
        </div>
        <div class="selected-letter-display">
          <div class="letter-type-card selected">
            <div class="card-icon">
              <mat-icon>mail</mat-icon>
            </div>
            <div class="card-content">
              <h4>{{ selectedLetterType.caption.split(' / ')[selectedLetterType.caption.split(' / ').length - 1] }}</h4>
              <p>{{ selectedLetterType.fields.length }} שדות</p>
            </div>
            <div class="card-check">
              <mat-icon>check_circle</mat-icon>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Section 2: Prefix Lines (Opening) -->
    <div class="section prefix-section" *ngIf="selectedLetterType">
      <div class="section-header">
        <h3>ברכות פתיחה למכתב</h3>
        <button mat-icon-button color="primary" (click)="openPrefixSelectionModal()" matTooltip="הוסף ברכת פתיחה">
          <mat-icon>add_circle</mat-icon>
        </button>
      </div>

      <!-- Selected Prefix Lines -->
      <div class="selected-lines" *ngIf="selectedPrefixLines.length > 0">
        <div class="selected-line" *ngFor="let line of selectedPrefixLines; let i = index" [class.pinned]="line.isPinned">
          <div class="line-order">{{ i + 1 }}</div>
          <div class="line-text">{{ line.text }}</div>
          <div class="line-actions">
            <button mat-icon-button (click)="togglePrefixPin(i)"
              [matTooltip]="line.isPinned ? 'הסר מברירת מחדל' : 'קבע כברירת מחדל למכתב זה'"
              [class.pin-active]="line.isPinned"
              *ngIf="line.id">
              <mat-icon>push_pin</mat-icon>
            </button>
            <button mat-icon-button (click)="movePrefixLineUp(i)" [disabled]="i === 0" matTooltip="הזז למעלה">
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <button mat-icon-button (click)="movePrefixLineDown(i)" [disabled]="i === selectedPrefixLines.length - 1"
              matTooltip="הזז למטה">
              <mat-icon>arrow_downward</mat-icon>
            </button>
            <button mat-icon-button (click)="removePrefixLine(i)" matTooltip="הסר" *ngIf="!line.isPinned">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="help-text" *ngIf="selectedPrefixLines.length === 0">
        <mat-icon>info</mat-icon>
        <span>לא נבחרו שורות פתיחה. המכתב יתחיל ישירות בתוכן.</span>
      </div>
    </div>

    <!-- Section 3: Letter Fields (Editable) -->
    <div class="section fields-section" *ngIf="selectedLetterType && fieldValues.length > 0">
      <h3>שדות המכתב</h3>
      <div class="fields-info">
        <mat-icon>edit</mat-icon>
        <p>השדות הבאים נטענו מנתוני התרומה. ניתן לערוך את הערכים לפני הפקת המכתב:</p>
      </div>
      <div class="fields-grid-table">
        <div class="field-row" *ngFor="let fieldValue of fieldValues">
          <div class="field-label">{{ fieldValue.displayName }}:</div>
          <div class="field-input">
            <textarea
              *ngIf="fieldValue.isMultiline"
              class="form-control field-textarea"
              [style.textAlign]="fieldValue.isEnglish ? 'left' : 'right'"
              rows="3"
              [(ngModel)]="fieldValue.value"
              (ngModelChange)="onFieldValueChange(fieldValue, $event)"
            ></textarea>
            <input
              *ngIf="!fieldValue.isMultiline"
              [style.textAlign]="fieldValue.isEnglish ? 'left' : 'right'"
              type="text"
              class="form-control field-input-text"
              [(ngModel)]="fieldValue.value"
              (ngModelChange)="onFieldValueChange(fieldValue, $event)"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Section 4: Suffix Lines (Closing) -->
    <div class="section suffix-section" *ngIf="selectedLetterType">
      <div class="section-header">
        <h3>ברכות סיום למכתב</h3>
        <button mat-icon-button color="primary" (click)="openSuffixSelectionModal()" matTooltip="הוסף ברכת סיום">
          <mat-icon>add_circle</mat-icon>
        </button>
      </div>

      <!-- Selected Suffix Lines -->
      <div class="selected-lines" *ngIf="selectedSuffixLines.length > 0">
        <div class="selected-line" *ngFor="let line of selectedSuffixLines; let i = index" [class.pinned]="line.isPinned">
          <div class="line-order">{{ i + 1 }}</div>
          <div class="line-text">{{ line.text }}</div>
          <div class="line-actions">
            <button mat-icon-button (click)="toggleSuffixPin(i)"
              [matTooltip]="line.isPinned ? 'הסר מברירת מחדל' : 'קבע כברירת מחדל לסוג מכתב זה'"
              [class.pin-active]="line.isPinned"
              *ngIf="line.id">
              <mat-icon>push_pin</mat-icon>
            </button>
            <button mat-icon-button (click)="moveSuffixLineUp(i)" [disabled]="i === 0" matTooltip="הזז למעלה">
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <button mat-icon-button (click)="moveSuffixLineDown(i)" [disabled]="i === selectedSuffixLines.length - 1"
              matTooltip="הזז למטה">
              <mat-icon>arrow_downward</mat-icon>
            </button>
            <button mat-icon-button (click)="removeSuffixLine(i)" matTooltip="הסר" *ngIf="!line.isPinned">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="help-text" *ngIf="selectedSuffixLines.length === 0">
        <mat-icon>info</mat-icon>
        <span>לא נבחרו ברכות סיום. המכתב יסתיים ללא ברכה.</span>
      </div>
    </div>

  </div>

  <!-- Modal Footer -->
  <div class="modal-footer">
    <div class="footer-actions-left"></div>
    <div class="footer-actions-right">
      <button mat-stroked-button (click)="closeModal()" class="cancel-button">
        <mat-icon>close</mat-icon>
        ביטול
      </button>
      <button mat-raised-button color="primary" (click)="generateLetter()" class="generate-button"
        [disabled]="loading || !selectedLetterType || !isAllFieldsFilled()">
        <mat-icon>print</mat-icon>
        הפק מכתב
      </button>
    </div>
</div>
<div class="modal-backdrop" (click)="closeDialog()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>תורמים שנבחרו מהמפה ({{ selectedDonors.length }})</h2>
      <button class="close-btn" (click)="closeDialog()" title="סגור">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body">
      <!-- Search and Actions Section -->
      <div class="search-section">
        <div class="search-input-group">
          <mat-icon class="search-icon">search</mat-icon>
          <input
            type="text"
            class="form-control search-input"
            [(ngModel)]="searchTerm"
            placeholder="חפש תורם...">
          <button *ngIf="searchTerm" class="clear-search-btn" (click)="clearSearch()">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
        <button class="btn btn-add-donors" (click)="addDonors()">
          <mat-icon>person_add</mat-icon>
          הוסף תורמים
        </button>
        <!-- <button class="btn btn-export" (click)="exportToExcel()">
          <mat-icon>download</mat-icon>
          ייצוא לאקסל
        </button> -->
        <button class="btn btn-save-audience" (click)="saveAsTargetAudience()">
          <mat-icon>bookmark</mat-icon>
          שמור כקהל יעד
        </button>
      </div>

      <!-- Donors List -->
      <div class="donors-list-section">
        <div class="donors-list" *ngIf="getFilteredDonors().length > 0">
          <div class="donor-item"
               *ngFor="let donorData of getFilteredDonors()">
            <div class="donor-item-content">
              <!-- Status indicator -->
              <div class="donor-status-indicator"
                   [style.background-color]="getMarkerColor(donorData.stats.statuses)"
                   [title]="getStatusLabel(donorData.stats.statuses)">
              </div>

              <div class="donor-info">
                <div class="donor-name" (click)="openDonorDetails(donorData.donor.id)">
                  {{ donorData.donor.fullName }}
                </div>

                <div class="donor-stats">
                  <span class="stat-item">
                    <mat-icon class="stat-icon">attach_money</mat-icon>
                    סה"כ: <ng-container *ngFor="let c of donorData.stats.totalDonationsByCurrency; let i = index">{{ i > 0 ? ' + ' : '' }}{{ c.symbol }}{{ c.total.toLocaleString() }}</ng-container>
                  </span>
                  <span class="stat-item">
                    <mat-icon class="stat-icon">card_giftcard</mat-icon>
                    {{ donorData.stats.donationCount }} תרומות
                  </span>
                  <span class="stat-item" *ngIf="donorData.stats.partnerDonationsCount > 0">
                    <mat-icon class="stat-icon">group</mat-icon>
                    שותף: {{ donorData.stats.partnerDonationsCount }} תרומות
                    <span class="partner-info">(סה"כ: {{ donorData.stats.partnerDonationsCurrencySymbol }}{{ donorData.stats.partnerDonationsTotal.toLocaleString() }})</span>
                  </span>
                  <span class="stat-item" *ngIf="donorData.stats.commitmentCount > 0">
                    <mat-icon class="stat-icon">assignment</mat-icon>
                    התחייבויות: {{ donorData.stats.commitmentCount }}
                    <span class="partner-info" title="שולם בפועל / סה&quot;כ התחייבות">({{ donorData.stats.commitmentCurrencySymbol }}{{ donorData.stats.commitmentPaidTotal.toLocaleString() }} / {{ donorData.stats.commitmentCurrencySymbol }}{{ donorData.stats.commitmentPledgedTotal.toLocaleString() }})</span>
                  </span>
                </div>

                <div class="donor-details" *ngIf="donorData.email || donorData.phone">
                  <span *ngIf="donorData.phone">
                    <mat-icon class="detail-icon">phone</mat-icon>
                    {{ donorData.phone }}
                  </span>
                  <span *ngIf="donorData.email" style="margin-right: 12px;">
                    <mat-icon class="detail-icon">email</mat-icon>
                    {{ donorData.email }}
                  </span>
                </div>

                <div class="donor-address" *ngIf="donorData.fullAddress">
                  <mat-icon class="location-icon">location_on</mat-icon>
                  {{ donorData.fullAddress }}
                </div>

                <div class="donor-last-donation" *ngIf="donorData.stats.lastDonationDate">
                  <mat-icon class="detail-icon">calendar_today</mat-icon>
                  תרומה אחרונה: {{ formatHebrewDate(donorData.stats.lastDonationDate) }}
                  <span *ngIf="donorData.stats.lastDonationAmount > 0 && donorData.stats.lastDonationIsStandingOrder" class="last-donation-amount" title="שולם בפועל / צפי">({{ donorData.stats.lastDonationCurrencySymbol }}{{ donorData.stats.lastDonationEffectiveAmount.toLocaleString() }} / {{ donorData.stats.lastDonationCurrencySymbol }}{{ donorData.stats.lastDonationExpectedAmount.toLocaleString() }}{{ donorData.stats.lastDonationIsPartner ? ' - שותף' : '' }})</span>
                  <span *ngIf="donorData.stats.lastDonationAmount > 0 && !donorData.stats.lastDonationIsStandingOrder" class="last-donation-amount" title="סכום">({{ donorData.stats.lastDonationCurrencySymbol }}{{ donorData.stats.lastDonationAmount.toLocaleString() }}{{ donorData.stats.lastDonationIsPartner ? ' - שותף' : '' }})</span>
                </div>
              </div>
            </div>

            <div class="donor-actions">
              <button class="btn btn-sm btn-view"
                      (click)="openDonorDetails(donorData.donor.id)"
                      [title]="(i18n.terms$ | async)?.viewDetailsButton">
                <mat-icon>visibility</mat-icon>
              </button>
              <button class="btn btn-sm btn-add-donation"
                      (click)="addDonation(donorData.donor.id)"
                      [title]="(i18n.terms$ | async)?.addDonationButton">
                <mat-icon>add_circle</mat-icon>
              </button>
              <button class="btn btn-sm btn-remove"
                      (click)="removeDonor(donorData.donor.id)"
                      [title]="(i18n.terms$ | async)?.removeFromListButton">
                <mat-icon>remove_circle</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Empty state when no donors found -->
        <div class="no-donors-found" *ngIf="getFilteredDonors().length === 0">
          <mat-icon class="empty-icon">search_off</mat-icon>
          <p *ngIf="searchTerm">לא נמצאו תורמים התואמים לחיפוש "{{ searchTerm }}"</p>
          <p *ngIf="!searchTerm">לא נבחרו תורמים</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <div class="summary-info">
        <span class="summary-item">
          <strong>סה"כ תורמים:</strong> {{ selectedDonors.length }}
        </span>
        <span class="summary-item">
          <strong>סה"כ תרומות:</strong>
          ₪{{ getTotalDonationsSum() | number }}
        </span>
      </div>
      <button class="btn btn-primary" (click)="closeDialog()">
        סגור
      </button>
    </div>
  </div>
</div>
